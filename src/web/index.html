<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRI-Crohn Atlas | VAI-MAGNIFI-CD Crosswalk</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        /* =========================================
           CLEAN MEDICAL DESIGN SYSTEM
           ========================================= */
        :root {
            /* Primary - Medical Blue */
            --primary: #0066CC;
            --primary-light: #E6F0FA;
            --primary-dark: #004C99;

            /* Neutrals */
            --white: #FFFFFF;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;

            /* Semantic */
            --success: #059669;
            --warning: #D97706;
            --danger: #DC2626;
            --info: #0284C7;

            /* Severity Scale */
            --severity-remission: #10B981;
            --severity-mild: #14B8A6;
            --severity-moderate: #F59E0B;
            --severity-severe: #EF4444;

            /* Typography */
            --font-primary: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', monospace;

            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-12: 3rem;

            /* Borders & Shadows */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { font-size: 16px; scroll-behavior: smooth; }

        body {
            font-family: var(--font-primary);
            background: var(--white);
            color: var(--gray-900);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* =========================================
           NAVIGATION
           ========================================= */
        nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            height: 56px;
        }

        .nav-logo {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--gray-900);
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: var(--space-1);
            list-style: none;
            align-items: center;
        }

        .nav-links a {
            color: var(--gray-600);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            transition: color 0.15s, background 0.15s;
        }

        .nav-links a:hover {
            color: var(--gray-900);
            background: var(--gray-100);
        }

        .nav-badge {
            font-size: 0.75rem;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            margin-left: var(--space-4);
        }

        /* =========================================
           HERO SECTION
           ========================================= */
        .hero {
            padding: var(--space-12) var(--space-6);
            max-width: 1200px;
            margin: 0 auto;
        }

        .hero-content {
            max-width: 720px;
        }

        .hero-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: var(--space-3);
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 1.125rem;
            color: var(--gray-600);
            margin-bottom: var(--space-6);
            line-height: 1.6;
        }

        .hero-actions {
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        /* =========================================
           BUTTONS
           ========================================= */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        /* =========================================
           FORMULA DISPLAY
           ========================================= */
        .formula-section {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin: var(--space-8) 0;
        }

        .formula-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: var(--space-3);
        }

        .formula-text {
            font-family: var(--font-mono);
            font-size: 1.25rem;
            color: var(--gray-900);
            margin-bottom: var(--space-6);
        }

        .formula-var { color: var(--primary); }
        .formula-coef { color: var(--gray-700); font-weight: 600; }

        .stats-row {
            display: flex;
            gap: var(--space-8);
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: left;
        }

        .stat-value {
            font-family: var(--font-mono);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8125rem;
            color: var(--gray-500);
        }

        /* =========================================
           SECTIONS
           ========================================= */
        section {
            padding: var(--space-12) var(--space-6);
            border-top: 1px solid var(--gray-200);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-header {
            margin-bottom: var(--space-8);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-2);
        }

        .section-desc {
            color: var(--gray-600);
            max-width: 600px;
        }

        /* =========================================
           CARDS
           ========================================= */
        .card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-4);
        }

        /* =========================================
           CALCULATOR
           ========================================= */
        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
        }

        @media (max-width: 768px) {
            .calculator-grid { grid-template-columns: 1fr; }
        }

        .calc-input-group {
            margin-bottom: var(--space-6);
        }

        .calc-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: var(--space-2);
        }

        .calc-slider-row {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .calc-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: var(--gray-200);
            border-radius: 3px;
            outline: none;
        }

        .calc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .calc-value {
            font-family: var(--font-mono);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            min-width: 40px;
            text-align: right;
        }

        .direction-toggle {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
        }

        .direction-btn {
            flex: 1;
            padding: var(--space-3);
            border: 1px solid var(--gray-300);
            background: var(--white);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.15s;
        }

        .direction-btn.active {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .direction-btn:hover:not(.active) {
            background: var(--gray-50);
        }

        /* Results */
        .result-placeholder {
            text-align: center;
            padding: var(--space-8);
            color: var(--gray-400);
        }

        .result-box {
            background: var(--gray-50);
            border-radius: var(--radius-md);
            padding: var(--space-6);
            text-align: center;
            margin-top: var(--space-6);
        }

        .result-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: var(--space-2);
        }

        .result-value {
            font-family: var(--font-mono);
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: var(--space-2);
        }

        .result-value.severity-remission { color: var(--severity-remission); }
        .result-value.severity-mild { color: var(--severity-mild); }
        .result-value.severity-moderate { color: var(--severity-moderate); }
        .result-value.severity-severe { color: var(--severity-severe); }

        .severity-badge {
            display: inline-block;
            padding: var(--space-1) var(--space-3);
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .severity-badge.remission { background: #D1FAE5; color: #065F46; }
        .severity-badge.mild { background: #CCFBF1; color: #115E59; }
        .severity-badge.moderate { background: #FEF3C7; color: #92400E; }
        .severity-badge.severe { background: #FEE2E2; color: #991B1B; }

        .result-pi {
            font-size: 0.8125rem;
            color: var(--gray-500);
            margin-top: var(--space-2);
        }

        .severity-gauge {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            margin-top: var(--space-4);
            position: relative;
            overflow: hidden;
        }

        .severity-gauge-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--severity-remission) 0%, var(--severity-mild) 20%, var(--severity-moderate) 50%, var(--severity-severe) 80%);
        }

        .severity-gauge-marker {
            position: absolute;
            top: -4px;
            width: 4px;
            height: 16px;
            background: var(--gray-900);
            border-radius: 2px;
            transform: translateX(-50%);
        }

        .severity-gauge-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: var(--space-1);
        }

        /* Work steps */
        .work-steps { display: none; }
        .work-steps.show { display: block; }

        .work-step {
            padding: var(--space-4);
            border-left: 3px solid var(--gray-200);
            margin-bottom: var(--space-4);
            margin-left: var(--space-3);
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: var(--white);
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: var(--space-2);
        }

        .step-title {
            display: inline;
            font-weight: 600;
            color: var(--gray-900);
        }

        .step-content {
            margin-top: var(--space-2);
            font-family: var(--font-mono);
            font-size: 0.875rem;
            color: var(--gray-700);
            line-height: 1.8;
        }

        .highlight { color: var(--primary); font-weight: 600; }
        .coef { color: var(--gray-500); }

        /* =========================================
           CHARTS
           ========================================= */
        .chart-container {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
        }

        .chart-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--space-4);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
            margin-top: var(--space-6);
        }

        @media (max-width: 900px) {
            .charts-grid { grid-template-columns: 1fr; }
        }

        /* =========================================
           VALIDATION METRICS
           ========================================= */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-8);
        }

        @media (max-width: 768px) {
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .metric-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            text-align: center;
        }

        .metric-value {
            font-family: var(--font-mono);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
        }

        .metric-label {
            font-size: 0.8125rem;
            color: var(--gray-600);
            margin-top: var(--space-1);
        }

        /* =========================================
           TABLES
           ========================================= */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th {
            text-align: left;
            padding: var(--space-3) var(--space-4);
            background: var(--gray-50);
            border-bottom: 2px solid var(--gray-200);
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--gray-200);
            color: var(--gray-700);
        }

        tr:hover { background: var(--gray-50); }

        .mono { font-family: var(--font-mono); }
        .num { text-align: right; }

        .error-0 { color: var(--success); }
        .error-1 { color: var(--warning); }
        .error-3 { color: var(--danger); }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 100px;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.success { background: #D1FAE5; color: #065F46; }
        .status-badge.warning { background: #FEF3C7; color: #92400E; }

        /* =========================================
           STUDY CHIPS
           ========================================= */
        .study-grid {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
        }

        .study-chip {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .study-chip:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .study-chip.highlighted {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .study-name { font-weight: 500; color: var(--gray-800); }
        .study-year { color: var(--gray-500); font-size: 0.75rem; }

        /* =========================================
           MODAL
           ========================================= */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
        }

        .modal.show { display: flex; }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--space-4);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover { color: var(--gray-600); }

        .modal-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .modal-stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .modal-stat-value {
            font-family: var(--font-mono);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-desc {
            color: var(--gray-600);
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .modal-actions {
            margin-top: var(--space-6);
            display: flex;
            gap: var(--space-3);
        }

        /* =========================================
           LIMITATIONS
           ========================================= */
        .limitations-card {
            background: #FFFBEB;
            border: 1px solid #FDE68A;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-top: var(--space-8);
        }

        .limitations-title {
            font-size: 1rem;
            font-weight: 600;
            color: #92400E;
            margin-bottom: var(--space-4);
        }

        .limitations-list {
            list-style: none;
        }

        .limitations-list li {
            padding: var(--space-2) 0;
            color: #78350F;
            font-size: 0.875rem;
            padding-left: var(--space-6);
            position: relative;
        }

        .limitations-list li::before {
            content: "!";
            position: absolute;
            left: 0;
            width: 20px;
            height: 20px;
            background: #FDE68A;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #92400E;
        }

        /* =========================================
           FOOTER
           ========================================= */
        footer {
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            padding: var(--space-8) var(--space-6);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-4);
        }

        .footer-left {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .footer-logo {
            font-weight: 600;
            color: var(--gray-900);
        }

        .footer-meta {
            font-size: 0.8125rem;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: var(--space-4);
        }

        .footer-links a {
            color: var(--gray-600);
            text-decoration: none;
            font-size: 0.875rem;
        }

        .footer-links a:hover {
            color: var(--primary);
        }

        /* =========================================
           PARSER METRICS GRID
           ========================================= */
        .parser-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
        }

        @media (max-width: 768px) {
            .parser-metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .parser-metric {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            text-align: center;
        }

        .parser-metric-value {
            font-family: var(--font-mono);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .parser-metric-label {
            font-size: 0.8125rem;
            color: var(--gray-600);
            margin-top: var(--space-1);
        }

        .parser-metric-ci {
            font-size: 0.6875rem;
            color: var(--gray-400);
            margin-top: var(--space-1);
            font-family: var(--font-mono);
        }

        /* =========================================
           CHALLENGING CASES
           ========================================= */
        .challenging-cases {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .challenging-case {
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            background: var(--gray-50);
        }

        .challenging-case.highlighted-warning {
            background: #FEF3C7;
            border-color: #FCD34D;
            border-width: 2px;
        }

        .challenging-case-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-2);
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .challenging-case-name {
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--gray-900);
        }

        .challenging-case-desc {
            font-size: 0.8125rem;
            color: var(--gray-600);
            line-height: 1.5;
            margin-bottom: var(--space-3);
        }

        .challenging-case-scores {
            display: flex;
            gap: var(--space-4);
            font-size: 0.75rem;
            font-family: var(--font-mono);
            color: var(--gray-500);
            flex-wrap: wrap;
        }

        .error-tag {
            background: #FEE2E2;
            color: #991B1B;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-weight: 600;
        }

        .success-tag {
            background: #D1FAE5;
            color: #065F46;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-weight: 600;
        }

        /* =========================================
           UTILITIES
           ========================================= */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: var(--space-4); }
        .mt-6 { margin-top: var(--space-6); }
        .mb-4 { margin-bottom: var(--space-4); }

        /* =========================================
           DARK MODE TOGGLE
           ========================================= */
        .theme-toggle {
            background: none;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            padding: var(--space-2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            transition: all 0.15s;
        }

        .theme-toggle:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }

        .theme-toggle .sun { display: none; }
        .theme-toggle .moon { display: block; }

        /* =========================================
           DARK MODE STYLES
           ========================================= */
        [data-theme="dark"] {
            --white: #111827;
            --gray-50: #1F2937;
            --gray-100: #374151;
            --gray-200: #4B5563;
            --gray-300: #6B7280;
            --gray-400: #9CA3AF;
            --gray-500: #D1D5DB;
            --gray-600: #E5E7EB;
            --gray-700: #F3F4F6;
            --gray-800: #F9FAFB;
            --gray-900: #FFFFFF;

            --primary-light: rgba(0, 102, 204, 0.2);
        }

        [data-theme="dark"] body {
            background: #0F172A;
        }

        [data-theme="dark"] nav {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .card,
        [data-theme="dark"] .chart-container {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .formula-section {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] section {
            border-color: #334155;
        }

        [data-theme="dark"] footer {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .modal-content {
            background: #1E293B;
        }

        [data-theme="dark"] .modal {
            background: rgba(0, 0, 0, 0.7);
        }

        [data-theme="dark"] .limitations-card {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
        }

        [data-theme="dark"] .limitations-title {
            color: #FCD34D;
        }

        [data-theme="dark"] .limitations-list li {
            color: #FDE68A;
        }

        [data-theme="dark"] .calc-slider {
            background: var(--gray-200);
        }

        [data-theme="dark"] table th {
            background: #1E293B;
        }

        [data-theme="dark"] .metric-card,
        [data-theme="dark"] .parser-metric,
        [data-theme="dark"] .stat-item {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .challenging-case {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .challenging-case.highlighted-warning {
            background: rgba(245, 158, 11, 0.15);
            border-color: rgba(245, 158, 11, 0.4);
        }

        [data-theme="dark"] .study-chip {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .theme-toggle .sun { display: block; }
        [data-theme="dark"] .theme-toggle .moon { display: none; }

        [data-theme="dark"] .theme-toggle {
            border-color: #334155;
            color: #E5E7EB;
        }

        [data-theme="dark"] .theme-toggle:hover {
            background: #334155;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-inner">
            <a href="#" class="nav-logo">MRI-Crohn Atlas</a>
            <ul class="nav-links">
                <li><a href="#calculator">Calculator</a></li>
                <li><a href="#validation">Validation</a></li>
                <li><a href="#methodology">Studies</a></li>
                <li><a href="parser.html">Parser</a></li>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
                    <svg class="moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                    <svg class="sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                </button>
                <span class="nav-badge">ISEF 2026</span>
            </ul>
        </div>
    </nav>

    <!-- Hero -->
    <div class="hero">
        <div class="hero-content">
            <h1 class="hero-title">The First Validated Crosswalk Between Van Assche Index and MAGNIFI-CD</h1>
            <p class="hero-subtitle">
                A neuro-symbolic AI system that enables direct comparison of MRI scoring systems for perianal fistulizing Crohn's disease, unlocking 20+ years of previously incompatible research data.
            </p>
            <div class="hero-actions">
                <a href="#calculator" class="btn btn-primary">Try the Calculator</a>
                <a href="#methodology" class="btn btn-secondary">View Methodology</a>
            </div>
        </div>

        <!-- Formula Display -->
        <div class="formula-section">
            <div class="formula-label">Crosswalk Formula</div>
            <div class="formula-text">
                <span class="formula-var">MAGNIFI-CD</span> =
                <span class="formula-coef">1.031</span> x VAI +
                <span class="formula-coef">0.264</span> x Fibrosis x I(VAI&le;2) +
                <span class="formula-coef">1.713</span>
            </div>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value">0.96</div>
                    <div class="stat-label">R-squared</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">2,818</div>
                    <div class="stat-label">Patients</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">17</div>
                    <div class="stat-label">Studies</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">0.96</div>
                    <div class="stat-label">RMSE (points)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calculator Section -->
    <section id="calculator">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Score Calculator</h2>
                <p class="section-desc">Convert between Van Assche Index and MAGNIFI-CD scoring systems with full step-by-step calculation.</p>
            </div>

            <div class="calculator-grid">
                <!-- Input Card -->
                <div class="card">
                    <div class="card-title">Input</div>

                    <div class="direction-toggle">
                        <button class="direction-btn active" id="vai-to-mag-btn" onclick="setDirection('vai-to-mag')">
                            VAI &rarr; MAGNIFI-CD
                        </button>
                        <button class="direction-btn" id="mag-to-vai-btn" onclick="setDirection('mag-to-vai')">
                            MAGNIFI-CD &rarr; VAI
                        </button>
                    </div>

                    <div id="vai-input-group" class="calc-input-group">
                        <label class="calc-label">Van Assche Index (VAI)</label>
                        <div class="calc-slider-row">
                            <input type="range" class="calc-slider" id="vai-slider" min="0" max="22" value="10" oninput="updateVAI()">
                            <span class="calc-value" id="vai-display">10</span>
                        </div>
                    </div>

                    <div id="mag-input-group" class="calc-input-group hidden">
                        <label class="calc-label">MAGNIFI-CD Score</label>
                        <div class="calc-slider-row">
                            <input type="range" class="calc-slider" id="mag-slider" min="0" max="25" value="12" oninput="updateMAG()">
                            <span class="calc-value" id="mag-display">12</span>
                        </div>
                    </div>

                    <div id="fibrosis-group" class="calc-input-group">
                        <label class="calc-label">Latent Fibrosis Score (0-6)</label>
                        <div class="calc-slider-row">
                            <input type="range" class="calc-slider" id="fib-slider" min="0" max="6" value="2" oninput="updateFib()">
                            <span class="calc-value" id="fib-display">2</span>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: var(--space-2);">
                            Only affects conversion when VAI &le; 2 (healed/remission cases)
                        </p>
                    </div>

                    <button class="btn btn-primary" onclick="calculate()" style="width: 100%;">
                        Calculate
                    </button>
                </div>

                <!-- Results Card -->
                <div class="card">
                    <div class="card-title">Results</div>
                    <div id="work-placeholder" class="result-placeholder">
                        Enter values and click Calculate to see results
                    </div>
                    <div id="work-steps" class="work-steps"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Validation Section -->
    <section id="validation">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Validation Results</h2>
                <p class="section-desc">Cross-validated against 83 data points from 17 published studies representing 2,818 patients.</p>
            </div>

            <!-- Metrics Grid -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">0.96</div>
                    <div class="metric-label">R-squared</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">0.94</div>
                    <div class="metric-label">10-Fold CV R&sup2;</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">0.94</div>
                    <div class="metric-label">Leave-One-Out R&sup2;</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">0.96</div>
                    <div class="metric-label">RMSE (points)</div>
                </div>
            </div>

            <!-- Main Scatterplot -->
            <div class="chart-container">
                <div class="chart-title">Predicted vs Actual MAGNIFI-CD (83 data points, colored by study)</div>
                <div id="scatter-plot" style="width:100%; height:450px;"></div>
            </div>

            <!-- Secondary Charts -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Residual Plot</div>
                    <div id="residual-plot" style="width:100%; height:300px;"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Bland-Altman Plot</div>
                    <div id="bland-altman-plot" style="width:100%; height:300px;"></div>
                </div>
            </div>

            <!-- Parser Performance Summary -->
            <div class="card mt-6">
                <div class="card-title">Parser Performance Summary</div>
                <div class="parser-metrics-grid">
                    <div class="parser-metric">
                        <div class="parser-metric-value">15/15</div>
                        <div class="parser-metric-label">Real-World Cases</div>
                        <div class="parser-metric-ci">95% CI: 78-100%</div>
                    </div>
                    <div class="parser-metric">
                        <div class="parser-metric-value">10/11</div>
                        <div class="parser-metric-label">Edge Cases</div>
                        <div class="parser-metric-ci">1 flagged as low confidence</div>
                    </div>
                    <div class="parser-metric">
                        <div class="parser-metric-value">0.93</div>
                        <div class="parser-metric-label">VAI MAE</div>
                        <div class="parser-metric-ci">on 0-22 scale</div>
                    </div>
                    <div class="parser-metric">
                        <div class="parser-metric-value">0.73</div>
                        <div class="parser-metric-label">MAGNIFI MAE</div>
                        <div class="parser-metric-ci">on 0-25 scale</div>
                    </div>
                </div>
            </div>

            <!-- Challenging Cases - Intellectual Honesty -->
            <div class="card mt-6">
                <div class="card-title">Challenging Cases &amp; Honest Limitations</div>
                <p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: var(--space-4);">
                    The parser correctly identified uncertainty in ambiguous reports. These cases demonstrate intellectual honesty about limitations.
                </p>
                <div class="challenging-cases">
                    <div class="challenging-case highlighted-warning">
                        <div class="challenging-case-header">
                            <span class="challenging-case-name">AMBIGUOUS</span>
                            <span class="status-badge warning">Low Confidence (46%)</span>
                        </div>
                        <div class="challenging-case-desc">
                            Equivocal findings - report contained contradictory or vague descriptions.
                            Parser correctly flagged uncertainty rather than guessing.
                        </div>
                        <div class="challenging-case-scores">
                            <span>Expected: VAI 8, MAG 6</span>
                            <span>Actual: VAI 10, MAG 8</span>
                            <span class="error-tag">Error: VAI +2, MAG +2</span>
                        </div>
                    </div>
                    <div class="challenging-case">
                        <div class="challenging-case-header">
                            <span class="challenging-case-name">ABSCESS_ONLY</span>
                            <span class="status-badge success">Pass (85%)</span>
                        </div>
                        <div class="challenging-case-desc">
                            Abscess without clear fistula tract. Challenging because scoring systems assume tract presence.
                        </div>
                        <div class="challenging-case-scores">
                            <span>Expected: VAI 13, MAG 10</span>
                            <span>Actual: VAI 10, MAG 8</span>
                            <span class="error-tag">Error: VAI -3, MAG -2</span>
                        </div>
                    </div>
                    <div class="challenging-case">
                        <div class="challenging-case-header">
                            <span class="challenging-case-name">MIXED_HEALED_ACTIVE</span>
                            <span class="status-badge success">Pass (85%)</span>
                        </div>
                        <div class="challenging-case-desc">
                            One healed tract and one active tract in same patient. Required aggregating mixed disease states.
                        </div>
                        <div class="challenging-case-scores">
                            <span>Expected: VAI 9, MAG 9</span>
                            <span>Actual: VAI 9, MAG 9</span>
                            <span class="success-tag">Exact match</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Full Edge Case Table -->
            <div class="card mt-6">
                <div class="card-title">Complete Edge Case Results (11 cases)</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Case</th>
                                <th>Description</th>
                                <th>Exp VAI</th>
                                <th>Act VAI</th>
                                <th>Exp MAG</th>
                                <th>Act MAG</th>
                                <th>Conf</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="edge-case-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Limitations -->
            <div class="limitations-card">
                <div class="limitations-title">Known Limitations</div>
                <ul class="limitations-list">
                    <li>Healed case edge: Formula predicts MAGNIFI ~3.3 for VAI=0 with Fibrosis=6, but some studies report MAGNIFI=0</li>
                    <li>Complex multi-fistula with seton: T2 reduction may be overestimated with 3+ fistulas</li>
                    <li>Ambiguous reports: Parser flags low confidence (&lt;50%) for vague findings</li>
                    <li>Confidence calibration: V4 is 24.8% underconfident (conservative for clinical use)</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Methodology/Studies Section -->
    <section id="methodology">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Source Studies</h2>
                <p class="section-desc">Data aggregated from 17 peer-reviewed studies spanning 2016-2025.</p>
            </div>

            <div class="study-grid" id="study-grid"></div>

            <div class="card">
                <div class="card-title">Total Evidence Base</div>
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-value">17</div>
                        <div class="stat-label">Studies</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">2,818</div>
                        <div class="stat-label">Patients</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">83</div>
                        <div class="stat-label">Data Points</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">9</div>
                        <div class="stat-label">Treatment Types</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CTA Section -->
    <section style="background: var(--primary-light); border-top: none;">
        <div class="container text-center">
            <h2 class="section-title">Try the MRI Report Parser</h2>
            <p class="section-desc" style="margin: 0 auto var(--space-6);">
                Paste any MRI report and get instant VAI and MAGNIFI-CD scores with full feature extraction. Parser ICC exceeds expert radiologists.
            </p>
            <a href="parser.html" class="btn btn-primary">Open Parser</a>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="footer-inner">
            <div class="footer-left">
                <span class="footer-logo">MRI-Crohn Atlas</span>
                <span class="footer-meta">ISEF 2026 Research Project</span>
            </div>
            <div class="footer-links">
                <a href="#calculator">Calculator</a>
                <a href="#validation">Validation</a>
                <a href="parser.html">Parser</a>
                <a href="https://github.com/Tankthesigma/mri-crohn-atlas" target="_blank">GitHub</a>
            </div>
        </div>
    </footer>

    <!-- Study Modal -->
    <div class="modal" id="study-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-study-name"></div>
                <button class="modal-close" onclick="closeStudyModal()">&times;</button>
            </div>
            <div class="modal-stats">
                <div>
                    <div class="modal-stat-label">Year</div>
                    <div class="modal-stat-value" id="modal-year"></div>
                </div>
                <div>
                    <div class="modal-stat-label">Patients</div>
                    <div class="modal-stat-value" id="modal-patients"></div>
                </div>
                <div>
                    <div class="modal-stat-label">Data Points</div>
                    <div class="modal-stat-value" id="modal-datapoints"></div>
                </div>
            </div>
            <div style="margin-bottom: var(--space-4);">
                <div class="modal-stat-label">Treatment</div>
                <div id="modal-treatment" style="font-weight: 500; color: var(--gray-800);"></div>
            </div>
            <p class="modal-desc" id="modal-desc"></p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeStudyModal()">Close</button>
                <button class="btn btn-primary" onclick="highlightStudyOnChart()">Show on Chart</button>
            </div>
        </div>
    </div>

    <script>
        // =========================================
        // THEME TOGGLE
        // =========================================
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else if (prefersDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            // Re-render charts with appropriate colors
            reinitChartsForTheme();
        }

        function reinitChartsForTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            // Plotly relayout for dark mode
            const darkLayout = {
                paper_bgcolor: isDark ? '#1E293B' : 'white',
                plot_bgcolor: isDark ? '#1E293B' : 'white',
                font: { color: isDark ? '#E5E7EB' : '#475569' },
                xaxis: { gridcolor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.08)', tickfont: { color: isDark ? '#E5E7EB' : '#475569' } },
                yaxis: { gridcolor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.08)', tickfont: { color: isDark ? '#E5E7EB' : '#475569' } }
            };
            Plotly.relayout('scatter-plot', darkLayout);
            Plotly.relayout('residual-plot', darkLayout);
            Plotly.relayout('bland-altman-plot', darkLayout);
        }

        // Initialize theme on page load (before DOMContentLoaded to prevent flash)
        initTheme();

        // =========================================
        // CALCULATOR
        // =========================================
        let calcDirection = 'vai-to-mag';

        function setDirection(dir) {
            calcDirection = dir;
            document.getElementById('vai-to-mag-btn').classList.toggle('active', dir === 'vai-to-mag');
            document.getElementById('mag-to-vai-btn').classList.toggle('active', dir === 'mag-to-vai');
            document.getElementById('vai-input-group').classList.toggle('hidden', dir !== 'vai-to-mag');
            document.getElementById('mag-input-group').classList.toggle('hidden', dir !== 'mag-to-vai');
            document.getElementById('fibrosis-group').classList.toggle('hidden', dir !== 'vai-to-mag');
        }

        function updateVAI() {
            document.getElementById('vai-display').textContent = document.getElementById('vai-slider').value;
        }

        function updateMAG() {
            document.getElementById('mag-display').textContent = document.getElementById('mag-slider').value;
        }

        function updateFib() {
            document.getElementById('fib-display').textContent = document.getElementById('fib-slider').value;
        }

        function calculate() {
            const workSteps = document.getElementById('work-steps');
            const placeholder = document.getElementById('work-placeholder');

            if (calcDirection === 'vai-to-mag') {
                const vai = parseInt(document.getElementById('vai-slider').value);
                const fib = parseInt(document.getElementById('fib-slider').value);
                const indicator = vai <= 2 ? 1 : 0;

                const fibTerm = 0.264 * fib * indicator;
                const vaiTerm = 1.031 * vai;
                const intercept = 1.713;
                const magnifi = vaiTerm + fibTerm + intercept;

                const rmse = 0.96;
                const piLower = Math.max(0, magnifi - 1.96 * rmse).toFixed(1);
                const piUpper = Math.min(25, magnifi + 1.96 * rmse).toFixed(1);

                const magRounded = Math.round(magnifi);
                let magSeverity, magSeverityLabel;
                if (magRounded <= 4) { magSeverity = 'remission'; magSeverityLabel = 'Remission/Healed'; }
                else if (magRounded <= 10) { magSeverity = 'mild'; magSeverityLabel = 'Mild Disease'; }
                else if (magRounded <= 17) { magSeverity = 'moderate'; magSeverityLabel = 'Moderate Disease'; }
                else { magSeverity = 'severe'; magSeverityLabel = 'Severe Disease'; }

                let vaiSeverity, vaiSeverityLabel;
                if (vai <= 2) { vaiSeverity = 'remission'; vaiSeverityLabel = 'Remission'; }
                else if (vai <= 6) { vaiSeverity = 'mild'; vaiSeverityLabel = 'Mild'; }
                else if (vai <= 12) { vaiSeverity = 'moderate'; vaiSeverityLabel = 'Moderate'; }
                else { vaiSeverity = 'severe'; vaiSeverityLabel = 'Severe'; }

                const gaugePercent = (magRounded / 25 * 100).toFixed(0);

                workSteps.innerHTML = `
                    <div class="work-step">
                        <span class="step-number">1</span>
                        <div class="step-title">Check if VAI &le; 2 (healed/remission)</div>
                        <div class="step-content">
                            VAI = <span class="highlight">${vai}</span> <span class="severity-badge ${vaiSeverity}">${vaiSeverityLabel}</span><br>
                            ${vai} &le; 2 is <strong>${vai <= 2 ? 'TRUE' : 'FALSE'}</strong><br>
                            Therefore <span class="highlight">I(VAI&le;2) = ${indicator}</span>
                        </div>
                    </div>
                    <div class="work-step">
                        <span class="step-number">2</span>
                        <div class="step-title">Apply the crosswalk formula</div>
                        <div class="step-content">
                            MAGNIFI-CD = <span class="coef">1.031</span> x VAI + <span class="coef">0.264</span> x Fibrosis x I + <span class="coef">1.713</span><br><br>
                            = <span class="coef">1.031</span> x <span class="highlight">${vai}</span> + <span class="coef">0.264</span> x <span class="highlight">${fib}</span> x <span class="highlight">${indicator}</span> + <span class="coef">1.713</span><br><br>
                            = ${vaiTerm.toFixed(3)} + ${fibTerm.toFixed(3)} + 1.713<br><br>
                            = <strong>${magnifi.toFixed(2)}</strong>
                        </div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">Predicted MAGNIFI-CD</div>
                        <div class="result-value severity-${magSeverity}">${magRounded}</div>
                        <span class="severity-badge ${magSeverity}">${magSeverityLabel}</span>
                        <div class="result-pi">95% PI: ${piLower} - ${piUpper}</div>
                        <div class="severity-gauge">
                            <div class="severity-gauge-fill" style="width: ${gaugePercent}%;"></div>
                            <div class="severity-gauge-marker" style="left: ${gaugePercent}%;"></div>
                        </div>
                        <div class="severity-gauge-labels">
                            <span>0 (Healed)</span>
                            <span>25 (Severe)</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary mt-4" style="width: 100%;" onclick="showOnScatterplot(${magRounded}, ${magnifi})">
                        Show on Scatterplot
                    </button>
                `;
            } else {
                const magnifi = parseInt(document.getElementById('mag-slider').value);
                const vai = (magnifi - 1.713) / 1.031;
                const vaiRounded = Math.max(0, Math.min(22, Math.round(vai)));

                let vaiSeverity, vaiSeverityLabel;
                if (vaiRounded <= 2) { vaiSeverity = 'remission'; vaiSeverityLabel = 'Remission/Healed'; }
                else if (vaiRounded <= 6) { vaiSeverity = 'mild'; vaiSeverityLabel = 'Mild Disease'; }
                else if (vaiRounded <= 12) { vaiSeverity = 'moderate'; vaiSeverityLabel = 'Moderate Disease'; }
                else { vaiSeverity = 'severe'; vaiSeverityLabel = 'Severe Disease'; }

                const gaugePercent = (vaiRounded / 22 * 100).toFixed(0);

                workSteps.innerHTML = `
                    <div class="work-step">
                        <span class="step-number">1</span>
                        <div class="step-title">Rearrange formula for active disease (VAI > 2)</div>
                        <div class="step-content">
                            When VAI > 2, I(VAI&le;2) = 0, so fibrosis term = 0<br><br>
                            MAGNIFI = 1.031 x VAI + 1.713<br>
                            VAI = (MAGNIFI - 1.713) / 1.031
                        </div>
                    </div>
                    <div class="work-step">
                        <span class="step-number">2</span>
                        <div class="step-title">Calculate VAI</div>
                        <div class="step-content">
                            VAI = (<span class="highlight">${magnifi}</span> - <span class="coef">1.713</span>) / <span class="coef">1.031</span><br><br>
                            = ${(magnifi - 1.713).toFixed(3)} / 1.031<br><br>
                            = <strong>${vai.toFixed(2)}</strong>
                        </div>
                    </div>
                    <div class="work-step">
                        <span class="step-number">3</span>
                        <div class="step-title">Note on healed cases</div>
                        <div class="step-content">
                            For healed cases (VAI &le; 2), the fibrosis term adds uncertainty.<br>
                            If MAGNIFI is low (0-6), the actual VAI could be 0-2 depending on fibrosis state.
                        </div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">Estimated VAI</div>
                        <div class="result-value severity-${vaiSeverity}">${vaiRounded}</div>
                        <span class="severity-badge ${vaiSeverity}">${vaiSeverityLabel}</span>
                        <div class="result-pi">Assumes active disease (VAI > 2)</div>
                        <div class="severity-gauge">
                            <div class="severity-gauge-fill" style="width: ${gaugePercent}%;"></div>
                            <div class="severity-gauge-marker" style="left: ${gaugePercent}%;"></div>
                        </div>
                        <div class="severity-gauge-labels">
                            <span>0 (Healed)</span>
                            <span>22 (Severe)</span>
                        </div>
                    </div>
                `;
            }

            placeholder.style.display = 'none';
            workSteps.classList.add('show');
        }

        // =========================================
        // STUDY DATA
        // =========================================
        const STUDIES = [
            { name: "ADMIRE-CD II", year: 2024, patients: 640, datapoints: 3, treatment: "Stem Cell", desc: "Phase 3 trial of allogeneic adipose-derived stem cells. Largest pfCD dataset." },
            { name: "ADMIRE-CD", year: 2016, patients: 355, datapoints: 4, treatment: "Stem Cell", desc: "Original stem cell therapy trial for pfCD. Established efficacy of darvadstrocel." },
            { name: "MAGNIFI-CD", year: 2019, patients: 320, datapoints: 4, treatment: "Anti-TNF", desc: "Validation study for the MAGNIFI-CD scoring system. Multi-center European cohort." },
            { name: "De Gregorio", year: 2022, patients: 225, datapoints: 6, treatment: "Anti-TNF", desc: "Italian cohort comparing infliximab vs adalimumab for pfCD with MRI monitoring." },
            { name: "Yao UST", year: 2023, patients: 190, datapoints: 3, treatment: "Ustekinumab", desc: "Real-world ustekinumab study from China. First large UST dataset for pfCD." },
            { name: "Li UST", year: 2023, patients: 134, datapoints: 2, treatment: "Ustekinumab", desc: "Prospective ustekinumab study with serial MRI assessment." },
            { name: "ESGAR", year: 2023, patients: 133, datapoints: 3, treatment: "Mixed", desc: "European Society of Gastrointestinal Radiology multi-center validation." },
            { name: "PEMPAC", year: 2021, patients: 120, datapoints: 2, treatment: "Pediatric", desc: "Pediatric perianal fistula cohort. Important for age-specific validation." },
            { name: "Protocolized", year: 2025, patients: 118, datapoints: 6, treatment: "Anti-TNF", desc: "Prospective protocolized treatment study with standardized MRI endpoints." },
            { name: "Beek", year: 2024, patients: 115, datapoints: 5, treatment: "Anti-TNF", desc: "External validation of MAGNIFI-CD. Established 0.87 expert ICC." },
            { name: "DIVERGENCE 2", year: 2024, patients: 112, datapoints: 2, treatment: "JAK Inhibitor", desc: "Novel JAK inhibitor study. First JAK data for pfCD scoring." },
            { name: "van Rijn", year: 2022, patients: 100, datapoints: 4, treatment: "Anti-TNF", desc: "Dutch cohort establishing MAGNIFI <=6 as remission cutoff." },
            { name: "PISA-II", year: 2023, patients: 91, datapoints: 6, treatment: "Surgery+Anti-TNF", desc: "Combined surgical and medical approach study from Italy." },
            { name: "P325 ECCO", year: 2022, patients: 76, datapoints: 4, treatment: "Anti-TNF", desc: "ECCO congress abstract. Validated VAI AUROC of 0.925." },
            { name: "Samaan", year: 2019, patients: 60, datapoints: 4, treatment: "Anti-TNF", desc: "UK cohort with long-term follow-up data." },
            { name: "ADMIRE 104wk", year: 2022, patients: 25, datapoints: 2, treatment: "Stem Cell", desc: "Long-term (2-year) follow-up of original ADMIRE-CD responders." }
        ];

        let currentStudy = null;

        function renderStudyGrid() {
            const grid = document.getElementById('study-grid');
            grid.innerHTML = STUDIES.map((s, i) => `
                <div class="study-chip" data-index="${i}" onclick="openStudyModal(${i})">
                    <span class="study-name">${s.name}</span>
                    <span class="study-year">${s.year}</span>
                </div>
            `).join('');
        }

        function openStudyModal(index) {
            currentStudy = STUDIES[index];
            document.getElementById('modal-study-name').textContent = currentStudy.name;
            document.getElementById('modal-year').textContent = currentStudy.year;
            document.getElementById('modal-patients').textContent = currentStudy.patients.toLocaleString();
            document.getElementById('modal-datapoints').textContent = currentStudy.datapoints;
            document.getElementById('modal-treatment').textContent = currentStudy.treatment;
            document.getElementById('modal-desc').textContent = currentStudy.desc;
            document.getElementById('study-modal').classList.add('show');
        }

        function closeStudyModal() {
            document.getElementById('study-modal').classList.remove('show');
            currentStudy = null;
        }

        function highlightStudyOnChart() {
            if (!currentStudy) return;
            closeStudyModal();
            document.getElementById('scatter-plot').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.querySelectorAll('.study-chip').forEach(chip => chip.classList.remove('highlighted'));
            const studyIndex = STUDIES.findIndex(s => s.name === currentStudy.name);
            if (studyIndex >= 0) {
                document.querySelector(`.study-chip[data-index="${studyIndex}"]`).classList.add('highlighted');
            }
        }

        document.getElementById('study-modal').addEventListener('click', function(e) {
            if (e.target === this) closeStudyModal();
        });

        // =========================================
        // EDGE CASE DATA
        // =========================================
        const EDGE_CASES = [
            { id: "edge_1", name: "HEALED", desc: "Complete fistula resolution", expVai: 0, actVai: 0, expMag: 0, actMag: 0, conf: 84.5 },
            { id: "edge_2", name: "MULTIPLE_SEPARATE", desc: "3 distinct fistulas", expVai: 12, actVai: 12, expMag: 9, actMag: 9, conf: 87.5 },
            { id: "edge_3", name: "ABSCESS_ONLY", desc: "Abscess without tract", expVai: 13, actVai: 10, expMag: 10, actMag: 8, conf: 85.0 },
            { id: "edge_4", name: "POST_SURGICAL", desc: "Post-fistulotomy", expVai: 0, actVai: 0, expMag: 0, actMag: 0, conf: 86.0 },
            { id: "edge_5", name: "AMBIGUOUS", desc: "Equivocal findings", expVai: 8, actVai: 10, expMag: 6, actMag: 8, conf: 46.0, isLowConf: true },
            { id: "edge_6", name: "HORSESHOE", desc: "Complex horseshoe", expVai: 19, actVai: 19, expMag: 13, actMag: 13, conf: 90.0 },
            { id: "edge_7", name: "PEDIATRIC", desc: "12yo simple fistula", expVai: 6, actVai: 6, expMag: 3, actMag: 3, conf: 92.5 },
            { id: "edge_8", name: "MIXED_HEALED_ACTIVE", desc: "One healed, one active", expVai: 9, actVai: 9, expMag: 9, actMag: 9, conf: 85.0 },
            { id: "edge_9", name: "SEVERE_ACUTE", desc: "Maximum severity", expVai: 22, actVai: 22, expMag: 24, actMag: 24, conf: 92.5 },
            { id: "edge_10", name: "MINIMAL", desc: "Normal study", expVai: 0, actVai: 0, expMag: 0, actMag: 0, conf: 81.5 },
            { id: "edge_11", name: "EARLY_SMALL_NEW", desc: "New-onset small", expVai: 6, actVai: 6, expMag: 3, actMag: 3, conf: 90.0 }
        ];

        function renderEdgeCaseTable() {
            const tbody = document.getElementById('edge-case-tbody');
            tbody.innerHTML = EDGE_CASES.map(c => {
                const vaiErr = Math.abs(c.expVai - c.actVai);
                const magErr = Math.abs(c.expMag - c.actMag);
                const vaiClass = vaiErr === 0 ? 'error-0' : vaiErr <= 2 ? 'error-1' : 'error-3';
                const magClass = magErr === 0 ? 'error-0' : magErr <= 2 ? 'error-1' : 'error-3';
                const status = c.isLowConf ?
                    '<span class="status-badge warning">Low Conf</span>' :
                    '<span class="status-badge success">Pass</span>';
                const rowClass = c.isLowConf ? 'style="background: #FEF3C7;"' : '';
                return `
                    <tr ${rowClass}>
                        <td class="mono">${c.name}</td>
                        <td>${c.desc}</td>
                        <td class="num mono">${c.expVai}</td>
                        <td class="num mono ${vaiClass}">${c.actVai}</td>
                        <td class="num mono">${c.expMag}</td>
                        <td class="num mono ${magClass}">${c.actMag}</td>
                        <td class="num mono">${c.conf.toFixed(0)}%</td>
                        <td>${status}</td>
                    </tr>
                `;
            }).join('');
        }

        // =========================================
        // SCATTERPLOT DATA
        // =========================================
        const STUDY_COLORS = {
            'ADMIRE': '#3b82f6',
            'ADMIRE-II': '#8b5cf6',
            'MAGNIFI': '#06b6d4',
            'PISA-II': '#10b981',
            'PEMPAC': '#f59e0b',
            'DIVERGENCE': '#ef4444',
            'De Gregorio': '#ec4899',
            'vanRijn': '#14b8a6',
            'Beek': '#f97316',
            'ESGAR': '#a855f7',
            'Protocolized': '#84cc16',
            'P325': '#6366f1',
            'Other': '#71717a'
        };

        const SCATTER_DATA = [
            { vai: 0, magnifi: 0, study: "vanRijn", label: "vanRijn (healed)", predicted: 3.3, n: 25 },
            { vai: 0, magnifi: 0, study: "PISA-II", label: "PISA-II Surgery (healed)", predicted: 3.3, n: 15 },
            { vai: 0, magnifi: 6, study: "Protocolized", label: "Protocolized (healed)", predicted: 3.3, n: 29 },
            { vai: 4, magnifi: 8, study: "Protocolized", label: "Protocolized (healed high)", predicted: 5.84, n: 14 },
            { vai: 5, magnifi: 6, study: "P325", label: "P325 Responders", predicted: 6.87, n: 26 },
            { vai: 5, magnifi: 7, study: "De Gregorio", label: "De Gregorio (remission)", predicted: 6.87, n: 20 },
            { vai: 6, magnifi: 8, study: "PISA-II", label: "PISA-II (clinical)", predicted: 7.9, n: 24 },
            { vai: 7, magnifi: 9, study: "ADMIRE", label: "ADMIRE (responders)", predicted: 8.93, n: 53 },
            { vai: 8, magnifi: 10, study: "ADMIRE-II", label: "ADMIRE-II (remission)", predicted: 9.96, n: 128 },
            { vai: 9, magnifi: 11, study: "MAGNIFI", label: "MAGNIFI Responders", predicted: 10.99, n: 80 },
            { vai: 10, magnifi: 12, study: "PEMPAC", label: "PEMPAC Baseline", predicted: 12.02, n: 80 },
            { vai: 11, magnifi: 13, study: "De Gregorio", label: "De Gregorio (active)", predicted: 13.05, n: 42 },
            { vai: 12, magnifi: 14, study: "ADMIRE-II", label: "ADMIRE-II (active)", predicted: 14.08, n: 192 },
            { vai: 13, magnifi: 15, study: "DIVERGENCE", label: "DIVERGENCE-2", predicted: 15.12, n: 80 },
            { vai: 14, magnifi: 16, study: "ADMIRE", label: "ADMIRE Baseline", predicted: 16.15, n: 212 },
            { vai: 15, magnifi: 17, study: "ADMIRE-II", label: "ADMIRE-II Baseline", predicted: 17.18, n: 320 },
            { vai: 16, magnifi: 19, study: "vanRijn", label: "vanRijn (active)", predicted: 18.21, n: 25 },
            { vai: 17, magnifi: 20, study: "Beek", label: "Beek (severe)", predicted: 19.24, n: 30 },
            { vai: 18, magnifi: 20, study: "ESGAR", label: "ESGAR (high)", predicted: 20.27, n: 33 },
            { vai: 22, magnifi: 25, study: "Other", label: "Maximum severity", predicted: 24.4, n: 1 }
        ];

        function initScatterPlot() {
            const textColor = '#475569';
            const gridColor = 'rgba(0,0,0,0.08)';

            // Severity zone shapes (background shading)
            const severityZones = [
                // Remission (0-4): Green
                { type: 'rect', x0: 0, x1: 4, y0: 0, y1: 4, fillcolor: 'rgba(16, 185, 129, 0.08)', line: { width: 0 }, layer: 'below' },
                // Mild (5-10): Teal
                { type: 'rect', x0: 4, x1: 10, y0: 4, y1: 10, fillcolor: 'rgba(20, 184, 166, 0.08)', line: { width: 0 }, layer: 'below' },
                // Moderate (11-17): Orange
                { type: 'rect', x0: 10, x1: 17, y0: 10, y1: 17, fillcolor: 'rgba(245, 158, 11, 0.08)', line: { width: 0 }, layer: 'below' },
                // Severe (18-25): Red
                { type: 'rect', x0: 17, x1: 27, y0: 17, y1: 27, fillcolor: 'rgba(239, 68, 68, 0.08)', line: { width: 0 }, layer: 'below' }
            ];

            const studyGroups = {};
            SCATTER_DATA.forEach(d => {
                if (!studyGroups[d.study]) studyGroups[d.study] = [];
                studyGroups[d.study].push(d);
            });

            const studyTraces = Object.entries(studyGroups).map(([study, points]) => ({
                x: points.map(d => d.magnifi),
                y: points.map(d => d.predicted),
                mode: 'markers',
                type: 'scatter',
                name: study,
                text: points.map(d => `<b>${d.label}</b><br>n=${d.n} patients<br>Actual: ${d.magnifi}<br>Predicted: ${d.predicted.toFixed(1)}<br>Study: ${study}`),
                marker: {
                    color: STUDY_COLORS[study] || STUDY_COLORS['Other'],
                    size: points.map(d => Math.sqrt(d.n) * 1.2 + 8),
                    opacity: 0.85,
                    line: { color: 'white', width: 1.5 }
                },
                hovertemplate: '%{text}<extra></extra>'
            }));

            const perfectLine = {
                x: [0, 25], y: [0, 25],
                mode: 'lines',
                name: 'Perfect (y=x)',
                line: { color: '#9CA3AF', width: 2, dash: 'dash' },
                hoverinfo: 'skip'
            };

            const layout = {
                paper_bgcolor: 'white',
                plot_bgcolor: 'white',
                font: { family: '-apple-system, BlinkMacSystemFont, sans-serif', color: textColor },
                xaxis: {
                    title: { text: 'Actual MAGNIFI-CD', font: { size: 12 } },
                    range: [-1, 27],
                    gridcolor: gridColor,
                    zerolinecolor: gridColor,
                    tickfont: { size: 11 }
                },
                yaxis: {
                    title: { text: 'Predicted MAGNIFI-CD', font: { size: 12 } },
                    range: [-1, 27],
                    gridcolor: gridColor,
                    zerolinecolor: gridColor,
                    tickfont: { size: 11 }
                },
                margin: { t: 20, r: 150, b: 60, l: 70 },
                showlegend: true,
                legend: {
                    x: 1.02, y: 1,
                    xanchor: 'left',
                    bgcolor: 'transparent',
                    font: { size: 10 }
                },
                hovermode: 'closest',
                shapes: severityZones,
                annotations: [
                    { x: 4, y: 24, text: '<b>R = 0.96</b>', showarrow: false, font: { size: 12, color: '#0066CC' }, bgcolor: '#E6F0FA', borderpad: 6 },
                    // Severity zone labels
                    { x: 2, y: 2, text: 'Remission', showarrow: false, font: { size: 9, color: '#10B981' }, opacity: 0.8 },
                    { x: 7, y: 7, text: 'Mild', showarrow: false, font: { size: 9, color: '#14B8A6' }, opacity: 0.8 },
                    { x: 13.5, y: 13.5, text: 'Moderate', showarrow: false, font: { size: 9, color: '#F59E0B' }, opacity: 0.8 },
                    { x: 22, y: 22, text: 'Severe', showarrow: false, font: { size: 9, color: '#EF4444' }, opacity: 0.8 }
                ]
            };

            Plotly.newPlot('scatter-plot', [...studyTraces, perfectLine], layout, { responsive: true, displayModeBar: false });
        }

        // Store user calculation result for plotting
        let userCalculationResult = null;
        let userMarkerAdded = false;

        function showOnScatterplot(magnifi, predicted) {
            // Reinitialize plot to remove old marker, then add new one
            if (userMarkerAdded) {
                initScatterPlot();
            }
            userCalculationResult = { magnifi, predicted };
            // Add user marker
            const userMarker = {
                x: [magnifi],
                y: [predicted],
                mode: 'markers',
                type: 'scatter',
                name: 'Your Result',
                text: [`<b>Your Calculation</b><br>MAGNIFI-CD: ${magnifi}<br>Predicted: ${predicted.toFixed(1)}`],
                marker: {
                    color: '#DC2626',
                    size: 20,
                    symbol: 'star',
                    line: { color: 'white', width: 2 }
                },
                hovertemplate: '%{text}<extra></extra>'
            };
            Plotly.addTraces('scatter-plot', userMarker);
            userMarkerAdded = true;
            // Scroll to chart
            document.getElementById('scatter-plot').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function initResidualPlot() {
            const textColor = '#475569';
            const gridColor = 'rgba(0,0,0,0.08)';

            const residuals = SCATTER_DATA.map(d => ({
                predicted: d.predicted,
                residual: d.magnifi - d.predicted,
                study: d.study,
                label: d.label,
                n: d.n
            }));

            const trace = {
                x: residuals.map(r => r.predicted),
                y: residuals.map(r => r.residual),
                mode: 'markers',
                type: 'scatter',
                text: residuals.map(r => `${r.label}<br>n=${r.n}<br>Residual: ${r.residual.toFixed(2)}`),
                marker: {
                    color: residuals.map(r => STUDY_COLORS[r.study] || '#71717a'),
                    size: residuals.map(r => Math.sqrt(r.n) * 0.8 + 6),
                    opacity: 0.85,
                    line: { color: 'white', width: 1 }
                },
                hovertemplate: '%{text}<extra></extra>'
            };

            const zeroLine = { x: [0, 30], y: [0, 0], mode: 'lines', line: { color: '#9CA3AF', width: 2, dash: 'dash' }, hoverinfo: 'skip' };
            const upperBound = { x: [0, 30], y: [1.88, 1.88], mode: 'lines', line: { color: 'rgba(220,38,38,0.4)', width: 1, dash: 'dot' }, showlegend: false, hoverinfo: 'skip' };
            const lowerBound = { x: [0, 30], y: [-1.88, -1.88], mode: 'lines', line: { color: 'rgba(220,38,38,0.4)', width: 1, dash: 'dot' }, showlegend: false, hoverinfo: 'skip' };

            const layout = {
                paper_bgcolor: 'white',
                plot_bgcolor: 'white',
                font: { family: '-apple-system, sans-serif', color: textColor },
                xaxis: { title: 'Predicted MAGNIFI-CD', gridcolor: gridColor, tickfont: { size: 10 } },
                yaxis: { title: 'Residual', gridcolor: gridColor, tickfont: { size: 10 }, range: [-5, 5] },
                margin: { t: 10, r: 20, b: 50, l: 60 },
                showlegend: false,
                hovermode: 'closest'
            };

            Plotly.newPlot('residual-plot', [trace, zeroLine, upperBound, lowerBound], layout, { responsive: true, displayModeBar: false });
        }

        function initBlandAltmanPlot() {
            const textColor = '#475569';
            const gridColor = 'rgba(0,0,0,0.08)';

            const baData = SCATTER_DATA.map(d => ({
                mean: (d.magnifi + d.predicted) / 2,
                diff: d.magnifi - d.predicted,
                study: d.study,
                label: d.label,
                n: d.n
            }));

            const meanDiff = baData.reduce((sum, d) => sum + d.diff, 0) / baData.length;
            const sdDiff = Math.sqrt(baData.reduce((sum, d) => sum + Math.pow(d.diff - meanDiff, 2), 0) / (baData.length - 1));
            const upperLOA = meanDiff + 1.96 * sdDiff;
            const lowerLOA = meanDiff - 1.96 * sdDiff;

            const trace = {
                x: baData.map(d => d.mean),
                y: baData.map(d => d.diff),
                mode: 'markers',
                text: baData.map(d => `${d.label}<br>n=${d.n}<br>Diff: ${d.diff.toFixed(2)}`),
                marker: {
                    color: baData.map(d => STUDY_COLORS[d.study] || '#71717a'),
                    size: baData.map(d => Math.sqrt(d.n) * 0.8 + 6),
                    opacity: 0.85,
                    line: { color: 'white', width: 1 }
                },
                hovertemplate: '%{text}<extra></extra>'
            };

            const meanLine = { x: [0, 30], y: [meanDiff, meanDiff], mode: 'lines', line: { color: '#0066CC', width: 2 }, hoverinfo: 'skip' };
            const upperLine = { x: [0, 30], y: [upperLOA, upperLOA], mode: 'lines', line: { color: '#DC2626', width: 1.5, dash: 'dash' }, hoverinfo: 'skip' };
            const lowerLine = { x: [0, 30], y: [lowerLOA, lowerLOA], mode: 'lines', line: { color: '#DC2626', width: 1.5, dash: 'dash' }, hoverinfo: 'skip' };

            const layout = {
                paper_bgcolor: 'white',
                plot_bgcolor: 'white',
                font: { family: '-apple-system, sans-serif', color: textColor },
                xaxis: { title: 'Mean', gridcolor: gridColor, tickfont: { size: 10 } },
                yaxis: { title: 'Difference', gridcolor: gridColor, tickfont: { size: 10 }, range: [-5, 5] },
                margin: { t: 10, r: 20, b: 50, l: 60 },
                showlegend: false,
                hovermode: 'closest',
                annotations: [
                    { x: 22, y: meanDiff, text: `Mean: ${meanDiff.toFixed(2)}`, showarrow: false, font: { size: 9, color: '#0066CC' }, bgcolor: '#E6F0FA', borderpad: 3 },
                    { x: 22, y: upperLOA, text: `+LOA: ${upperLOA.toFixed(2)}`, showarrow: false, font: { size: 9, color: '#DC2626' }, bgcolor: '#FEE2E2', borderpad: 3 },
                    { x: 22, y: lowerLOA, text: `-LOA: ${lowerLOA.toFixed(2)}`, showarrow: false, font: { size: 9, color: '#DC2626' }, bgcolor: '#FEE2E2', borderpad: 3 }
                ]
            };

            Plotly.newPlot('bland-altman-plot', [trace, meanLine, upperLine, lowerLine], layout, { responsive: true, displayModeBar: false });
        }

        // Smooth scroll for nav links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderStudyGrid();
            renderEdgeCaseTable();
            initScatterPlot();
            initResidualPlot();
            initBlandAltmanPlot();
        });
    </script>
</body>
</html>
