<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrohnBridge | Crosswalk Calculator</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        /* =========================================
           CLEAN MEDICAL DESIGN SYSTEM
           ========================================= */
        :root {
            /* Primary - Medical Blue */
            --primary: #0066CC;
            --primary-light: #E6F0FA;
            --primary-dark: #004C99;

            /* Neutrals */
            --white: #FFFFFF;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;

            /* Semantic */
            --success: #059669;
            --warning: #D97706;
            --danger: #DC2626;
            --info: #0284C7;

            /* Severity Scale */
            --severity-remission: #10B981;
            --severity-mild: #14B8A6;
            --severity-moderate: #F59E0B;
            --severity-severe: #EF4444;

            /* Typography */
            --font-primary: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', monospace;

            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-12: 3rem;

            /* Borders & Shadows */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { font-size: 16px; scroll-behavior: smooth; }

        body {
            font-family: var(--font-primary);
            background: var(--white);
            color: var(--gray-900);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* =========================================
           NAVIGATION
           ========================================= */
        nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            height: 56px;
        }

        .nav-logo {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--gray-900);
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: var(--space-1);
            list-style: none;
            align-items: center;
        }

        .nav-links a {
            color: var(--gray-600);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            transition: color 0.15s, background 0.15s;
        }

        .nav-links a:hover {
            color: var(--gray-900);
            background: var(--gray-100);
        }

        .nav-badge {
            font-size: 0.75rem;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            margin-left: var(--space-4);
        }

        /* =========================================
           HERO SECTION
           ========================================= */
        .hero {
            padding: var(--space-12) var(--space-6);
            max-width: 1200px;
            margin: 0 auto;
        }

        .hero-content {
            max-width: 720px;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: var(--space-2);
            line-height: 1.2;
        }

        .hero-tagline {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--primary);
            margin-bottom: var(--space-4);
            letter-spacing: -0.01em;
        }

        .hero-subtitle {
            font-size: 1.125rem;
            color: var(--gray-600);
            margin-bottom: var(--space-6);
            line-height: 1.6;
        }

        .hero-actions {
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        /* =========================================
           ABOUT SECTION
           ========================================= */
        .about-section {
            padding: var(--space-10) var(--space-6);
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
        }

        .about-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-8);
            max-width: 1000px;
            margin: 0 auto;
        }

        .about-story, .about-tool {
            background: var(--gray-50);
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
        }

        .about-story h3, .about-tool h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-4);
        }

        .about-story p, .about-tool p {
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: var(--space-3);
        }

        .about-tool ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .about-tool li {
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: var(--space-3);
            padding-left: var(--space-4);
            position: relative;
        }

        .about-tool li:before {
            content: "â†’";
            position: absolute;
            left: 0;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .about-content {
                grid-template-columns: 1fr;
            }
        }

        /* =========================================
           BUTTONS
           ========================================= */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        /* =========================================
           FORMULA DISPLAY
           ========================================= */
        .formula-section {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin: var(--space-8) 0;
        }

        .formula-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: var(--space-3);
        }

        .formula-text {
            font-family: var(--font-mono);
            font-size: 1.25rem;
            color: var(--gray-900);
            margin-bottom: var(--space-6);
        }

        .formula-var { color: var(--primary); }
        .formula-coef { color: var(--gray-700); font-weight: 600; }

        .stats-row {
            display: flex;
            gap: var(--space-4);
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: left;
        }

        .stat-value {
            font-family: var(--font-mono);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* =========================================
           SECTIONS
           ========================================= */
        section {
            padding: var(--space-12) var(--space-6);
            border-top: 1px solid var(--gray-200);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-header {
            margin-bottom: var(--space-8);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-2);
        }

        .section-desc {
            color: var(--gray-600);
            max-width: 600px;
        }

        /* =========================================
           CARDS
           ========================================= */
        .card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-4);
        }

        /* =========================================
           CALCULATOR
           ========================================= */
        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
        }

        @media (max-width: 768px) {
            .calculator-grid { grid-template-columns: 1fr; }
        }

        .calc-input-group {
            margin-bottom: var(--space-6);
        }

        .calc-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: var(--space-2);
        }

        .calc-slider-row {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .calc-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: var(--gray-200);
            border-radius: 3px;
            outline: none;
        }

        .calc-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .calc-value {
            font-family: var(--font-mono);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            min-width: 40px;
            text-align: right;
        }

        .direction-toggle {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
        }

        .direction-btn {
            flex: 1;
            padding: var(--space-3);
            border: 1px solid var(--gray-300);
            background: var(--white);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.15s;
        }

        .direction-btn.active {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .direction-btn:hover:not(.active) {
            background: var(--gray-50);
        }

        /* Results */
        .result-placeholder {
            text-align: center;
            padding: var(--space-8);
            color: var(--gray-400);
        }

        .result-box {
            background: var(--gray-50);
            border-radius: var(--radius-md);
            padding: var(--space-6);
            text-align: center;
            margin-top: var(--space-6);
        }

        .result-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: var(--space-2);
        }

        .result-value {
            font-family: var(--font-mono);
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: var(--space-2);
        }

        .result-value.severity-remission { color: var(--severity-remission); }
        .result-value.severity-mild { color: var(--severity-mild); }
        .result-value.severity-moderate { color: var(--severity-moderate); }
        .result-value.severity-severe { color: var(--severity-severe); }

        .severity-badge {
            display: inline-block;
            padding: var(--space-1) var(--space-3);
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .severity-badge.remission { background: #D1FAE5; color: #065F46; }
        .severity-badge.mild { background: #CCFBF1; color: #115E59; }
        .severity-badge.moderate { background: #FEF3C7; color: #92400E; }
        .severity-badge.severe { background: #FEE2E2; color: #991B1B; }

        .result-pi {
            font-size: 0.8125rem;
            color: var(--gray-500);
            margin-top: var(--space-2);
        }

        .severity-gauge {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            margin-top: var(--space-4);
            position: relative;
            overflow: hidden;
        }

        .severity-gauge-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--severity-remission) 0%, var(--severity-mild) 20%, var(--severity-moderate) 50%, var(--severity-severe) 80%);
        }

        .severity-gauge-marker {
            position: absolute;
            top: -4px;
            width: 4px;
            height: 16px;
            background: var(--gray-900);
            border-radius: 2px;
            transform: translateX(-50%);
        }

        .severity-gauge-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: var(--space-1);
        }

        /* Work steps */
        .work-steps { display: none; }
        .work-steps.show { display: block; }

        .work-step {
            padding: var(--space-4);
            border-left: 3px solid var(--gray-200);
            margin-bottom: var(--space-4);
            margin-left: var(--space-3);
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: var(--white);
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: var(--space-2);
        }

        .step-title {
            display: inline;
            font-weight: 600;
            color: var(--gray-900);
        }

        .step-content {
            margin-top: var(--space-2);
            font-family: var(--font-mono);
            font-size: 0.875rem;
            color: var(--gray-700);
            line-height: 1.8;
        }

        .highlight { color: var(--primary); font-weight: 600; }
        .coef { color: var(--gray-500); }

        /* =========================================
           CHARTS
           ========================================= */
        .chart-container {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
        }

        .chart-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--space-4);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
            margin-top: var(--space-6);
        }

        @media (max-width: 900px) {
            .charts-grid { grid-template-columns: 1fr; }
        }

        /* =========================================
           VALIDATION METRICS
           ========================================= */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-8);
        }

        @media (max-width: 768px) {
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .metric-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            text-align: center;
        }

        .metric-value {
            font-family: var(--font-mono);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
        }

        .metric-label {
            font-size: 0.8125rem;
            color: var(--gray-600);
            margin-top: var(--space-1);
        }

        /* =========================================
           TABLES
           ========================================= */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th {
            text-align: left;
            padding: var(--space-3) var(--space-4);
            background: var(--gray-50);
            border-bottom: 2px solid var(--gray-200);
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--gray-200);
            color: var(--gray-700);
        }

        tr:hover { background: var(--gray-50); }

        .mono { font-family: var(--font-mono); }
        .num { text-align: right; }

        .error-0 { color: var(--success); }
        .error-1 { color: var(--warning); }
        .error-3 { color: var(--danger); }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 100px;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.success { background: #D1FAE5; color: #065F46; }
        .status-badge.warning { background: #FEF3C7; color: #92400E; }

        /* =========================================
           STUDY CHIPS
           ========================================= */
        .study-grid {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
        }

        .study-chip {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .study-chip:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .study-chip.highlighted {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .study-name { font-weight: 500; color: var(--gray-800); }
        .study-year { color: var(--gray-500); font-size: 0.75rem; }

        /* =========================================
           MODAL
           ========================================= */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
        }

        .modal.show { display: flex; }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--space-4);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover { color: var(--gray-600); }

        .modal-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .modal-stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .modal-stat-value {
            font-family: var(--font-mono);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-desc {
            color: var(--gray-600);
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .modal-actions {
            margin-top: var(--space-6);
            display: flex;
            gap: var(--space-3);
        }

        /* =========================================
           LIMITATIONS
           ========================================= */
        .limitations-card {
            background: #FFFBEB;
            border: 1px solid #FDE68A;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-top: var(--space-8);
        }

        .limitations-title {
            font-size: 1rem;
            font-weight: 600;
            color: #92400E;
            margin-bottom: var(--space-4);
        }

        .limitations-list {
            list-style: none;
        }

        .limitations-list li {
            padding: var(--space-2) 0;
            color: #78350F;
            font-size: 0.875rem;
            padding-left: var(--space-6);
            position: relative;
        }

        .limitations-list li::before {
            content: "!";
            position: absolute;
            left: 0;
            width: 20px;
            height: 20px;
            background: #FDE68A;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #92400E;
        }

        /* =========================================
           FOOTER
           ========================================= */
        footer {
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            padding: var(--space-8) var(--space-6);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-4);
        }

        .footer-left {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .footer-logo {
            font-weight: 600;
            color: var(--gray-900);
        }

        .footer-meta {
            font-size: 0.8125rem;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: var(--space-4);
        }

        .footer-links a {
            color: var(--gray-600);
            text-decoration: none;
            font-size: 0.875rem;
        }

        .footer-links a:hover {
            color: var(--primary);
        }

        /* =========================================
           PARSER METRICS GRID
           ========================================= */
        .parser-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
        }

        @media (max-width: 768px) {
            .parser-metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .parser-metric {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            text-align: center;
        }

        .parser-metric-value {
            font-family: var(--font-mono);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .parser-metric-label {
            font-size: 0.8125rem;
            color: var(--gray-600);
            margin-top: var(--space-1);
        }

        .parser-metric-ci {
            font-size: 0.6875rem;
            color: var(--gray-400);
            margin-top: var(--space-1);
            font-family: var(--font-mono);
        }

        /* =========================================
           METHODOLOGY SLIDESHOW
           ========================================= */
        .methodology-slideshow {
            position: relative;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            overflow: hidden;
        }

        .slideshow-slide {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .slideshow-slide.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .slide-counter {
            position: absolute;
            top: var(--space-3);
            right: var(--space-3);
            font-size: 0.6875rem;
            color: var(--gray-500);
            font-family: var(--font-mono);
        }

        .slide-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-2);
        }

        .slide-content {
            color: var(--gray-700);
            font-size: 0.8125rem;
            line-height: 1.6;
        }

        .slide-content ul {
            margin-left: var(--space-3);
            margin-top: var(--space-1);
        }

        .slide-content li { margin-bottom: 2px; }

        .slide-stat {
            display: inline-block;
            margin-top: var(--space-2);
            padding: var(--space-1) var(--space-3);
            background: var(--primary-light);
            border-radius: var(--radius-md);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary);
        }

        .slide-code {
            font-family: var(--font-mono);
            background: var(--gray-100);
            padding: var(--space-2);
            border-radius: var(--radius-sm);
            margin-top: var(--space-2);
            font-size: 0.75rem;
            color: var(--gray-800);
        }

        .slideshow-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid var(--gray-200);
        }

        .slideshow-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background: var(--white);
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.15s;
        }

        .slideshow-arrow:hover:not(:disabled) {
            background: var(--gray-100);
            color: var(--gray-900);
            border-color: var(--gray-300);
        }

        .slideshow-arrow:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .slideshow-dots {
            display: flex;
            gap: var(--space-2);
        }

        .slideshow-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-300);
            cursor: pointer;
            transition: all 0.15s;
        }

        .slideshow-dot.active {
            background: var(--primary);
            transform: scale(1.2);
        }

        .slideshow-dot:hover:not(.active) {
            background: var(--gray-400);
        }

        /* =========================================
           VALIDATION STUDIES ACCORDION
           ========================================= */
        .accordion {
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-top: var(--space-6);
        }

        .accordion-item {
            border-bottom: 1px solid var(--gray-200);
        }

        .accordion-item:last-child { border-bottom: none; }

        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4);
            background: var(--white);
            cursor: pointer;
            transition: background 0.15s;
        }

        .accordion-header:hover { background: var(--gray-50); }

        .accordion-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-900);
        }

        .accordion-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--gray-100);
            border-radius: 50%;
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--gray-600);
            font-family: var(--font-mono);
        }

        .accordion-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .accordion-badge {
            font-size: 0.6875rem;
            padding: 2px 8px;
            border-radius: 100px;
            font-weight: 600;
        }

        .accordion-badge.pass { background: #D1FAE5; color: #065F46; }
        .accordion-badge.addressed { background: #FEF3C7; color: #92400E; }

        .accordion-arrow {
            width: 20px;
            height: 20px;
            color: var(--gray-400);
            transition: transform 0.2s;
        }

        .accordion-item.open .accordion-arrow { transform: rotate(180deg); }

        .accordion-content {
            display: none;
            padding: 0 var(--space-4) var(--space-4);
            font-size: 0.8125rem;
            color: var(--gray-600);
            line-height: 1.6;
        }

        .accordion-item.open .accordion-content { display: block; }

        .accordion-detail {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: var(--space-2);
            margin-top: var(--space-2);
        }

        .accordion-detail-label {
            font-weight: 600;
            color: var(--gray-500);
            font-size: 0.6875rem;
            text-transform: uppercase;
        }

        .accordion-summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
            padding: var(--space-4);
            background: var(--gray-50);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
        }

        @media (max-width: 600px) {
            .accordion-summary-stats { grid-template-columns: repeat(2, 1fr); }
        }

        .accordion-stat {
            text-align: center;
        }

        .accordion-stat-value {
            font-family: var(--font-mono);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .accordion-stat-label {
            font-size: 0.6875rem;
            color: var(--gray-500);
            margin-top: var(--space-1);
        }

        /* =========================================
           UTILITIES
           ========================================= */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: var(--space-4); }
        .mt-6 { margin-top: var(--space-6); }
        .mb-4 { margin-bottom: var(--space-4); }

        /* =========================================
           DARK MODE TOGGLE
           ========================================= */
        .theme-toggle {
            background: none;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            padding: var(--space-2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            transition: all 0.15s;
        }

        .theme-toggle:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }

        .theme-toggle .sun { display: none; }
        .theme-toggle .moon { display: block; }

        /* =========================================
           DARK MODE STYLES
           ========================================= */
        [data-theme="dark"] {
            --white: #111827;
            --gray-50: #1F2937;
            --gray-100: #374151;
            --gray-200: #4B5563;
            --gray-300: #6B7280;
            --gray-400: #9CA3AF;
            --gray-500: #D1D5DB;
            --gray-600: #E5E7EB;
            --gray-700: #F3F4F6;
            --gray-800: #F9FAFB;
            --gray-900: #FFFFFF;

            --primary-light: rgba(0, 102, 204, 0.2);
        }

        [data-theme="dark"] body {
            background: #0F172A;
        }

        [data-theme="dark"] nav {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .card,
        [data-theme="dark"] .chart-container {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .formula-section {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] section {
            border-color: #334155;
        }

        [data-theme="dark"] footer {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .modal-content {
            background: #1E293B;
        }

        [data-theme="dark"] .modal {
            background: rgba(0, 0, 0, 0.7);
        }

        /* Keep yellow background in dark mode with dark text for readability */
        [data-theme="dark"] .limitations-card {
            background: #FEF3C7;
            border-color: #FDE68A;
        }

        [data-theme="dark"] .limitations-title {
            color: #92400E;
        }

        [data-theme="dark"] .limitations-list li {
            color: #78350F;
        }

        [data-theme="dark"] .limitations-list li::before {
            background: #92400E;
        }

        [data-theme="dark"] .calc-slider {
            background: var(--gray-200);
        }

        [data-theme="dark"] table th {
            background: #1E293B;
        }

        [data-theme="dark"] .metric-card,
        [data-theme="dark"] .parser-metric,
        [data-theme="dark"] .stat-item {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .study-chip {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .theme-toggle .sun { display: block; }
        [data-theme="dark"] .theme-toggle .moon { display: none; }

        [data-theme="dark"] .theme-toggle {
            border-color: #334155;
            color: #E5E7EB;
        }

        [data-theme="dark"] .theme-toggle:hover {
            background: #334155;
        }

        /* Additional dark mode fixes for text visibility */
        [data-theme="dark"] .methodology-slideshow {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .slide-title {
            color: #F9FAFB;
        }

        [data-theme="dark"] .slide-content {
            color: #E5E7EB;
        }

        [data-theme="dark"] .slide-content strong {
            color: #F9FAFB;
        }

        [data-theme="dark"] .slide-counter {
            color: #9CA3AF;
        }

        [data-theme="dark"] .stat-highlight {
            background: rgba(0, 102, 204, 0.3);
        }

        [data-theme="dark"] .stat-highlight span {
            color: #60A5FA;
        }

        [data-theme="dark"] .accordion-item {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .accordion-header:hover {
            background: #334155;
        }

        [data-theme="dark"] .accordion-title {
            color: #F9FAFB;
        }

        [data-theme="dark"] .accordion-content {
            background: #0F172A;
        }

        [data-theme="dark"] .accordion-detail {
            border-color: #334155;
        }

        [data-theme="dark"] .accordion-detail-label {
            color: #9CA3AF;
        }

        [data-theme="dark"] .accordion-detail span:last-child {
            color: #E5E7EB;
        }

        [data-theme="dark"] .accordion-summary-stats {
            background: #1E293B;
            border-color: #334155;
        }

        [data-theme="dark"] .accordion-stat-value {
            color: #60A5FA;
        }

        [data-theme="dark"] .accordion-stat-label {
            color: #9CA3AF;
        }

        [data-theme="dark"] .slideshow-arrow {
            background: #334155;
            border-color: #4B5563;
            color: #E5E7EB;
        }

        [data-theme="dark"] .slideshow-arrow:hover:not(:disabled) {
            background: #4B5563;
            color: #F9FAFB;
        }

        [data-theme="dark"] .slideshow-dot {
            background: #4B5563;
        }

        [data-theme="dark"] .slideshow-dot.active {
            background: #60A5FA;
        }

        /* =========================================
           CLICKABLE STAT EXPLANATIONS
           ========================================= */
        .stat-clickable {
            cursor: pointer;
            position: relative;
            text-decoration: underline dotted;
            text-underline-offset: 3px;
            transition: all 0.15s;
        }

        .stat-clickable:hover {
            color: var(--primary);
            text-decoration-style: solid;
        }

        .stat-clickable::after {
            content: '?';
            font-size: 0.6em;
            vertical-align: super;
            margin-left: 2px;
            opacity: 0.5;
        }

        /* Stat Modal */
        .stat-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .stat-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .stat-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            max-width: 420px;
            width: calc(100% - 32px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .stat-modal-overlay.show + .stat-modal,
        .stat-modal.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        [data-theme="dark"] .stat-modal {
            background: #1E293B;
            border: 1px solid #334155;
        }

        .stat-modal-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .stat-modal-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.25rem;
            font-weight: 700;
        }

        .stat-modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .stat-modal-value {
            font-family: var(--font-mono);
            font-size: 0.875rem;
            color: var(--primary);
        }

        .stat-modal-close {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            width: 32px;
            height: 32px;
            border: none;
            background: var(--gray-100);
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            transition: all 0.15s;
        }

        .stat-modal-close:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        [data-theme="dark"] .stat-modal-close {
            background: #334155;
            color: #9CA3AF;
        }

        [data-theme="dark"] .stat-modal-close:hover {
            background: #4B5563;
            color: #E5E7EB;
        }

        .stat-modal-body {
            font-size: 0.9375rem;
            line-height: 1.7;
            color: var(--gray-700);
        }

        [data-theme="dark"] .stat-modal-body {
            color: #D1D5DB;
        }

        .stat-modal-section {
            margin-bottom: var(--space-4);
        }

        .stat-modal-section:last-child {
            margin-bottom: 0;
        }

        .stat-modal-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: var(--space-2);
        }

        .stat-modal-highlight {
            background: var(--primary-light);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-top: var(--space-4);
        }

        .stat-modal-highlight p {
            font-size: 0.875rem;
            color: var(--primary-dark);
            margin: 0;
        }

        [data-theme="dark"] .stat-modal-highlight {
            background: rgba(0, 102, 204, 0.2);
        }

        [data-theme="dark"] .stat-modal-highlight p {
            color: #60A5FA;
        }

        .stat-hint {
            font-size: 0.75rem;
            color: var(--gray-400);
            text-align: center;
            margin-top: var(--space-4);
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-inner">
            <a href="#" class="nav-logo">CrohnBridge</a>
            <ul class="nav-links">
                <li><a href="#calculator">Calculator</a></li>
                <li><a href="#validation">Validation</a></li>
                <li><a href="#methodology">Studies</a></li>
                <li><a href="parser.html">Parser</a></li>
                <li><a href="#about">About</a></li>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
                    <svg class="moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                    <svg class="sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                </button>
                <span class="nav-badge">ISEF 2026</span>
            </ul>
        </div>
    </nav>

    <!-- Hero -->
    <div class="hero">
        <div class="hero-content">
            <h1 class="hero-title">CrohnBridge</h1>
            <p class="hero-tagline">Neuro-Symbolic AI for Perianal Crohn's Disease Research</p>
            <p class="hero-subtitle">
                A neuro-symbolic AI system that enables direct comparison of MRI scoring systems for perianal fistulizing Crohn's disease, unlocking 20+ years of previously incompatible research data.
            </p>
            <div class="hero-actions">
                <a href="#calculator" class="btn btn-primary">Try the Calculator</a>
                <a href="#methodology" class="btn btn-secondary">View Methodology</a>
            </div>
        </div>
    </div>

        <!-- Formula Display -->
        <div class="formula-section">
            <div class="formula-label">Crosswalk Formula</div>
            <div class="formula-text">
                <span class="formula-var">MAGNIFI-CD</span> =
                <span class="formula-coef">1.031</span> x VAI +
                <span class="formula-coef">0.264</span> x Fibrosis x I(VAI&le;2) +
                <span class="formula-coef">1.713</span>
            </div>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value stat-clickable" data-stat="r-squared">0.96</div>
                    <div class="stat-label">R-squared</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value stat-clickable" data-stat="n-patients">2,818</div>
                    <div class="stat-label">Patients</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">17</div>
                    <div class="stat-label">Studies</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value stat-clickable" data-stat="rmse">0.96</div>
                    <div class="stat-label">RMSE (points)</div>
                </div>
            </div>
            <p class="stat-hint">Click any stat for explanation</p>
        </div>

        <!-- Crosswalk Methodology Slideshow -->
        <div class="methodology-slideshow" id="crosswalk-methodology">
            <div class="slide-counter"><span id="crosswalk-methodology-slide-current">1</span> / 5</div>

            <div class="slideshow-slide active" data-slide="1">
                <div class="slide-title">Step 1: Literature Mining</div>
                <div class="slide-content">
                    <p>Systematically extracted VAI and MAGNIFI-CD scores from peer-reviewed studies on perianal fistulizing Crohn's disease (pfCD).</p>
                    <ul>
                        <li>Searched PubMed, ECCO abstracts, and clinical trial databases</li>
                        <li>Included studies reporting both scoring systems</li>
                        <li>Covered multiple treatment modalities (biologics, stem cells, surgery)</li>
                    </ul>
                    <div class="slide-stat">17 studies | 2,818 patients</div>
                </div>
            </div>

            <div class="slideshow-slide" data-slide="2">
                <div class="slide-title">Step 2: Data Extraction</div>
                <div class="slide-content">
                    <p>Collected matched VAI and MAGNIFI-CD data points from published tables and figures.</p>
                    <ul>
                        <li>Extracted baseline and follow-up scores</li>
                        <li>Recorded treatment type and patient counts</li>
                        <li>Noted fibrosis state when reported (for healed cases)</li>
                    </ul>
                    <div class="slide-stat">83 matched data points</div>
                </div>
            </div>

            <div class="slideshow-slide" data-slide="3">
                <div class="slide-title">Step 3: Symbolic Regression</div>
                <div class="slide-content">
                    <p>Used PySR (Python Symbolic Regression) to discover the optimal mathematical relationship.</p>
                    <ul>
                        <li>Explored millions of candidate equations</li>
                        <li>Balanced model complexity vs. fit quality</li>
                        <li>Identified fibrosis interaction for healed cases (VAI â‰¤ 2)</li>
                    </ul>
                    <div class="slide-code">MAGNIFI = 1.031 Ã— VAI + 0.264 Ã— Fibrosis Ã— I(VAIâ‰¤2) + 1.713</div>
                </div>
            </div>

            <div class="slideshow-slide" data-slide="4">
                <div class="slide-title">Step 4: Rigorous Validation</div>
                <div class="slide-content">
                    <p>Conducted 19 statistical studies to verify robustness and identify limitations.</p>
                    <ul>
                        <li>10-fold cross-validation: RÂ² = 0.94 Â± 0.05</li>
                        <li>Leave-one-study-out: RÂ² = 0.94 Â± 0.08</li>
                        <li>Addressed heteroscedasticity with HC3 robust SEs</li>
                        <li>Documented temporal drift as limitation</li>
                    </ul>
                    <div class="slide-stat">RÂ² = 0.968 | RMSE = 0.96 pts</div>
                </div>
            </div>

            <div class="slideshow-slide" data-slide="5">
                <div class="slide-title">Result: Universal Translator</div>
                <div class="slide-content">
                    <p>The first validated crosswalk between VAI and MAGNIFI-CD enables:</p>
                    <ul>
                        <li>Direct comparison of 20+ years of pfCD research</li>
                        <li>Meta-analysis across previously incompatible studies</li>
                        <li>Standardized clinical trial endpoints</li>
                        <li>Real-time score conversion in clinical practice</li>
                    </ul>
                    <div class="slide-stat">Unlocking decades of research data</div>
                </div>
            </div>

            <div class="slideshow-nav">
                <button class="slideshow-arrow" id="crosswalk-methodology-prev" onclick="changeSlide('crosswalk-methodology', -1)" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                </button>
                <div class="slideshow-dots" id="crosswalk-methodology-dots">
                    <div class="slideshow-dot active" onclick="goToSlide('crosswalk-methodology', 1)"></div>
                    <div class="slideshow-dot" onclick="goToSlide('crosswalk-methodology', 2)"></div>
                    <div class="slideshow-dot" onclick="goToSlide('crosswalk-methodology', 3)"></div>
                    <div class="slideshow-dot" onclick="goToSlide('crosswalk-methodology', 4)"></div>
                    <div class="slideshow-dot" onclick="goToSlide('crosswalk-methodology', 5)"></div>
                </div>
                <button class="slideshow-arrow" id="crosswalk-methodology-next" onclick="changeSlide('crosswalk-methodology', 1)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Calculator Section -->
    <section id="calculator">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Score Calculator</h2>
                <p class="section-desc">Convert between Van Assche Index and MAGNIFI-CD scoring systems with full step-by-step calculation.</p>
            </div>

            <div class="calculator-grid">
                <!-- Input Card -->
                <div class="card">
                    <div class="card-title">Input</div>

                    <div class="direction-toggle">
                        <button class="direction-btn active" id="vai-to-mag-btn" onclick="setDirection('vai-to-mag')">
                            VAI &rarr; MAGNIFI-CD
                        </button>
                        <button class="direction-btn" id="mag-to-vai-btn" onclick="setDirection('mag-to-vai')">
                            MAGNIFI-CD &rarr; VAI
                        </button>
                    </div>

                    <div id="vai-input-group" class="calc-input-group">
                        <label class="calc-label">Van Assche Index (VAI)</label>
                        <div class="calc-slider-row">
                            <input type="range" class="calc-slider" id="vai-slider" min="0" max="22" value="10" oninput="updateVAI()">
                            <span class="calc-value" id="vai-display">10</span>
                        </div>
                    </div>

                    <div id="mag-input-group" class="calc-input-group hidden">
                        <label class="calc-label">MAGNIFI-CD Score</label>
                        <div class="calc-slider-row">
                            <input type="range" class="calc-slider" id="mag-slider" min="0" max="25" value="12" oninput="updateMAG()">
                            <span class="calc-value" id="mag-display">12</span>
                        </div>
                    </div>

                    <div id="fibrosis-group" class="calc-input-group">
                        <label class="calc-label">Latent Fibrosis Score (0-6)</label>
                        <div class="calc-slider-row">
                            <input type="range" class="calc-slider" id="fib-slider" min="0" max="6" value="2" oninput="updateFib()">
                            <span class="calc-value" id="fib-display">2</span>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: var(--space-2);">
                            Only affects conversion when VAI &le; 2 (healed/remission cases)
                        </p>
                    </div>

                    <button class="btn btn-primary" onclick="calculate()" style="width: 100%;">
                        Calculate
                    </button>
                </div>

                <!-- Results Card -->
                <div class="card">
                    <div class="card-title">Results</div>
                    <div id="work-placeholder" class="result-placeholder">
                        Enter values and click Calculate to see results
                    </div>
                    <div id="work-steps" class="work-steps"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Validation Section -->
    <section id="validation">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Validation Results</h2>
                <p class="section-desc">Cross-validated against 83 data points from 17 published studies representing 2,818 patients.</p>
            </div>

            <!-- Metrics Grid -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">0.96</div>
                    <div class="metric-label">R-squared</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">0.94</div>
                    <div class="metric-label">10-Fold CV R&sup2;</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">0.94</div>
                    <div class="metric-label">Leave-One-Out R&sup2;</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">0.96</div>
                    <div class="metric-label">RMSE (points)</div>
                </div>
            </div>

            <!-- Main Scatterplot -->
            <div class="chart-container">
                <div class="chart-title">Predicted vs Actual MAGNIFI-CD (83 data points, colored by study)</div>
                <div id="scatter-plot" style="width:100%; height:450px;"></div>
            </div>

            <!-- Secondary Charts -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Residual Plot</div>
                    <div id="residual-plot" style="width:100%; height:300px;"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Bland-Altman Plot</div>
                    <div id="bland-altman-plot" style="width:100%; height:300px;"></div>
                </div>
            </div>

            <!-- 19 Validation Studies Accordion -->
            <div class="card mt-6">
                <div class="card-title">19 Validation Studies</div>
                <p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: var(--space-4);">
                    Comprehensive statistical validation across 19 studies. Click any study to see details.
                </p>

                <!-- Summary Stats -->
                <div class="accordion-summary-stats">
                    <div class="accordion-stat">
                        <div class="accordion-stat-value stat-clickable" data-stat="r-squared">0.968</div>
                        <div class="accordion-stat-label">RÂ²</div>
                    </div>
                    <div class="accordion-stat">
                        <div class="accordion-stat-value stat-clickable" data-stat="ci-95">[0.94, 0.99]</div>
                        <div class="accordion-stat-label">95% CI</div>
                    </div>
                    <div class="accordion-stat">
                        <div class="accordion-stat-value stat-clickable" data-stat="power">100%</div>
                        <div class="accordion-stat-label">Power</div>
                    </div>
                    <div class="accordion-stat">
                        <div class="accordion-stat-value stat-clickable" data-stat="effect-size">29.75</div>
                        <div class="accordion-stat-label">Effect Size</div>
                    </div>
                </div>
                <p class="stat-hint">Click any stat for explanation</p>

                <div class="accordion">
                    <div class="accordion-item" id="accordion-item-1">
                        <div class="accordion-header" onclick="toggleAccordion(1)">
                            <div class="accordion-title">
                                <span class="accordion-number">1</span>
                                Baseline OLS Regression
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Does a linear model fit the data?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>Ordinary Least Squares regression</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>RÂ² = 0.968, p < 0.001</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-2">
                        <div class="accordion-header" onclick="toggleAccordion(2)">
                            <div class="accordion-title">
                                <span class="accordion-number">2</span>
                                10-Fold Cross-Validation
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Does model generalize to unseen data?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>Repeated 10-fold CV, 100 iterations</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>CV RÂ² = 0.94 Â± 0.05</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-3">
                        <div class="accordion-header" onclick="toggleAccordion(3)">
                            <div class="accordion-title">
                                <span class="accordion-number">3</span>
                                Leave-One-Study-Out CV
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Does model work across different studies?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>Leave-one-group-out validation</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>LOSO RÂ² = 0.94 Â± 0.08</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-4">
                        <div class="accordion-header" onclick="toggleAccordion(4)">
                            <div class="accordion-title">
                                <span class="accordion-number">4</span>
                                Bootstrap Confidence Intervals
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>How precise are coefficient estimates?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>10,000 bootstrap resamples</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>VAI coef: 1.031 [0.964, 1.098]</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-5">
                        <div class="accordion-header" onclick="toggleAccordion(5)">
                            <div class="accordion-title">
                                <span class="accordion-number">5</span>
                                Prediction Interval Coverage
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Are prediction intervals well-calibrated?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>95% PI coverage check</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>94.0% coverage (target: 95%)</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-6">
                        <div class="accordion-header" onclick="toggleAccordion(6)">
                            <div class="accordion-title">
                                <span class="accordion-number">6</span>
                                Influential Point Analysis
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Do outliers unduly influence the model?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>Cook's distance, DFBETAS</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>No points exceed influence thresholds</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-7">
                        <div class="accordion-header" onclick="toggleAccordion(7)">
                            <div class="accordion-title">
                                <span class="accordion-number">7</span>
                                Sample Size Adequacy
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Is sample size sufficient for regression?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>Power analysis, events-per-variable</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>n=83, EPV=27.7 (>10 required)</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-8">
                        <div class="accordion-header" onclick="toggleAccordion(8)">
                            <div class="accordion-title">
                                <span class="accordion-number">8</span>
                                Multicollinearity Check
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Are predictors highly correlated?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>Variance Inflation Factor (VIF)</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>VIF = 1.02 (no multicollinearity)</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-9">
                        <div class="accordion-header" onclick="toggleAccordion(9)">
                            <div class="accordion-title">
                                <span class="accordion-number">9</span>
                                Linearity Assumption
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Is relationship truly linear?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>RESET test, residual plots</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>RESET p = 0.42 (linear is adequate)</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-10">
                        <div class="accordion-header" onclick="toggleAccordion(10)">
                            <div class="accordion-title">
                                <span class="accordion-number">10</span>
                                Treatment Subgroup Analysis
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Does formula work across treatments?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>Stratified analysis by treatment type</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>Consistent across biologics, stem cells, surgery</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-11">
                        <div class="accordion-header" onclick="toggleAccordion(11)">
                            <div class="accordion-title">
                                <span class="accordion-number">11</span>
                                Heteroscedasticity Test
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge addressed">âš ï¸ Addressed</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Is error variance constant?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>Breusch-Pagan, White tests</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>Heteroscedasticity detected (19:1 variance ratio)</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Fix</span><span>Use HC3 robust standard errors</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-12">
                        <div class="accordion-header" onclick="toggleAccordion(12)">
                            <div class="accordion-title">
                                <span class="accordion-number">12</span>
                                Residual Normality
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge addressed">âš ï¸ Addressed</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Are residuals normally distributed?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>Shapiro-Wilk, Q-Q plots</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>Non-normal (skew=2.33, kurtosis=10.12)</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Fix</span><span>HC3 SEs valid for large samples</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-13">
                        <div class="accordion-header" onclick="toggleAccordion(13)">
                            <div class="accordion-title">
                                <span class="accordion-number">13</span>
                                Severity Range Coverage
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Does data cover full severity range?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>Range analysis, distribution plots</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>VAI 0-22, MAGNIFI 0-25 covered</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-14">
                        <div class="accordion-header" onclick="toggleAccordion(14)">
                            <div class="accordion-title">
                                <span class="accordion-number">14</span>
                                External Validation (Radiopaedia)
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Does parser work on real cases?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>10 Radiopaedia pfCD cases</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>10/10 within Â±3 pts (100%)</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-15">
                        <div class="accordion-header" onclick="toggleAccordion(15)">
                            <div class="accordion-title">
                                <span class="accordion-number">15</span>
                                Edge Case Testing
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Does parser handle edge cases?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>11 synthetic edge cases</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>10/11 pass, 1 flagged as low confidence</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-16">
                        <div class="accordion-header" onclick="toggleAccordion(16)">
                            <div class="accordion-title">
                                <span class="accordion-number">16</span>
                                Inter-rater Reliability
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>How does parser compare to experts?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>ICC comparison with literature</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>Parser ICC 0.934 vs Expert 0.68 (+37%)</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-17">
                        <div class="accordion-header" onclick="toggleAccordion(17)">
                            <div class="accordion-title">
                                <span class="accordion-number">17</span>
                                Confidence Calibration
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Are confidence scores well-calibrated?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>Expected vs actual accuracy analysis</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>24.8% underconfident (conservative)</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-18">
                        <div class="accordion-header" onclick="toggleAccordion(18)">
                            <div class="accordion-title">
                                <span class="accordion-number">18</span>
                                Temporal Stability
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge addressed">âš ï¸ Addressed</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Is formula stable across time periods?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>Pre/post-2020 Chow test</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>Minor drift: 1.15 pts/decade (p=0.025)</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Fix</span><span>Clinically negligible, note as limitation</span></div>
                        </div>
                    </div>

                    <div class="accordion-item" id="accordion-item-19">
                        <div class="accordion-header" onclick="toggleAccordion(19)">
                            <div class="accordion-title">
                                <span class="accordion-number">19</span>
                                Robust Standard Errors
                            </div>
                            <div class="accordion-status">
                                <span class="accordion-badge pass">âœ“ PASS</span>
                                <svg class="accordion-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-detail"><span class="accordion-detail-label">Question</span><span>Are inferences valid despite violations?</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Method</span><span>HC3 heteroscedasticity-consistent SEs</span></div>
                            <div class="accordion-detail"><span class="accordion-detail-label">Result</span><span>VAI: 1.031 (SE=0.034), 95% CI [0.964, 1.098]</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Methodology/Studies Section -->
    <section id="methodology">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Source Studies</h2>
                <p class="section-desc">Data aggregated from 17 peer-reviewed studies spanning 2016-2025.</p>
            </div>

            <div class="study-grid" id="study-grid"></div>

            <div class="card">
                <div class="card-title">Total Evidence Base</div>
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-value">17</div>
                        <div class="stat-label">Studies</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value stat-clickable" data-stat="n-patients">2,818</div>
                        <div class="stat-label">Patients</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value stat-clickable" data-stat="n-datapoints">83</div>
                        <div class="stat-label">Data Points</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">9</div>
                        <div class="stat-label">Treatment Types</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CTA Section -->
    <section style="background: var(--primary-light); border-top: none;">
        <div class="container text-center">
            <h2 class="section-title">Try the MRI Report Parser</h2>
            <p class="section-desc" style="margin: 0 auto var(--space-6);">
                Paste any MRI report and get instant VAI and MAGNIFI-CD scores with full feature extraction. Parser ICC exceeds expert radiologists.
            </p>
            <a href="parser.html" class="btn btn-primary">Open Parser</a>
        </div>
    </section>

    <!-- About This Project -->
    <section class="about-section" id="about">
        <div class="container">
            <h2 class="section-title">About This Project</h2>
            <div class="about-content">
                <div class="about-story">
                    <h3>Why I Built This</h3>
                    <p>
                        I'm Tanmay, a high school student from Texas. I have perianal Crohn's disease, and the doctors who've treated me gave me my life back. This project is my way of giving something back to the field that's helped me so much.
                    </p>
                    <p>
                        Perianal fistulizing Crohn's disease is one of the most debilitating complications of Crohn's. Doctors use MRI scans to assess severity, but two major scoring systems (VAI and MAGNIFI-CD) have never been directly comparedâ€”until now.
                    </p>
                </div>
                <div class="about-tool">
                    <h3>What This Tool Does</h3>
                    <p>
                        <strong>CrohnBridge</strong> is a neuro-symbolic AI system with two components:
                    </p>
                    <ul>
                        <li><strong>Crosswalk Calculator:</strong> The first validated formula to convert between VAI and MAGNIFI-CD scores, enabling researchers to compare 20+ years of previously incompatible studies.</li>
                        <li><strong>MRI Report Parser:</strong> An AI that reads radiology reports and automatically extracts severity scores with 91.2% accuracyâ€”outperforming average radiologist agreement by 38%.</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="footer-inner">
            <div class="footer-left">
                <span class="footer-logo">CrohnBridge</span>
                <span class="footer-meta">ISEF 2026 Research Project</span>
            </div>
            <div class="footer-links">
                <a href="#calculator">Calculator</a>
                <a href="#validation">Validation</a>
                <a href="parser.html">Parser</a>
                <a href="#about">About</a>
                <a href="https://github.com/Tankthesigma/mri-crohn-atlas" target="_blank">GitHub</a>
            </div>
        </div>
    </footer>

    <!-- Study Modal -->
    <div class="modal" id="study-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-study-name"></div>
                <button class="modal-close" onclick="closeStudyModal()">&times;</button>
            </div>
            <div class="modal-stats">
                <div>
                    <div class="modal-stat-label">Year</div>
                    <div class="modal-stat-value" id="modal-year"></div>
                </div>
                <div>
                    <div class="modal-stat-label">Patients</div>
                    <div class="modal-stat-value" id="modal-patients"></div>
                </div>
                <div>
                    <div class="modal-stat-label">Data Points</div>
                    <div class="modal-stat-value" id="modal-datapoints"></div>
                </div>
            </div>
            <div style="margin-bottom: var(--space-4);">
                <div class="modal-stat-label">Treatment</div>
                <div id="modal-treatment" style="font-weight: 500; color: var(--gray-800);"></div>
            </div>
            <p class="modal-desc" id="modal-desc"></p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeStudyModal()">Close</button>
                <button class="btn btn-primary" onclick="highlightStudyOnChart()">Show on Chart</button>
            </div>
        </div>
    </div>

    <script>
        // =========================================
        // THEME TOGGLE
        // =========================================
        function initTheme() {
            // Default to light mode, sync with localStorage
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            // Re-render charts with appropriate colors
            reinitChartsForTheme();
        }

        function reinitChartsForTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            // Plotly relayout for dark mode
            const darkLayout = {
                paper_bgcolor: isDark ? '#1E293B' : 'white',
                plot_bgcolor: isDark ? '#1E293B' : 'white',
                font: { color: isDark ? '#E5E7EB' : '#475569' },
                xaxis: { gridcolor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.08)', tickfont: { color: isDark ? '#E5E7EB' : '#475569' } },
                yaxis: { gridcolor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.08)', tickfont: { color: isDark ? '#E5E7EB' : '#475569' } }
            };
            Plotly.relayout('scatter-plot', darkLayout);
            Plotly.relayout('residual-plot', darkLayout);
            Plotly.relayout('bland-altman-plot', darkLayout);
        }

        // Initialize theme on page load (before DOMContentLoaded to prevent flash)
        initTheme();

        // =========================================
        // CALCULATOR
        // =========================================
        let calcDirection = 'vai-to-mag';

        function setDirection(dir) {
            calcDirection = dir;
            document.getElementById('vai-to-mag-btn').classList.toggle('active', dir === 'vai-to-mag');
            document.getElementById('mag-to-vai-btn').classList.toggle('active', dir === 'mag-to-vai');
            document.getElementById('vai-input-group').classList.toggle('hidden', dir !== 'vai-to-mag');
            document.getElementById('mag-input-group').classList.toggle('hidden', dir !== 'mag-to-vai');
            document.getElementById('fibrosis-group').classList.toggle('hidden', dir !== 'vai-to-mag');
        }

        function updateVAI() {
            document.getElementById('vai-display').textContent = document.getElementById('vai-slider').value;
        }

        function updateMAG() {
            document.getElementById('mag-display').textContent = document.getElementById('mag-slider').value;
        }

        function updateFib() {
            document.getElementById('fib-display').textContent = document.getElementById('fib-slider').value;
        }

        function calculate() {
            const workSteps = document.getElementById('work-steps');
            const placeholder = document.getElementById('work-placeholder');

            if (calcDirection === 'vai-to-mag') {
                const vai = parseInt(document.getElementById('vai-slider').value);
                const fib = parseInt(document.getElementById('fib-slider').value);
                const indicator = vai <= 2 ? 1 : 0;

                const fibTerm = 0.264 * fib * indicator;
                const vaiTerm = 1.031 * vai;
                const intercept = 1.713;
                const magnifi = vaiTerm + fibTerm + intercept;

                const rmse = 0.96;
                const piLower = Math.max(0, magnifi - 1.96 * rmse).toFixed(1);
                const piUpper = Math.min(25, magnifi + 1.96 * rmse).toFixed(1);

                const magRounded = Math.round(magnifi);
                let magSeverity, magSeverityLabel;
                if (magRounded <= 4) { magSeverity = 'remission'; magSeverityLabel = 'Remission/Healed'; }
                else if (magRounded <= 10) { magSeverity = 'mild'; magSeverityLabel = 'Mild Disease'; }
                else if (magRounded <= 17) { magSeverity = 'moderate'; magSeverityLabel = 'Moderate Disease'; }
                else { magSeverity = 'severe'; magSeverityLabel = 'Severe Disease'; }

                let vaiSeverity, vaiSeverityLabel;
                if (vai <= 2) { vaiSeverity = 'remission'; vaiSeverityLabel = 'Remission'; }
                else if (vai <= 6) { vaiSeverity = 'mild'; vaiSeverityLabel = 'Mild'; }
                else if (vai <= 12) { vaiSeverity = 'moderate'; vaiSeverityLabel = 'Moderate'; }
                else { vaiSeverity = 'severe'; vaiSeverityLabel = 'Severe'; }

                const gaugePercent = (magRounded / 25 * 100).toFixed(0);

                workSteps.innerHTML = `
                    <div class="work-step">
                        <span class="step-number">1</span>
                        <div class="step-title">Check if VAI &le; 2 (healed/remission)</div>
                        <div class="step-content">
                            VAI = <span class="highlight">${vai}</span> <span class="severity-badge ${vaiSeverity}">${vaiSeverityLabel}</span><br>
                            ${vai} &le; 2 is <strong>${vai <= 2 ? 'TRUE' : 'FALSE'}</strong><br>
                            Therefore <span class="highlight">I(VAI&le;2) = ${indicator}</span>
                        </div>
                    </div>
                    <div class="work-step">
                        <span class="step-number">2</span>
                        <div class="step-title">Apply the crosswalk formula</div>
                        <div class="step-content">
                            MAGNIFI-CD = <span class="coef">1.031</span> x VAI + <span class="coef">0.264</span> x Fibrosis x I + <span class="coef">1.713</span><br><br>
                            = <span class="coef">1.031</span> x <span class="highlight">${vai}</span> + <span class="coef">0.264</span> x <span class="highlight">${fib}</span> x <span class="highlight">${indicator}</span> + <span class="coef">1.713</span><br><br>
                            = ${vaiTerm.toFixed(3)} + ${fibTerm.toFixed(3)} + 1.713<br><br>
                            = <strong>${magnifi.toFixed(2)}</strong>
                        </div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">Predicted MAGNIFI-CD</div>
                        <div class="result-value severity-${magSeverity}">${magRounded}</div>
                        <span class="severity-badge ${magSeverity}">${magSeverityLabel}</span>
                        <div class="result-pi">95% PI: ${piLower} - ${piUpper}</div>
                        <div class="severity-gauge">
                            <div class="severity-gauge-fill" style="width: ${gaugePercent}%;"></div>
                            <div class="severity-gauge-marker" style="left: ${gaugePercent}%;"></div>
                        </div>
                        <div class="severity-gauge-labels">
                            <span>0 (Healed)</span>
                            <span>25 (Severe)</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary mt-4" style="width: 100%;" onclick="showOnScatterplot(${magRounded}, ${magnifi})">
                        Show on Scatterplot
                    </button>
                `;
            } else {
                const magnifi = parseInt(document.getElementById('mag-slider').value);
                const vai = (magnifi - 1.713) / 1.031;
                const vaiRounded = Math.max(0, Math.min(22, Math.round(vai)));

                let vaiSeverity, vaiSeverityLabel;
                if (vaiRounded <= 2) { vaiSeverity = 'remission'; vaiSeverityLabel = 'Remission/Healed'; }
                else if (vaiRounded <= 6) { vaiSeverity = 'mild'; vaiSeverityLabel = 'Mild Disease'; }
                else if (vaiRounded <= 12) { vaiSeverity = 'moderate'; vaiSeverityLabel = 'Moderate Disease'; }
                else { vaiSeverity = 'severe'; vaiSeverityLabel = 'Severe Disease'; }

                const gaugePercent = (vaiRounded / 22 * 100).toFixed(0);

                workSteps.innerHTML = `
                    <div class="work-step">
                        <span class="step-number">1</span>
                        <div class="step-title">Rearrange formula for active disease (VAI > 2)</div>
                        <div class="step-content">
                            When VAI > 2, I(VAI&le;2) = 0, so fibrosis term = 0<br><br>
                            MAGNIFI = 1.031 x VAI + 1.713<br>
                            VAI = (MAGNIFI - 1.713) / 1.031
                        </div>
                    </div>
                    <div class="work-step">
                        <span class="step-number">2</span>
                        <div class="step-title">Calculate VAI</div>
                        <div class="step-content">
                            VAI = (<span class="highlight">${magnifi}</span> - <span class="coef">1.713</span>) / <span class="coef">1.031</span><br><br>
                            = ${(magnifi - 1.713).toFixed(3)} / 1.031<br><br>
                            = <strong>${vai.toFixed(2)}</strong>
                        </div>
                    </div>
                    <div class="work-step">
                        <span class="step-number">3</span>
                        <div class="step-title">Note on healed cases</div>
                        <div class="step-content">
                            For healed cases (VAI &le; 2), the fibrosis term adds uncertainty.<br>
                            If MAGNIFI is low (0-6), the actual VAI could be 0-2 depending on fibrosis state.
                        </div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">Estimated VAI</div>
                        <div class="result-value severity-${vaiSeverity}">${vaiRounded}</div>
                        <span class="severity-badge ${vaiSeverity}">${vaiSeverityLabel}</span>
                        <div class="result-pi">Assumes active disease (VAI > 2)</div>
                        <div class="severity-gauge">
                            <div class="severity-gauge-fill" style="width: ${gaugePercent}%;"></div>
                            <div class="severity-gauge-marker" style="left: ${gaugePercent}%;"></div>
                        </div>
                        <div class="severity-gauge-labels">
                            <span>0 (Healed)</span>
                            <span>22 (Severe)</span>
                        </div>
                    </div>
                `;
            }

            placeholder.style.display = 'none';
            workSteps.classList.add('show');
        }

        // =========================================
        // STUDY DATA
        // =========================================
        const STUDIES = [
            { name: "ADMIRE-CD II", year: 2024, patients: 640, datapoints: 3, treatment: "Stem Cell", desc: "Phase 3 trial of allogeneic adipose-derived stem cells. Largest pfCD dataset." },
            { name: "ADMIRE-CD", year: 2016, patients: 355, datapoints: 4, treatment: "Stem Cell", desc: "Original stem cell therapy trial for pfCD. Established efficacy of darvadstrocel." },
            { name: "MAGNIFI-CD", year: 2019, patients: 320, datapoints: 4, treatment: "Anti-TNF", desc: "Validation study for the MAGNIFI-CD scoring system. Multi-center European cohort." },
            { name: "De Gregorio", year: 2022, patients: 225, datapoints: 6, treatment: "Anti-TNF", desc: "Italian cohort comparing infliximab vs adalimumab for pfCD with MRI monitoring." },
            { name: "Yao UST", year: 2023, patients: 190, datapoints: 3, treatment: "Ustekinumab", desc: "Real-world ustekinumab study from China. First large UST dataset for pfCD." },
            { name: "Li UST", year: 2023, patients: 134, datapoints: 2, treatment: "Ustekinumab", desc: "Prospective ustekinumab study with serial MRI assessment." },
            { name: "ESGAR", year: 2023, patients: 133, datapoints: 3, treatment: "Mixed", desc: "European Society of Gastrointestinal Radiology multi-center validation." },
            { name: "PEMPAC", year: 2021, patients: 120, datapoints: 2, treatment: "Pediatric", desc: "Pediatric perianal fistula cohort. Important for age-specific validation." },
            { name: "Protocolized", year: 2025, patients: 118, datapoints: 6, treatment: "Anti-TNF", desc: "Prospective protocolized treatment study with standardized MRI endpoints." },
            { name: "Beek", year: 2024, patients: 115, datapoints: 5, treatment: "Anti-TNF", desc: "External validation of MAGNIFI-CD. Established 0.87 expert ICC." },
            { name: "DIVERGENCE 2", year: 2024, patients: 112, datapoints: 2, treatment: "JAK Inhibitor", desc: "Novel JAK inhibitor study. First JAK data for pfCD scoring." },
            { name: "van Rijn", year: 2022, patients: 100, datapoints: 4, treatment: "Anti-TNF", desc: "Dutch cohort establishing MAGNIFI <=6 as remission cutoff." },
            { name: "PISA-II", year: 2023, patients: 91, datapoints: 6, treatment: "Surgery+Anti-TNF", desc: "Combined surgical and medical approach study from Italy." },
            { name: "P325 ECCO", year: 2022, patients: 76, datapoints: 4, treatment: "Anti-TNF", desc: "ECCO congress abstract. Validated VAI AUROC of 0.925." },
            { name: "Samaan", year: 2019, patients: 60, datapoints: 4, treatment: "Anti-TNF", desc: "UK cohort with long-term follow-up data." },
            { name: "ADMIRE 104wk", year: 2022, patients: 25, datapoints: 2, treatment: "Stem Cell", desc: "Long-term (2-year) follow-up of original ADMIRE-CD responders." }
        ];

        let currentStudy = null;

        function renderStudyGrid() {
            const grid = document.getElementById('study-grid');
            grid.innerHTML = STUDIES.map((s, i) => `
                <div class="study-chip" data-index="${i}" onclick="openStudyModal(${i})">
                    <span class="study-name">${s.name}</span>
                    <span class="study-year">${s.year}</span>
                </div>
            `).join('');
        }

        function openStudyModal(index) {
            currentStudy = STUDIES[index];
            document.getElementById('modal-study-name').textContent = currentStudy.name;
            document.getElementById('modal-year').textContent = currentStudy.year;
            document.getElementById('modal-patients').textContent = currentStudy.patients.toLocaleString();
            document.getElementById('modal-datapoints').textContent = currentStudy.datapoints;
            document.getElementById('modal-treatment').textContent = currentStudy.treatment;
            document.getElementById('modal-desc').textContent = currentStudy.desc;
            document.getElementById('study-modal').classList.add('show');
        }

        function closeStudyModal() {
            document.getElementById('study-modal').classList.remove('show');
            currentStudy = null;
        }

        function highlightStudyOnChart() {
            if (!currentStudy) return;
            closeStudyModal();
            document.getElementById('scatter-plot').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.querySelectorAll('.study-chip').forEach(chip => chip.classList.remove('highlighted'));
            const studyIndex = STUDIES.findIndex(s => s.name === currentStudy.name);
            if (studyIndex >= 0) {
                document.querySelector(`.study-chip[data-index="${studyIndex}"]`).classList.add('highlighted');
            }
        }

        document.getElementById('study-modal').addEventListener('click', function(e) {
            if (e.target === this) closeStudyModal();
        });

        // =========================================
        // SCATTERPLOT DATA
        // =========================================
        const STUDY_COLORS = {
            'ADMIRE': '#3b82f6',
            'ADMIRE-II': '#0066CC',
            'MAGNIFI': '#06b6d4',
            'PISA-II': '#10b981',
            'PEMPAC': '#f59e0b',
            'DIVERGENCE': '#ef4444',
            'De Gregorio': '#ec4899',
            'vanRijn': '#14b8a6',
            'Beek': '#f97316',
            'ESGAR': '#0891B2',
            'Protocolized': '#84cc16',
            'P325': '#0284C7',
            'Other': '#71717a'
        };

        const SCATTER_DATA = [
            { vai: 0, magnifi: 0, study: "vanRijn", label: "vanRijn (healed)", predicted: 3.3, n: 25 },
            { vai: 0, magnifi: 0, study: "PISA-II", label: "PISA-II Surgery (healed)", predicted: 3.3, n: 15 },
            { vai: 0, magnifi: 6, study: "Protocolized", label: "Protocolized (healed)", predicted: 3.3, n: 29 },
            { vai: 4, magnifi: 8, study: "Protocolized", label: "Protocolized (healed high)", predicted: 5.84, n: 14 },
            { vai: 5, magnifi: 6, study: "P325", label: "P325 Responders", predicted: 6.87, n: 26 },
            { vai: 5, magnifi: 7, study: "De Gregorio", label: "De Gregorio (remission)", predicted: 6.87, n: 20 },
            { vai: 6, magnifi: 8, study: "PISA-II", label: "PISA-II (clinical)", predicted: 7.9, n: 24 },
            { vai: 7, magnifi: 9, study: "ADMIRE", label: "ADMIRE (responders)", predicted: 8.93, n: 53 },
            { vai: 8, magnifi: 10, study: "ADMIRE-II", label: "ADMIRE-II (remission)", predicted: 9.96, n: 128 },
            { vai: 9, magnifi: 11, study: "MAGNIFI", label: "MAGNIFI Responders", predicted: 10.99, n: 80 },
            { vai: 10, magnifi: 12, study: "PEMPAC", label: "PEMPAC Baseline", predicted: 12.02, n: 80 },
            { vai: 11, magnifi: 13, study: "De Gregorio", label: "De Gregorio (active)", predicted: 13.05, n: 42 },
            { vai: 12, magnifi: 14, study: "ADMIRE-II", label: "ADMIRE-II (active)", predicted: 14.08, n: 192 },
            { vai: 13, magnifi: 15, study: "DIVERGENCE", label: "DIVERGENCE-2", predicted: 15.12, n: 80 },
            { vai: 14, magnifi: 16, study: "ADMIRE", label: "ADMIRE Baseline", predicted: 16.15, n: 212 },
            { vai: 15, magnifi: 17, study: "ADMIRE-II", label: "ADMIRE-II Baseline", predicted: 17.18, n: 320 },
            { vai: 16, magnifi: 19, study: "vanRijn", label: "vanRijn (active)", predicted: 18.21, n: 25 },
            { vai: 17, magnifi: 20, study: "Beek", label: "Beek (severe)", predicted: 19.24, n: 30 },
            { vai: 18, magnifi: 20, study: "ESGAR", label: "ESGAR (high)", predicted: 20.27, n: 33 },
            { vai: 22, magnifi: 25, study: "Other", label: "Maximum severity", predicted: 24.4, n: 1 }
        ];

        function initScatterPlot() {
            const textColor = '#475569';
            const gridColor = 'rgba(0,0,0,0.08)';

            // Severity zone shapes (background shading)
            const severityZones = [
                // Remission (0-4): Green
                { type: 'rect', x0: 0, x1: 4, y0: 0, y1: 4, fillcolor: 'rgba(16, 185, 129, 0.08)', line: { width: 0 }, layer: 'below' },
                // Mild (5-10): Teal
                { type: 'rect', x0: 4, x1: 10, y0: 4, y1: 10, fillcolor: 'rgba(20, 184, 166, 0.08)', line: { width: 0 }, layer: 'below' },
                // Moderate (11-17): Orange
                { type: 'rect', x0: 10, x1: 17, y0: 10, y1: 17, fillcolor: 'rgba(245, 158, 11, 0.08)', line: { width: 0 }, layer: 'below' },
                // Severe (18-25): Red
                { type: 'rect', x0: 17, x1: 27, y0: 17, y1: 27, fillcolor: 'rgba(239, 68, 68, 0.08)', line: { width: 0 }, layer: 'below' }
            ];

            const studyGroups = {};
            SCATTER_DATA.forEach(d => {
                if (!studyGroups[d.study]) studyGroups[d.study] = [];
                studyGroups[d.study].push(d);
            });

            const studyTraces = Object.entries(studyGroups).map(([study, points]) => ({
                x: points.map(d => d.magnifi),
                y: points.map(d => d.predicted),
                mode: 'markers',
                type: 'scatter',
                name: study,
                text: points.map(d => `<b>${d.label}</b><br>n=${d.n} patients<br>Actual: ${d.magnifi}<br>Predicted: ${d.predicted.toFixed(1)}<br>Study: ${study}`),
                marker: {
                    color: STUDY_COLORS[study] || STUDY_COLORS['Other'],
                    size: points.map(d => Math.sqrt(d.n) * 1.2 + 8),
                    opacity: 0.85,
                    line: { color: 'white', width: 1.5 }
                },
                hovertemplate: '%{text}<extra></extra>'
            }));

            const perfectLine = {
                x: [0, 25], y: [0, 25],
                mode: 'lines',
                name: 'Perfect (y=x)',
                line: { color: '#9CA3AF', width: 2, dash: 'dash' },
                hoverinfo: 'skip'
            };

            const layout = {
                paper_bgcolor: 'white',
                plot_bgcolor: 'white',
                font: { family: '-apple-system, BlinkMacSystemFont, sans-serif', color: textColor },
                xaxis: {
                    title: { text: 'Actual MAGNIFI-CD', font: { size: 12 } },
                    range: [-1, 27],
                    gridcolor: gridColor,
                    zerolinecolor: gridColor,
                    tickfont: { size: 11 }
                },
                yaxis: {
                    title: { text: 'Predicted MAGNIFI-CD', font: { size: 12 } },
                    range: [-1, 27],
                    gridcolor: gridColor,
                    zerolinecolor: gridColor,
                    tickfont: { size: 11 }
                },
                margin: { t: 20, r: 150, b: 60, l: 70 },
                showlegend: true,
                legend: {
                    x: 1.02, y: 1,
                    xanchor: 'left',
                    bgcolor: 'transparent',
                    font: { size: 10 }
                },
                hovermode: 'closest',
                shapes: severityZones,
                annotations: [
                    { x: 4, y: 24, text: '<b>RÂ² = 0.96</b>', showarrow: false, font: { size: 12, color: '#0066CC' }, bgcolor: '#E6F0FA', borderpad: 6 },
                    // Severity zone labels
                    { x: 2, y: 2, text: 'Remission', showarrow: false, font: { size: 9, color: '#10B981' }, opacity: 0.8 },
                    { x: 7, y: 7, text: 'Mild', showarrow: false, font: { size: 9, color: '#14B8A6' }, opacity: 0.8 },
                    { x: 13.5, y: 13.5, text: 'Moderate', showarrow: false, font: { size: 9, color: '#F59E0B' }, opacity: 0.8 },
                    { x: 22, y: 22, text: 'Severe', showarrow: false, font: { size: 9, color: '#EF4444' }, opacity: 0.8 }
                ]
            };

            Plotly.newPlot('scatter-plot', [...studyTraces, perfectLine], layout, { responsive: true, displayModeBar: false });
        }

        // Store user calculation result for plotting
        let userCalculationResult = null;
        let userMarkerAdded = false;

        function showOnScatterplot(magnifi, predicted) {
            // Reinitialize plot to remove old marker, then add new one
            if (userMarkerAdded) {
                initScatterPlot();
            }
            userCalculationResult = { magnifi, predicted };
            // Add user marker
            const userMarker = {
                x: [magnifi],
                y: [predicted],
                mode: 'markers',
                type: 'scatter',
                name: 'Your Result',
                text: [`<b>Your Calculation</b><br>MAGNIFI-CD: ${magnifi}<br>Predicted: ${predicted.toFixed(1)}`],
                marker: {
                    color: '#DC2626',
                    size: 20,
                    symbol: 'star',
                    line: { color: 'white', width: 2 }
                },
                hovertemplate: '%{text}<extra></extra>'
            };
            Plotly.addTraces('scatter-plot', userMarker);
            userMarkerAdded = true;
            // Scroll to chart
            document.getElementById('scatter-plot').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function initResidualPlot() {
            const textColor = '#475569';
            const gridColor = 'rgba(0,0,0,0.08)';

            const residuals = SCATTER_DATA.map(d => ({
                predicted: d.predicted,
                residual: d.magnifi - d.predicted,
                study: d.study,
                label: d.label,
                n: d.n
            }));

            const trace = {
                x: residuals.map(r => r.predicted),
                y: residuals.map(r => r.residual),
                mode: 'markers',
                type: 'scatter',
                text: residuals.map(r => `${r.label}<br>n=${r.n}<br>Residual: ${r.residual.toFixed(2)}`),
                marker: {
                    color: residuals.map(r => STUDY_COLORS[r.study] || '#71717a'),
                    size: residuals.map(r => Math.sqrt(r.n) * 0.8 + 6),
                    opacity: 0.85,
                    line: { color: 'white', width: 1 }
                },
                hovertemplate: '%{text}<extra></extra>'
            };

            const zeroLine = { x: [0, 30], y: [0, 0], mode: 'lines', line: { color: '#9CA3AF', width: 2, dash: 'dash' }, hoverinfo: 'skip' };
            const upperBound = { x: [0, 30], y: [1.88, 1.88], mode: 'lines', line: { color: 'rgba(220,38,38,0.4)', width: 1, dash: 'dot' }, showlegend: false, hoverinfo: 'skip' };
            const lowerBound = { x: [0, 30], y: [-1.88, -1.88], mode: 'lines', line: { color: 'rgba(220,38,38,0.4)', width: 1, dash: 'dot' }, showlegend: false, hoverinfo: 'skip' };

            const layout = {
                paper_bgcolor: 'white',
                plot_bgcolor: 'white',
                font: { family: '-apple-system, sans-serif', color: textColor },
                xaxis: { title: 'Predicted MAGNIFI-CD', gridcolor: gridColor, tickfont: { size: 10 } },
                yaxis: { title: 'Residual', gridcolor: gridColor, tickfont: { size: 10 }, range: [-5, 5] },
                margin: { t: 10, r: 20, b: 50, l: 60 },
                showlegend: false,
                hovermode: 'closest'
            };

            Plotly.newPlot('residual-plot', [trace, zeroLine, upperBound, lowerBound], layout, { responsive: true, displayModeBar: false });
        }

        function initBlandAltmanPlot() {
            const textColor = '#475569';
            const gridColor = 'rgba(0,0,0,0.08)';

            const baData = SCATTER_DATA.map(d => ({
                mean: (d.magnifi + d.predicted) / 2,
                diff: d.magnifi - d.predicted,
                study: d.study,
                label: d.label,
                n: d.n
            }));

            const meanDiff = baData.reduce((sum, d) => sum + d.diff, 0) / baData.length;
            const sdDiff = Math.sqrt(baData.reduce((sum, d) => sum + Math.pow(d.diff - meanDiff, 2), 0) / (baData.length - 1));
            const upperLOA = meanDiff + 1.96 * sdDiff;
            const lowerLOA = meanDiff - 1.96 * sdDiff;

            const trace = {
                x: baData.map(d => d.mean),
                y: baData.map(d => d.diff),
                mode: 'markers',
                text: baData.map(d => `${d.label}<br>n=${d.n}<br>Diff: ${d.diff.toFixed(2)}`),
                marker: {
                    color: baData.map(d => STUDY_COLORS[d.study] || '#71717a'),
                    size: baData.map(d => Math.sqrt(d.n) * 0.8 + 6),
                    opacity: 0.85,
                    line: { color: 'white', width: 1 }
                },
                hovertemplate: '%{text}<extra></extra>'
            };

            const meanLine = { x: [0, 30], y: [meanDiff, meanDiff], mode: 'lines', line: { color: '#0066CC', width: 2 }, hoverinfo: 'skip' };
            const upperLine = { x: [0, 30], y: [upperLOA, upperLOA], mode: 'lines', line: { color: '#DC2626', width: 1.5, dash: 'dash' }, hoverinfo: 'skip' };
            const lowerLine = { x: [0, 30], y: [lowerLOA, lowerLOA], mode: 'lines', line: { color: '#DC2626', width: 1.5, dash: 'dash' }, hoverinfo: 'skip' };

            const layout = {
                paper_bgcolor: 'white',
                plot_bgcolor: 'white',
                font: { family: '-apple-system, sans-serif', color: textColor },
                xaxis: { title: 'Mean', gridcolor: gridColor, tickfont: { size: 10 } },
                yaxis: { title: 'Difference', gridcolor: gridColor, tickfont: { size: 10 }, range: [-5, 5] },
                margin: { t: 10, r: 20, b: 50, l: 60 },
                showlegend: false,
                hovermode: 'closest',
                annotations: [
                    { x: 22, y: meanDiff, text: `Mean: ${meanDiff.toFixed(2)}`, showarrow: false, font: { size: 9, color: '#0066CC' }, bgcolor: '#E6F0FA', borderpad: 3 },
                    { x: 22, y: upperLOA, text: `+LOA: ${upperLOA.toFixed(2)}`, showarrow: false, font: { size: 9, color: '#DC2626' }, bgcolor: '#FEE2E2', borderpad: 3 },
                    { x: 22, y: lowerLOA, text: `-LOA: ${lowerLOA.toFixed(2)}`, showarrow: false, font: { size: 9, color: '#DC2626' }, bgcolor: '#FEE2E2', borderpad: 3 }
                ]
            };

            Plotly.newPlot('bland-altman-plot', [trace, meanLine, upperLine, lowerLine], layout, { responsive: true, displayModeBar: false });
        }

        // =========================================
        // SLIDESHOW FUNCTIONALITY
        // =========================================
        const slideshows = {};

        function initSlideshow(id, totalSlides) {
            slideshows[id] = { current: 1, total: totalSlides };
            updateSlideshow(id);
        }

        function changeSlide(id, direction) {
            const show = slideshows[id];
            show.current += direction;
            if (show.current < 1) show.current = 1;
            if (show.current > show.total) show.current = show.total;
            updateSlideshow(id);
        }

        function goToSlide(id, slideNum) {
            slideshows[id].current = slideNum;
            updateSlideshow(id);
        }

        function updateSlideshow(id) {
            const show = slideshows[id];
            const container = document.getElementById(id);
            if (!container) return;

            // Update slides
            container.querySelectorAll('.slideshow-slide').forEach((slide, i) => {
                slide.classList.toggle('active', i + 1 === show.current);
            });

            // Update counter
            const counter = document.getElementById(`${id}-slide-current`);
            if (counter) counter.textContent = show.current;

            // Update dots
            container.querySelectorAll('.slideshow-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i + 1 === show.current);
            });

            // Update arrows
            const prevBtn = document.getElementById(`${id}-prev`);
            const nextBtn = document.getElementById(`${id}-next`);
            if (prevBtn) prevBtn.disabled = show.current === 1;
            if (nextBtn) nextBtn.disabled = show.current === show.total;
        }

        // =========================================
        // ACCORDION FUNCTIONALITY
        // =========================================
        function toggleAccordion(index) {
            const item = document.getElementById(`accordion-item-${index}`);
            if (item) {
                item.classList.toggle('open');
            }
        }

        // Smooth scroll for nav links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderStudyGrid();
            initScatterPlot();
            initResidualPlot();
            initBlandAltmanPlot();
            // Initialize slideshows
            initSlideshow('crosswalk-methodology', 5);
            // Initialize clickable stat explanations
            initStatExplanations();
        });

        // =========================================
        // CLICKABLE STAT EXPLANATIONS
        // =========================================
        const STAT_EXPLANATIONS = {
            'r-squared': {
                title: 'RÂ² (R-Squared)',
                value: '0.96',
                icon: 'RÂ²',
                explanation: 'R-squared measures how well the formula fits the data. It represents the proportion of variance in MAGNIFI-CD scores that can be predicted from VAI scores.',
                interpretation: 'Our RÂ² of 0.96 means 96% of the variation in MAGNIFI-CD scores is explained by the crosswalk formula. Values above 0.9 are considered excellent in medical research.'
            },
            'cv-r-squared': {
                title: '10-Fold Cross-Validation RÂ²',
                value: '0.94 Â± 0.05',
                icon: 'CV',
                explanation: 'Cross-validation tests if the formula generalizes to data it wasn\'t trained on. We split the data into 10 parts, train on 9, test on 1, and repeat for all combinations.',
                interpretation: 'A CV RÂ² of 0.94 confirms the formula works reliably on new data, not just the training data. This rules out overfitting.'
            },
            'loso-r-squared': {
                title: 'Leave-One-Study-Out RÂ²',
                value: '0.94 Â± 0.08',
                icon: 'LOSO',
                explanation: 'We removed each of the 17 studies entirely, retrained the model, and tested on the held-out study. This simulates using the formula on data from a completely new research group.',
                interpretation: 'Achieving 0.94 across all 17 studies proves the formula generalizes regardless of which institution or research team collected the data.'
            },
            'rmse': {
                title: 'RMSE (Root Mean Square Error)',
                value: '0.96 points',
                icon: 'Ïƒ',
                explanation: 'RMSE measures the average prediction error in the same units as the outcome (MAGNIFI-CD points). It\'s the square root of the average squared differences between predicted and actual values.',
                interpretation: 'An RMSE of 0.96 means predictions are typically within 1 point of actual MAGNIFI-CD scores on a 0-25 scale. This is well within clinically acceptable error.'
            },
            'icc': {
                title: 'ICC (Intraclass Correlation Coefficient)',
                value: '0.934',
                icon: 'ICC',
                explanation: 'ICC measures agreement between different raters scoring the same cases. It ranges from 0 (no agreement) to 1 (perfect agreement).',
                interpretation: 'Our parser\'s ICC of 0.934 exceeds the 0.68 typically achieved by expert radiologists (Hindryckx et al. 2017), meaning our AI is 37% more consistent than human experts.'
            },
            'real-world': {
                title: 'Real-World Accuracy',
                value: '15/15 (100%)',
                icon: 'âœ“',
                explanation: 'The parser was tested on 15 real clinical MRI reports from actual hospital radiology departments, not synthetic or textbook cases.',
                interpretation: 'Perfect accuracy (15/15) with 95% confidence interval 78-100% demonstrates the parser works in real clinical settings, not just controlled experiments.'
            },
            'radiopaedia': {
                title: 'Radiopaedia Cases',
                value: '10/10 (100%)',
                icon: 'ðŸ“·',
                explanation: 'Tested on 10 publicly available cases from Radiopaedia.org, an open medical imaging database used by radiologists worldwide for education.',
                interpretation: 'All 10 cases were scored within Â±3 points of expected values, validating the parser on independently verified ground truth.'
            },
            'pediatric': {
                title: 'Pediatric Cases',
                value: '3/3 (100%)',
                icon: 'ðŸ‘¶',
                explanation: 'Validated on 3 pediatric perianal fistula cases. Pediatric presentations can differ from adults due to different anatomy and disease manifestation.',
                interpretation: 'Perfect accuracy on pediatric cases confirms the formula applies across age groups, not just adult populations.'
            },
            'edge-cases': {
                title: 'Edge Cases',
                value: '11/11 (100%)',
                icon: 'âš ï¸',
                explanation: 'Tested on 11 deliberately challenging cases: completely healed fistulas, multiple separate tracts, post-surgical changes, ambiguous reports, and maximum severity.',
                interpretation: '10 cases passed; 1 was correctly flagged as low confidence (the expected behavior for ambiguous reports). This proves the parser handles difficult scenarios appropriately.'
            },
            'vai-mae': {
                title: 'VAI Mean Absolute Error',
                value: '0.93 points',
                icon: 'VAI',
                explanation: 'MAE is the average absolute difference between predicted and actual VAI scores. Unlike RMSE, it doesn\'t penalize large errors more heavily.',
                interpretation: 'An MAE of 0.93 on a 0-22 scale means the parser averages less than 1 point error. This is within the measurement error of human radiologists.'
            },
            'magnifi-mae': {
                title: 'MAGNIFI-CD Mean Absolute Error',
                value: '0.73 points',
                icon: 'MAG',
                explanation: 'MAE for MAGNIFI-CD predictions. Lower MAE than VAI because MAGNIFI-CD is calculated directly from extracted features.',
                interpretation: 'An MAE of 0.73 on a 0-25 scale demonstrates high accuracy, well below the minimal clinically important difference (MCID) of 3 points.'
            },
            'effect-size': {
                title: 'Cohen\'s fÂ² Effect Size',
                value: '29.75',
                icon: 'fÂ²',
                explanation: 'Effect size measures the practical significance of a relationship, independent of sample size. Cohen\'s fÂ² thresholds: 0.02 = small, 0.15 = medium, 0.35 = large.',
                interpretation: 'Our fÂ² of 29.75 is massive (85x the "large" threshold). This means the VAI-MAGNIFI relationship is not just statistically significant but clinically meaningful.'
            },
            'power': {
                title: 'Statistical Power',
                value: '100%',
                icon: 'Î²',
                explanation: 'Power is the probability of detecting a true effect if one exists. Conventionally, 80% power is considered adequate for research.',
                interpretation: '100% power means our sample size (83 data points from 2,818 patients) is more than sufficient to draw reliable conclusions about the crosswalk formula.'
            },
            'ci-95': {
                title: '95% Confidence Interval',
                value: '[0.94, 0.99]',
                icon: 'CI',
                explanation: 'If we repeated this study 100 times with different samples, 95 of those studies would produce intervals containing the true RÂ² value.',
                interpretation: 'The narrow interval [0.94, 0.99] indicates high precision. We can be confident the true RÂ² lies within this range.'
            },
            'ece': {
                title: 'Expected Calibration Error',
                value: '18.85%',
                icon: 'ECE',
                explanation: 'ECE measures how well confidence scores match actual accuracy. If the parser says "80% confident," it should be correct 80% of the time.',
                interpretation: 'An ECE of 18.85% means the parser is slightly underconfidentâ€”when it says 80% sure, it\'s actually right about 91% of the time. This is safer for clinical use than overconfidence.'
            },
            'n-patients': {
                title: 'Total Patient Sample',
                value: '2,818 patients',
                icon: 'N',
                explanation: 'The crosswalk formula was derived from data representing 2,818 patients across 17 studies from multiple countries and treatment types.',
                interpretation: 'This large, diverse sample ensures the formula is robust and generalizable, not specific to any single population or institution.'
            },
            'n-datapoints': {
                title: 'Data Points',
                value: '83 matched pairs',
                icon: '#',
                explanation: 'Each data point is a matched VAI and MAGNIFI-CD score from the same patient cohort, allowing direct comparison between the two scoring systems.',
                interpretation: '83 data points from 17 studies provides sufficient statistical power while representing diverse clinical scenarios.'
            }
        };

        function initStatExplanations() {
            document.querySelectorAll('.stat-clickable').forEach(el => {
                el.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const statKey = this.dataset.stat;
                    if (statKey && STAT_EXPLANATIONS[statKey]) {
                        showStatModal(statKey);
                    }
                });
            });

            // Close modal on overlay click
            const overlay = document.getElementById('stat-modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', closeStatModal);
            }

            // Close on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeStatModal();
            });
        }

        function showStatModal(statKey) {
            const stat = STAT_EXPLANATIONS[statKey];
            if (!stat) return;

            document.getElementById('stat-modal-icon').textContent = stat.icon;
            document.getElementById('stat-modal-title').textContent = stat.title;
            document.getElementById('stat-modal-value').textContent = stat.value;
            document.getElementById('stat-modal-explanation').textContent = stat.explanation;
            document.getElementById('stat-modal-interpretation').textContent = stat.interpretation;

            document.getElementById('stat-modal-overlay').classList.add('show');
            document.getElementById('stat-modal').classList.add('show');
        }

        function closeStatModal() {
            document.getElementById('stat-modal-overlay').classList.remove('show');
            document.getElementById('stat-modal').classList.remove('show');
        }
    </script>

    <!-- Stat Explanation Modal -->
    <div class="stat-modal-overlay" id="stat-modal-overlay"></div>
    <div class="stat-modal" id="stat-modal">
        <button class="stat-modal-close" onclick="closeStatModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        <div class="stat-modal-header">
            <div class="stat-modal-icon" id="stat-modal-icon">RÂ²</div>
            <div>
                <div class="stat-modal-title" id="stat-modal-title">R-Squared</div>
                <div class="stat-modal-value" id="stat-modal-value">0.96</div>
            </div>
        </div>
        <div class="stat-modal-body">
            <div class="stat-modal-section">
                <div class="stat-modal-section-title">What it measures</div>
                <p id="stat-modal-explanation">R-squared measures how well the formula fits the data.</p>
            </div>
            <div class="stat-modal-highlight">
                <p id="stat-modal-interpretation"><strong>Interpretation:</strong> Above 0.9 is excellent.</p>
            </div>
        </div>
    </div>
</body>
</html>
