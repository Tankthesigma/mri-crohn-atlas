<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRI Report Parser | MRI-Crohn Atlas</title>
    <style>
        /* ============================================
           CLEAN MEDICAL DESIGN SYSTEM
           Matching index.html aesthetic
           ============================================ */

        :root {
            --primary: #0066CC;
            --primary-dark: #004C99;
            --primary-light: #E6F0FA;

            --success: #059669;
            --success-light: #D1FAE5;
            --warning: #D97706;
            --warning-light: #FEF3C7;
            --danger: #DC2626;
            --danger-light: #FEE2E2;
            --info: #0891B2;
            --info-light: #CFFAFE;

            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;

            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;

            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);

            --radius-sm: 4px;
            --radius: 6px;
            --radius-lg: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-sans);
            background: var(--gray-50);
            color: var(--gray-800);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        /* ============================================
           NAVIGATION
           ============================================ */

        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            border-bottom: 1px solid var(--gray-200);
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            height: 56px;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: var(--gray-900);
            font-weight: 600;
            font-size: 1rem;
        }

        .nav-logo-icon {
            width: 28px;
            height: 28px;
            background: var(--primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.75rem;
        }

        .nav-links {
            display: flex;
            gap: 0.25rem;
            list-style: none;
        }

        .nav-links a {
            color: var(--gray-600);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius);
            transition: all 0.15s ease;
        }

        .nav-links a:hover {
            color: var(--gray-900);
            background: var(--gray-100);
        }

        .nav-links a.active {
            color: var(--primary);
            background: var(--primary-light);
        }

        .nav-badge {
            background: var(--primary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.6875rem;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        /* ============================================
           HEADER
           ============================================ */

        .header {
            padding: 80px 1.5rem 24px;
            text-align: center;
            background: white;
            border-bottom: 1px solid var(--gray-200);
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 0.9375rem;
            color: var(--gray-600);
            max-width: 600px;
            margin: 0 auto 1.5rem;
        }

        .header-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-value {
            font-family: var(--font-mono);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        /* ============================================
           MAIN CONTAINER
           ============================================ */

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        /* ============================================
           PARSER LAYOUT - TWO COLUMN
           ============================================ */

        .parser-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .parser-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           CARDS
           ============================================ */

        .card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .card-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius);
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .card-title {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--gray-900);
        }

        /* ============================================
           TEXTAREA
           ============================================ */

        .textarea-label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .report-textarea {
            width: 100%;
            min-height: 240px;
            background: var(--gray-50);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            padding: 0.875rem;
            font-family: var(--font-sans);
            font-size: 0.875rem;
            color: var(--gray-800);
            resize: vertical;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .report-textarea::placeholder {
            color: var(--gray-400);
        }

        .report-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        /* ============================================
           EXAMPLE BUTTONS
           ============================================ */

        .example-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .example-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        .example-btn {
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-700);
        }

        .example-btn:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
            color: var(--gray-900);
        }

        /* ============================================
           PARSE BUTTON
           ============================================ */

        .parse-btn {
            width: 100%;
            padding: 0.75rem 1.25rem;
            background: var(--primary);
            border: none;
            border-radius: var(--radius);
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .parse-btn:hover {
            background: var(--primary-dark);
        }

        .parse-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================
           ERROR DISPLAY
           ============================================ */

        .parser-error {
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--danger-light);
            border: 1px solid rgba(220, 38, 38, 0.2);
            border-radius: var(--radius);
            color: var(--danger);
            font-size: 0.8125rem;
            display: none;
        }

        .parser-error.show {
            display: block;
        }

        .parser-error code {
            background: rgba(220, 38, 38, 0.1);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
        }

        /* ============================================
           RESULTS PANEL
           ============================================ */

        .results-panel {
            display: none;
        }

        .results-panel.show {
            display: block;
        }

        .placeholder {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--gray-400);
        }

        .placeholder svg {
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .placeholder p {
            font-size: 0.875rem;
        }

        /* ============================================
           SCORE DISPLAY
           ============================================ */

        .score-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .score-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 1rem;
            text-align: center;
        }

        .score-card.vai {
            border-top: 3px solid var(--primary);
        }

        .score-card.magnifi {
            border-top: 3px solid var(--info);
        }

        .score-label {
            font-size: 0.6875rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .score-value {
            font-family: var(--font-mono);
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }

        .score-card.vai .score-value {
            color: var(--primary);
        }

        .score-card.magnifi .score-value {
            color: var(--info);
        }

        .score-range {
            font-size: 0.6875rem;
            color: var(--gray-400);
        }

        .score-pi {
            font-family: var(--font-mono);
            font-size: 0.625rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        /* ============================================
           CONFIDENCE METER
           ============================================ */

        .confidence-box {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 0.875rem;
            margin-bottom: 1rem;
        }

        .confidence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .confidence-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .confidence-value {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }

        .confidence-value.high {
            background: var(--success-light);
            color: var(--success);
        }

        .confidence-value.medium {
            background: var(--warning-light);
            color: var(--warning);
        }

        .confidence-value.low {
            background: var(--danger-light);
            color: var(--danger);
        }

        .confidence-bar-track {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .confidence-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        .confidence-bar.high {
            background: var(--success);
        }

        .confidence-bar.medium {
            background: var(--warning);
        }

        .confidence-bar.low {
            background: var(--danger);
        }

        .confidence-breakdown {
            display: flex;
            gap: 1rem;
            font-size: 0.625rem;
            color: var(--gray-500);
        }

        .conf-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .conf-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .conf-dot.high { background: var(--success); }
        .conf-dot.medium { background: var(--warning); }
        .conf-dot.low { background: var(--danger); }

        /* ============================================
           INTERPRETATION BOX
           ============================================ */

        .interpretation-box {
            padding: 0.875rem 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .interpretation-box.healed {
            background: var(--info-light);
            border-color: var(--info);
        }

        .interpretation-box.mild {
            background: var(--success-light);
            border-color: var(--success);
        }

        .interpretation-box.moderate {
            background: var(--warning-light);
            border-color: var(--warning);
        }

        .interpretation-box.active {
            background: #FEE2E2;
            border-color: #F87171;
        }

        .interpretation-box.severe {
            background: var(--danger-light);
            border-color: var(--danger);
        }

        .interpretation-status {
            font-size: 0.9375rem;
            font-weight: 700;
            margin-bottom: 0.125rem;
        }

        .interpretation-box.healed .interpretation-status { color: var(--info); }
        .interpretation-box.mild .interpretation-status { color: var(--success); }
        .interpretation-box.moderate .interpretation-status { color: var(--warning); }
        .interpretation-box.active .interpretation-status { color: #EF4444; }
        .interpretation-box.severe .interpretation-status { color: var(--danger); }

        .interpretation-desc {
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        /* ============================================
           TREATMENT BADGES
           ============================================ */

        .treatment-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .treatment-badge {
            font-size: 0.625rem;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        /* ============================================
           EVIDENCE SECTION
           ============================================ */

        .section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .highlighted-text {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 0.875rem;
            font-size: 0.8125rem;
            line-height: 1.7;
            max-height: 140px;
            overflow-y: auto;
            margin-bottom: 0.5rem;
        }

        .highlight-legend {
            display: flex;
            gap: 0.625rem;
            flex-wrap: wrap;
            font-size: 0.625rem;
            margin-bottom: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--gray-600);
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }

        mark.evidence-highlight {
            background: transparent;
            padding: 0 2px;
        }

        /* ============================================
           FEATURES TABLE
           ============================================ */

        .features-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .features-table th {
            text-align: left;
            padding: 0.5rem 0.625rem;
            font-weight: 600;
            color: var(--gray-500);
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .features-table td {
            padding: 0.5rem 0.625rem;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
        }

        .features-table tr:last-child td {
            border-bottom: none;
        }

        .confidence-badge {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            border-radius: 8px;
            font-size: 0.5625rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .confidence-badge.high {
            background: var(--success-light);
            color: var(--success);
        }

        .confidence-badge.medium {
            background: var(--warning-light);
            color: var(--warning);
        }

        .confidence-badge.low {
            background: var(--danger-light);
            color: var(--danger);
        }

        .feature-evidence {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--gray-400);
            font-size: 0.6875rem;
        }

        /* ============================================
           VALIDATION SECTION
           ============================================ */

        .validation-section {
            padding: 3rem 0;
            background: white;
            border-top: 1px solid var(--gray-200);
            margin-top: 2rem;
        }

        .validation-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .validation-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .validation-header p {
            font-size: 0.875rem;
            color: var(--gray-600);
            max-width: 600px;
            margin: 0 auto;
        }

        /* ============================================
           STATS GRID
           ============================================ */

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 800px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
        }

        .stat-card .value {
            font-family: var(--font-mono);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .stat-card .label {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-top: 0.375rem;
        }

        .stat-card .detail {
            font-size: 0.625rem;
            color: var(--gray-400);
        }

        /* ============================================
           ICC COMPARISON GRID
           ============================================ */

        .icc-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 700px) {
            .icc-grid {
                grid-template-columns: 1fr;
            }
        }

        .icc-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 1.25rem;
        }

        .icc-card h4 {
            font-size: 0.6875rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: 0.75rem;
        }

        .icc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .icc-row:last-child {
            border-bottom: none;
        }

        .icc-label {
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .icc-values {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .icc-value {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: var(--radius-sm);
        }

        .icc-value.parser {
            background: var(--success-light);
            color: var(--success);
        }

        .icc-value.expert {
            background: var(--danger-light);
            color: var(--danger);
        }

        .exceeds-badge {
            background: var(--success-light);
            border: 1px solid rgba(5, 150, 105, 0.2);
            border-radius: var(--radius-sm);
            padding: 0.125rem 0.375rem;
            font-size: 0.5625rem;
            font-weight: 600;
            color: var(--success);
            text-transform: uppercase;
        }

        .icc-source {
            font-size: 0.625rem;
            color: var(--gray-400);
            margin-top: 0.5rem;
        }

        /* ============================================
           ERROR DISTRIBUTION
           ============================================ */

        .error-bars {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .error-bar-row {
            display: grid;
            grid-template-columns: 80px 1fr 60px;
            align-items: center;
            gap: 0.5rem;
        }

        .error-label {
            font-size: 0.6875rem;
            color: var(--gray-600);
            text-align: right;
        }

        .error-bar-track {
            height: 16px;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .error-bar-fill {
            height: 100%;
            border-radius: var(--radius-sm);
        }

        .error-count {
            font-family: var(--font-mono);
            font-size: 0.6875rem;
            color: var(--gray-500);
        }

        /* ============================================
           LIMITATIONS BOX
           ============================================ */

        .limitations-box {
            background: var(--warning-light);
            border: 1px solid rgba(217, 119, 6, 0.2);
            border-radius: var(--radius);
            padding: 1.25rem;
            max-width: 700px;
            margin: 2rem auto 0;
        }

        .limitations-box h4 {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--warning);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .limitations-box ul {
            margin: 0;
            padding-left: 1.25rem;
            font-size: 0.8125rem;
            color: var(--gray-700);
            line-height: 1.7;
        }

        .limitations-box li {
            margin-bottom: 0.25rem;
        }

        .limitations-box strong {
            color: var(--gray-800);
        }

        /* ============================================
           FOOTER
           ============================================ */

        footer {
            background: white;
            border-top: 1px solid var(--gray-200);
            padding: 1.5rem;
            text-align: center;
        }

        .footer-text {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .footer-text a {
            color: var(--primary);
            text-decoration: none;
        }

        .footer-text a:hover {
            text-decoration: underline;
        }

        /* ============================================
           HIGHLIGHT COLORS
           ============================================ */

        .hl-fistula_type { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
        .hl-fistula_count { border-color: #8b5cf6; background-color: rgba(139, 92, 246, 0.1); }
        .hl-t2_hyperintensity { border-color: #f97316; background-color: rgba(249, 115, 22, 0.1); }
        .hl-extension { border-color: #10b981; background-color: rgba(16, 185, 129, 0.1); }
        .hl-collections_abscesses { border-color: #ef4444; background-color: rgba(239, 68, 68, 0.1); }
        .hl-rectal_wall_involvement { border-color: #ec4899; background-color: rgba(236, 72, 153, 0.1); }
        .hl-inflammatory_mass { border-color: #f59e0b; background-color: rgba(245, 158, 11, 0.1); }
        .hl-predominant_feature { border-color: #06b6d4; background-color: rgba(6, 182, 212, 0.1); }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-inner">
            <a href="index.html" class="nav-logo">
                <div class="nav-logo-icon">M</div>
                <span>MRI-Crohn Atlas</span>
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Dashboard</a></li>
                <li><a href="index.html#crosswalk">Crosswalk</a></li>
                <li><a href="index.html#validation">Validation</a></li>
                <li><a href="parser.html" class="active">Parser</a></li>
            </ul>
            <div class="nav-badge">ISEF 2026</div>
        </div>
    </nav>

    <!-- Header -->
    <section class="header">
        <h1>MRI Report Parser</h1>
        <p>Paste any pelvic MRI report. AI extracts clinical features and calculates VAI + MAGNIFI-CD scores with full evidence traceability.</p>
        <div class="header-stats">
            <div class="header-stat">
                <div class="header-stat-value">100%</div>
                <div class="header-stat-label">Real-World Accuracy</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value">0.93</div>
                <div class="header-stat-label">VAI ICC</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value">0.94</div>
                <div class="header-stat-label">MAGNIFI ICC</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value">26</div>
                <div class="header-stat-label">Validated Cases</div>
            </div>
        </div>
    </section>

    <!-- Parser Tool -->
    <section class="container">
        <div class="parser-grid">
            <!-- Input Panel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                    </div>
                    <span class="card-title">Input Report</span>
                </div>

                <label class="textarea-label">Paste MRI Report Text</label>
                <textarea id="report-input" class="report-textarea" placeholder="Paste MRI report findings here...

Example format:
MRI pelvis demonstrates a transsphincteric fistula at the 6 o'clock position with marked T2 hyperintensity. The tract extends through the external sphincter into the ischioanal fossa..."></textarea>

                <div class="example-row">
                    <span class="example-label">Try example:</span>
                    <button class="example-btn" onclick="loadExample(0)">Severe + Abscess</button>
                    <button class="example-btn" onclick="loadExample(1)">Healing Fistula</button>
                    <button class="example-btn" onclick="loadExample(2)">Complex Crohn's</button>
                </div>

                <button id="parse-btn" class="parse-btn" onclick="parseReport()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    Parse Report
                </button>

                <div id="parser-error" class="parser-error"></div>
            </div>

            <!-- Results Panel -->
            <div class="card">
                <div id="results-panel" class="results-panel">
                    <div class="card-header">
                        <div class="card-icon" style="background: var(--success-light);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                        </div>
                        <span class="card-title">Analysis Results</span>
                    </div>

                    <!-- Score Cards -->
                    <div class="score-grid">
                        <div class="score-card vai">
                            <div class="score-label">Van Assche Index</div>
                            <div class="score-value" id="vai-score">--</div>
                            <div class="score-range">of 22</div>
                        </div>
                        <div class="score-card magnifi">
                            <div class="score-label">MAGNIFI-CD</div>
                            <div class="score-value" id="magnifi-score">--</div>
                            <div class="score-range">of 25</div>
                            <div class="score-pi" id="magnifi-pi">95% PI: -- - --</div>
                        </div>
                    </div>

                    <!-- Confidence -->
                    <div id="confidence-box" class="confidence-box" style="display: none;">
                        <div class="confidence-header">
                            <span class="confidence-label">Extraction Confidence</span>
                            <span class="confidence-value" id="overall-confidence">--</span>
                        </div>
                        <div class="confidence-bar-track">
                            <div class="confidence-bar" id="confidence-bar"></div>
                        </div>
                        <div class="confidence-breakdown" id="confidence-breakdown"></div>
                    </div>

                    <!-- Treatment Status -->
                    <div id="treatment-badges" class="treatment-badges" style="display: none;"></div>

                    <!-- Interpretation -->
                    <div id="interpretation-box" class="interpretation-box active">
                        <div class="interpretation-status" id="interpretation-status">--</div>
                        <div class="interpretation-desc" id="interpretation-desc">Parse a report to see clinical interpretation</div>
                    </div>

                    <!-- Evidence -->
                    <div class="evidence-section">
                        <div class="section-title">Evidence Traceability</div>
                        <div id="highlighted-text" class="highlighted-text"></div>
                        <div id="highlight-legend" class="highlight-legend"></div>
                    </div>

                    <!-- Features Table -->
                    <div class="features-section">
                        <div class="section-title">Extracted Features</div>
                        <table class="features-table">
                            <thead>
                                <tr>
                                    <th>Feature</th>
                                    <th>Value</th>
                                    <th>Confidence</th>
                                    <th>Evidence</th>
                                </tr>
                            </thead>
                            <tbody id="features-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Placeholder -->
                <div id="placeholder" class="placeholder">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    <p>Paste an MRI report and click "Parse Report" to see results</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Validation Section -->
    <section class="validation-section">
        <div class="container">
            <div class="validation-header">
                <h2>Parser Performance</h2>
                <p>Validated against 26 test cases including real-world Radiopaedia reports, pediatric cases, and challenging edge cases.</p>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="value">100%</div>
                    <div class="label">Real-World Accuracy</div>
                    <div class="detail">15/15 cases</div>
                </div>
                <div class="stat-card">
                    <div class="value">100%</div>
                    <div class="label">Radiopaedia</div>
                    <div class="detail">10/10 cases</div>
                </div>
                <div class="stat-card">
                    <div class="value">100%</div>
                    <div class="label">Pediatric Cases</div>
                    <div class="detail">3/3 cases</div>
                </div>
                <div class="stat-card">
                    <div class="value">100%</div>
                    <div class="label">Edge Cases</div>
                    <div class="detail">11/11 cases</div>
                </div>
            </div>

            <!-- ICC Comparison -->
            <div class="icc-grid">
                <div class="icc-card">
                    <h4>VAI Inter-rater Reliability</h4>
                    <div class="icc-row">
                        <span class="icc-label">MRI-Crohn Atlas Parser</span>
                        <span class="icc-value parser">0.934</span>
                    </div>
                    <div class="icc-row">
                        <span class="icc-label">Expert Radiologists</span>
                        <div class="icc-values">
                            <span class="icc-value expert">0.68</span>
                            <span class="exceeds-badge">+37% Better</span>
                        </div>
                    </div>
                    <div class="icc-source">Source: Hindryckx et al. 2017</div>
                </div>
                <div class="icc-card">
                    <h4>MAGNIFI-CD Inter-rater Reliability</h4>
                    <div class="icc-row">
                        <span class="icc-label">MRI-Crohn Atlas Parser</span>
                        <span class="icc-value parser">0.940</span>
                    </div>
                    <div class="icc-row">
                        <span class="icc-label">Expert Radiologists</span>
                        <div class="icc-values">
                            <span class="icc-value expert">0.87</span>
                            <span class="exceeds-badge">+8% Better</span>
                        </div>
                    </div>
                    <div class="icc-source">Source: Beek et al. 2024</div>
                </div>
            </div>

            <!-- MAE Stats -->
            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); max-width: 400px; margin: 0 auto 2rem;">
                <div class="stat-card">
                    <div class="value">0.93</div>
                    <div class="label">VAI MAE</div>
                    <div class="detail">Points on 0-22 scale</div>
                </div>
                <div class="stat-card">
                    <div class="value">0.73</div>
                    <div class="label">MAGNIFI MAE</div>
                    <div class="detail">Points on 0-25 scale</div>
                </div>
            </div>

            <!-- Error Distribution -->
            <h3 style="text-align: center; font-size: 1rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1rem;">Error Distribution (15 Real-World Cases)</h3>
            <div class="icc-grid">
                <div class="icc-card">
                    <h4>VAI Error Distribution</h4>
                    <div class="error-bars">
                        <div class="error-bar-row">
                            <span class="error-label">0 pts (exact)</span>
                            <div class="error-bar-track">
                                <div class="error-bar-fill" style="width: 60%; background: var(--success);"></div>
                            </div>
                            <span class="error-count">9 cases</span>
                        </div>
                        <div class="error-bar-row">
                            <span class="error-label">1 pt</span>
                            <div class="error-bar-track">
                                <div class="error-bar-fill" style="width: 20%; background: var(--info);"></div>
                            </div>
                            <span class="error-count">3 cases</span>
                        </div>
                        <div class="error-bar-row">
                            <span class="error-label">2 pts</span>
                            <div class="error-bar-track">
                                <div class="error-bar-fill" style="width: 6.7%; background: var(--warning);"></div>
                            </div>
                            <span class="error-count">1 case</span>
                        </div>
                        <div class="error-bar-row">
                            <span class="error-label">3 pts</span>
                            <div class="error-bar-track">
                                <div class="error-bar-fill" style="width: 13.3%; background: var(--danger);"></div>
                            </div>
                            <span class="error-count">2 cases</span>
                        </div>
                    </div>
                </div>
                <div class="icc-card">
                    <h4>MAGNIFI Error Distribution</h4>
                    <div class="error-bars">
                        <div class="error-bar-row">
                            <span class="error-label">0 pts (exact)</span>
                            <div class="error-bar-track">
                                <div class="error-bar-fill" style="width: 66.7%; background: var(--success);"></div>
                            </div>
                            <span class="error-count">10 cases</span>
                        </div>
                        <div class="error-bar-row">
                            <span class="error-label">1 pt</span>
                            <div class="error-bar-track">
                                <div class="error-bar-fill" style="width: 13.3%; background: var(--info);"></div>
                            </div>
                            <span class="error-count">2 cases</span>
                        </div>
                        <div class="error-bar-row">
                            <span class="error-label">2 pts</span>
                            <div class="error-bar-track">
                                <div class="error-bar-fill" style="width: 13.3%; background: var(--warning);"></div>
                            </div>
                            <span class="error-count">2 cases</span>
                        </div>
                        <div class="error-bar-row">
                            <span class="error-label">3 pts</span>
                            <div class="error-bar-track">
                                <div class="error-bar-fill" style="width: 6.7%; background: var(--danger);"></div>
                            </div>
                            <span class="error-count">1 case</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Known Limitations -->
            <div class="limitations-box">
                <h4>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Known Limitations
                </h4>
                <ul>
                    <li><strong>Healed cases:</strong> Formula predicts MAGNIFI ~3.3 for fully healed (VAI=0, Fibrosis=6), but some studies report MAGNIFI=0</li>
                    <li><strong>Complex multi-fistula with seton:</strong> T2 reduction may be overestimated when 3+ fistulas present</li>
                    <li><strong>Ambiguous reports:</strong> Parser correctly flags low confidence (&lt;50%) for vague or contradictory findings</li>
                    <li><strong>Confidence calibration:</strong> V4 is 24.8% underconfident (safer for clinical use)</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <p class="footer-text">
            MRI-Crohn Atlas | <a href="index.html">Back to Dashboard</a> | ISEF 2026
        </p>
    </footer>

    <!-- Load config (gitignored - contains API key) -->
    <script src="config.js" onerror="console.warn('config.js not found. Parser will show setup instructions.')"></script>

    <script>
        // Highlight colors for features
        const HIGHLIGHT_COLORS = {
            fistula_type: '#3b82f6',
            fistula_count: '#8b5cf6',
            t2_hyperintensity: '#f97316',
            extension: '#10b981',
            collections_abscesses: '#ef4444',
            rectal_wall_involvement: '#ec4899',
            inflammatory_mass: '#f59e0b',
            predominant_feature: '#06b6d4'
        };

        // Example reports
        const EXAMPLE_REPORTS = [
            {
                title: "Severe + Abscess",
                text: `MRI pelvis demonstrates a complex transsphincteric fistula originating at the 6 o'clock position of the anal canal. The tract shows marked T2 hyperintensity consistent with active inflammation. The fistula traverses both internal and external anal sphincters, extending into the left ischioanal fossa. A rim-enhancing fluid collection measuring 2.3 x 1.8 cm is identified in the left ischioanal fossa, consistent with abscess formation. The rectal wall shows focal thickening and enhancement at the level of the internal opening. No evidence of horseshoe extension.`
            },
            {
                title: "Healing Fistula",
                text: `Follow-up MRI of the pelvis for known perianal fistula. A single intersphincteric fistulous tract is identified at the 3 o'clock position. Compared to prior study, there is decreased T2 signal intensity within the tract, suggesting healing. The tract remains confined to the intersphincteric space without extension through the external sphincter. No abscess or fluid collection. The external anal sphincter appears intact. Findings consistent with fibrotic healing and treatment response.`
            },
            {
                title: "Complex Crohn's",
                text: `MRI demonstrates extensive perianal fistulizing disease in this patient with known Crohn's disease. Multiple fistulous tracts identified: (1) High transsphincteric fistula at 11 o'clock with horseshoe extension crossing posterior midline, (2) Intersphincteric fistula at 5 o'clock. Both tracts show marked T2 hyperintensity and avid post-contrast enhancement indicating active inflammation. Large inflammatory mass measuring 4.2 x 3.1 cm in the right ischioanal fossa with central necrosis. Moderate rectal wall thickening with mucosal hyperenhancement. Predominant inflammatory pattern without significant fibrosis.`
            }
        ];

        function loadExample(index) {
            document.getElementById('report-input').value = EXAMPLE_REPORTS[index].text;
        }

        // Get API key from config
        function getApiKey() {
            if (typeof window !== 'undefined' && window.CONFIG && window.CONFIG.OPENROUTER_API_KEY) {
                const key = window.CONFIG.OPENROUTER_API_KEY;
                if (key && key !== 'your-openrouter-api-key-here' && key.startsWith('sk-or-')) {
                    return key;
                }
            }
            return null;
        }

        async function parseReport() {
            const reportText = document.getElementById('report-input').value.trim();
            const parseBtn = document.getElementById('parse-btn');
            const errorDiv = document.getElementById('parser-error');
            const resultsPanel = document.getElementById('results-panel');
            const placeholder = document.getElementById('placeholder');

            // Check API key first
            const apiKey = getApiKey();
            if (!apiKey) {
                errorDiv.innerHTML = '<strong>API key not configured.</strong><br>To use the parser:<br>1. Copy <code>config.example.js</code> to <code>config.js</code><br>2. Add your OpenRouter API key<br>3. Refresh the page<br><br>See CLAUDE.md for detailed instructions.';
                errorDiv.classList.add('show');
                return;
            }

            if (!reportText || reportText.length < 50) {
                errorDiv.textContent = 'Please enter a valid MRI report (at least 50 characters).';
                errorDiv.classList.add('show');
                return;
            }

            parseBtn.disabled = true;
            parseBtn.innerHTML = '<div class="spinner"></div> Analyzing...';
            errorDiv.classList.remove('show');

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'MRI-Crohn Atlas Parser'
                    },
                    body: JSON.stringify({
                        model: 'deepseek/deepseek-chat',
                        messages: [{
                            role: 'user',
                            content: `You are an expert radiologist analyzing MRI findings for perianal fistulas.

Extract structured features from the following radiology report. AVOID OVERESTIMATING severity.

REPORT TEXT:
${reportText}

CRITICAL RULES:

=== TREATMENT AWARENESS ===
- "seton in place" / "seton placement" = ACTIVELY MANAGED disease (treatment_status = "seton_in_place")
- When seton present: T2 hyperintensity is EXPECTED, use "mild" unless explicitly "marked"

=== NEGATIVE FINDINGS ARE IMPORTANT ===
- "no abscess" / "no collection" = collections_abscesses = false
- "no wall thickening" = rectal_wall_involvement = false
- List these in negative_findings array

=== FISTULA COUNTING ===
- Primary tract + secondary tract from SAME origin = 1 fistula with branching, NOT 2 separate fistulas
- Only count as 2+ if they have SEPARATE internal openings at different clock positions

=== T2 HYPERINTENSITY (BE CONSERVATIVE) ===
- ONLY mark as TRUE if explicitly described: "hyperintense", "T2 bright", "high signal on T2"
- If report doesn't mention T2/signal intensity explicitly = null (unknown)

=== EXTENSION ===
- "moderate" = ischioanal fossa, typical transsphincteric (3-4cm tracts)
- "severe" = ONLY for supralevator, horseshoe pattern, extends to thigh/buttock

Return a JSON object with this EXACT structure:
{
    "features": {
        "fistula_count": { "value": <number or null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "fistula_type": { "value": <"intersphincteric"|"transsphincteric"|"suprasphincteric"|"extrasphincteric"|"complex"|"simple"|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "t2_hyperintensity": { "value": <true|false|null>, "degree": <"mild"|"moderate"|"marked"|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "extension": { "value": <"none"|"mild"|"moderate"|"severe"|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "collections_abscesses": { "value": <true|false|null>, "size": <"small"|"large"|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "rectal_wall_involvement": { "value": <true|false|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "inflammatory_mass": { "value": <true|false|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "predominant_feature": { "value": <"inflammatory"|"fibrotic"|"mixed"|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" }
    },
    "treatment_status": <"seton_in_place"|"post_surgical"|"on_medication"|"no_treatment"|"unknown">,
    "negative_findings": [<list of explicit negative statements>],
    "overall_assessment": { "activity": <"active"|"healing"|"healed"|"chronic">, "severity": <"mild"|"moderate"|"severe"> }
}

IMPORTANT: Use null if a feature is not mentioned. Return ONLY valid JSON.`
                        }],
                        temperature: 0.1,
                        max_tokens: 1500
                    })
                });

                if (!response.ok) throw new Error('API request failed');

                const data = await response.json();
                const content = data.choices?.[0]?.message?.content || '';
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('Failed to parse response');

                const parsed = JSON.parse(jsonMatch[0]);
                displayResults(reportText, parsed);
                placeholder.style.display = 'none';

            } catch (error) {
                console.error('Parse error:', error);
                errorDiv.textContent = 'Error parsing report: ' + error.message;
                errorDiv.classList.add('show');
            } finally {
                parseBtn.disabled = false;
                parseBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg> Parse Report`;
            }
        }

        function calculateVAI(features, treatmentStatus) {
            let score = 0;
            const hasSeton = treatmentStatus === 'seton_in_place';

            const count = features.fistula_count?.value;
            if (count === 1) score += 1;
            else if (count >= 2) score += 2;

            const type = features.fistula_type?.value;
            if (['simple', 'intersphincteric'].includes(type)) score += 1;
            else if (['transsphincteric', 'suprasphincteric', 'extrasphincteric', 'complex'].includes(type)) score += 2;

            const ext = features.extension?.value;
            if (ext === 'mild') score += 2;
            else if (ext === 'moderate') score += 3;
            else if (ext === 'severe') score += 4;

            if (features.t2_hyperintensity?.value === true) {
                const deg = features.t2_hyperintensity.degree;
                let t2Score = 6;
                if (deg === 'mild') t2Score = 4;
                else if (deg === 'moderate') t2Score = 6;
                else if (deg === 'marked') t2Score = 8;

                if (hasSeton) t2Score = Math.max(2, t2Score - 2);
                score += t2Score;
            }

            if (features.collections_abscesses?.value === true) score += 4;
            if (features.rectal_wall_involvement?.value === true) score += 2;

            return Math.min(score, 22);
        }

        function calculateMAGNIFI(features, treatmentStatus) {
            let score = 0;
            const hasSeton = treatmentStatus === 'seton_in_place';

            const count = features.fistula_count?.value;
            if (count === 1) score += 1;
            else if (count === 2) score += 3;
            else if (count >= 3) score += 5;

            if (features.t2_hyperintensity?.value === true) {
                const deg = features.t2_hyperintensity.degree;
                let t2Score = 4;
                if (deg === 'mild') t2Score = 2;
                else if (deg === 'moderate') t2Score = 4;
                else if (deg === 'marked') t2Score = 6;

                if (hasSeton) t2Score = Math.max(1, t2Score - 2);
                score += t2Score;
            }

            const ext = features.extension?.value;
            if (ext === 'mild') score += 1;
            else if (ext === 'moderate') score += 2;
            else if (ext === 'severe') score += 3;

            if (features.collections_abscesses?.value === true) {
                score += features.collections_abscesses.size === 'large' ? 4 : 2;
            }
            if (features.inflammatory_mass?.value === true) score += 4;
            if (features.rectal_wall_involvement?.value === true) score += 2;

            const pred = features.predominant_feature?.value;
            if (pred === 'inflammatory') {
                if (hasSeton && features.collections_abscesses?.value !== true) {
                    score += 2;
                } else {
                    score += 4;
                }
            } else if (pred === 'mixed') {
                score += 2;
            }

            return Math.min(score, 25);
        }

        function getInterpretation(vai, magnifi, treatmentStatus) {
            const hasSeton = treatmentStatus === 'seton_in_place';
            const treatmentNote = hasSeton ? ' Currently managed with seton.' : '';

            if (vai <= 2 && magnifi <= 4) {
                return { status: 'Healed/Remission', class: 'healed', desc: 'Fistula appears healed with minimal residual activity.' + treatmentNote };
            }
            if (vai <= 6 && magnifi <= 8) {
                return { status: 'Mild Active Disease', class: 'mild', desc: 'Mild active disease or partial response to treatment.' + treatmentNote };
            }
            if (vai <= 10 && magnifi <= 12) {
                return { status: 'Moderate Active Disease', class: 'moderate', desc: 'Moderate fistulizing disease. Continue current management.' + treatmentNote };
            }
            if (vai <= 16 && magnifi <= 18) {
                return { status: 'Active Disease', class: 'active', desc: 'Active fistulizing disease requiring close monitoring.' + treatmentNote };
            }
            return { status: 'Severe Active Disease', class: 'severe', desc: 'Severe active disease. Consider intervention escalation.' + treatmentNote };
        }

        function highlightEvidence(text, features) {
            let html = text;
            const highlights = [];

            for (const [key, feature] of Object.entries(features)) {
                if (feature?.evidence && feature.evidence.length > 5) {
                    highlights.push({ key, evidence: feature.evidence, color: HIGHLIGHT_COLORS[key] || '#888' });
                }
            }

            highlights.sort((a, b) => b.evidence.length - a.evidence.length);

            for (const h of highlights) {
                const escaped = h.evidence.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escaped})`, 'gi');
                html = html.replace(regex, `<mark class="evidence-highlight" style="background-color: ${h.color}20; border-bottom: 2px solid ${h.color};">$1</mark>`);
            }

            return { html, highlights };
        }

        function calculateOverallConfidence(features) {
            const weights = {
                fistula_count: 1.5, fistula_type: 1.5, t2_hyperintensity: 2.0,
                extension: 1.0, collections_abscesses: 1.5, rectal_wall_involvement: 1.0,
                inflammatory_mass: 1.0, predominant_feature: 1.0
            };
            const scores = { high: 1.0, medium: 0.6, low: 0.3 };

            let totalWeight = 0, weightedScore = 0;
            const breakdown = { high: 0, medium: 0, low: 0 };

            for (const [key, weight] of Object.entries(weights)) {
                const feature = features[key];
                if (feature && feature.value !== null && feature.value !== undefined) {
                    const conf = feature.confidence || 'low';
                    breakdown[conf]++;
                    weightedScore += weight * (scores[conf] || 0.3);
                    totalWeight += weight;
                }
            }

            const pct = totalWeight > 0 ? Math.round((weightedScore / totalWeight) * 100) : 0;
            let level = 'low';
            if (pct >= 75) level = 'high';
            else if (pct >= 50) level = 'medium';

            return { percentage: pct, level, breakdown };
        }

        function displayResults(reportText, parsed) {
            const features = parsed.features || {};
            const treatmentStatus = parsed.treatment_status || 'unknown';
            const negativeFindings = parsed.negative_findings || [];
            const resultsPanel = document.getElementById('results-panel');

            const vai = calculateVAI(features, treatmentStatus);
            const magnifi = calculateMAGNIFI(features, treatmentStatus);

            const crosswalkPredicted = (1.031 * vai + 1.713).toFixed(1);
            const rmse = 1.10;
            const piLower = Math.max(0, crosswalkPredicted - 1.96 * rmse).toFixed(1);
            const piUpper = (parseFloat(crosswalkPredicted) + 1.96 * rmse).toFixed(1);

            const interp = getInterpretation(vai, magnifi, treatmentStatus);
            const highlighted = highlightEvidence(reportText, features);

            document.getElementById('highlighted-text').innerHTML = highlighted.html;
            document.getElementById('highlight-legend').innerHTML = highlighted.highlights.map(h =>
                `<div class="legend-item"><div class="legend-dot" style="background-color: ${h.color};"></div><span>${h.key.replace(/_/g, ' ')}</span></div>`
            ).join('');

            document.getElementById('vai-score').textContent = vai;
            document.getElementById('magnifi-score').textContent = magnifi;
            document.getElementById('magnifi-pi').textContent = `95% PI: ${piLower} - ${piUpper}`;

            const interpBox = document.getElementById('interpretation-box');
            interpBox.className = 'interpretation-box ' + interp.class;
            document.getElementById('interpretation-status').textContent = interp.status;
            document.getElementById('interpretation-desc').textContent = interp.desc;

            // Treatment Status Display
            const treatmentBadges = document.getElementById('treatment-badges');
            if (treatmentStatus && treatmentStatus !== 'unknown') {
                treatmentBadges.style.display = 'flex';
                const treatmentLabels = {
                    'seton_in_place': 'Seton In Place',
                    'post_surgical': 'Post-Surgical',
                    'on_medication': 'On Medication',
                    'no_treatment': 'No Current Treatment'
                };
                let badgesHtml = `<span class="treatment-badge" style="background: var(--success-light); color: var(--success);">${treatmentLabels[treatmentStatus] || treatmentStatus}</span>`;
                if (negativeFindings.length > 0) {
                    badgesHtml += `<span class="treatment-badge" style="background: var(--primary-light); color: var(--primary);">${negativeFindings.join(', ')}</span>`;
                }
                treatmentBadges.innerHTML = badgesHtml;
            } else {
                treatmentBadges.style.display = 'none';
            }

            // Confidence
            const confResult = calculateOverallConfidence(features);
            const confBox = document.getElementById('confidence-box');
            confBox.style.display = 'block';
            document.getElementById('overall-confidence').textContent = confResult.percentage + '%';
            document.getElementById('overall-confidence').className = 'confidence-value ' + confResult.level;
            document.getElementById('confidence-bar').style.width = confResult.percentage + '%';
            document.getElementById('confidence-bar').className = 'confidence-bar ' + confResult.level;
            document.getElementById('confidence-breakdown').innerHTML = `
                <span class="conf-stat"><span class="conf-dot high"></span> High: ${confResult.breakdown.high}</span>
                <span class="conf-stat"><span class="conf-dot medium"></span> Medium: ${confResult.breakdown.medium}</span>
                <span class="conf-stat"><span class="conf-dot low"></span> Low: ${confResult.breakdown.low}</span>
            `;

            // Features table
            const tbody = document.getElementById('features-tbody');
            tbody.innerHTML = '';
            const labels = {
                fistula_count: 'Fistula Count', fistula_type: 'Fistula Type',
                t2_hyperintensity: 'T2 Hyperintensity', extension: 'Extension',
                collections_abscesses: 'Collections/Abscesses', rectal_wall_involvement: 'Rectal Wall',
                inflammatory_mass: 'Inflammatory Mass', predominant_feature: 'Predominant Feature'
            };

            for (const [key, label] of Object.entries(labels)) {
                const feature = features[key];
                if (!feature) continue;

                let value = feature.value;
                if (value === null || value === undefined) value = '';
                else if (typeof value === 'boolean') value = value ? 'Yes' : 'No';
                if (feature.degree) value += ` (${feature.degree})`;

                const conf = feature.confidence || 'low';
                const evidence = feature.evidence || '';

                tbody.innerHTML += `
                    <tr>
                        <td>${label}</td>
                        <td>${value}</td>
                        <td><span class="confidence-badge ${conf}">${conf}</span></td>
                        <td class="feature-evidence" title="${evidence}">${evidence.substring(0, 30)}${evidence.length > 30 ? '...' : ''}</td>
                    </tr>
                `;
            }

            resultsPanel.classList.add('show');
        }
    </script>
</body>
</html>
