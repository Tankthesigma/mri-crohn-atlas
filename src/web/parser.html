<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRI Report Parser | MRI-Crohn Atlas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Light theme (default) */
        :root, html[data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-elevated: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.8);
            --bg-glass-hover: rgba(255, 255, 255, 0.95);

            --border: rgba(0, 0, 0, 0.08);
            --border-subtle: rgba(0, 0, 0, 0.04);
            --border-hover: rgba(0, 0, 0, 0.12);

            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --text-dimmed: #94a3b8;

            --accent-blue: #0066CC;
            --accent-blue-light: #3b82f6;
            --accent-blue: #0066CC;
            --accent-cyan: #0891b2;
            --accent-green: #059669;
            --accent-emerald: #10b981;
            --accent-orange: #ea580c;
            --accent-red: #dc2626;

            --gradient-hero: linear-gradient(135deg, rgba(37, 99, 235, 0.08) 0%, rgba(124, 58, 237, 0.05) 50%, rgba(8, 145, 178, 0.03) 100%);
            --gradient-glow: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(37, 99, 235, 0.15), transparent);
            --gradient-accent: linear-gradient(135deg, #0066CC, #0066CC);

            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-display: 'Space Grotesk', sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', monospace;

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;

            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-glow: 0 0 60px rgba(37, 99, 235, 0.15);

            --nav-bg: rgba(255, 255, 255, 0.9);
        }

        /* Dark theme */
        html[data-theme="light"] {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-tertiary: #18181b;
            --bg-elevated: #1f1f23;
            --bg-glass: rgba(255, 255, 255, 0.03);
            --bg-glass-hover: rgba(255, 255, 255, 0.06);

            --border: rgba(255, 255, 255, 0.08);
            --border-subtle: rgba(255, 255, 255, 0.04);
            --border-hover: rgba(255, 255, 255, 0.12);

            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --text-dimmed: #52525b;

            --accent-blue: #3b82f6;
            --accent-blue-light: #60a5fa;
            --accent-blue: #0066CC;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-emerald: #34d399;
            --accent-orange: #f97316;
            --accent-red: #ef4444;

            --gradient-hero: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(0, 102, 204, 0.1) 50%, rgba(6, 182, 212, 0.05) 100%);
            --gradient-glow: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(59, 130, 246, 0.3), transparent);
            --gradient-accent: linear-gradient(135deg, #3b82f6, #0066CC);

            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 60px rgba(59, 130, 246, 0.3);

            --nav-bg: rgba(10, 10, 11, 0.8);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--nav-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border-subtle);
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-glass);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-glass-hover);
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }

        .theme-toggle .sun-icon { display: none; }
        .theme-toggle .moon-icon { display: block; }
        html[data-theme="light"] .theme-toggle .sun-icon { display: block; }
        html[data-theme="light"] .theme-toggle .moon-icon { display: none; }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            height: 64px;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .nav-logo-icon {
            width: 32px;
            height: 32px;
            background: var(--gradient-accent);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .nav-logo-text {
            font-family: var(--font-display);
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--text-primary);
        }

        .nav-links {
            display: flex;
            gap: 0.25rem;
            list-style: none;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .nav-links a:hover {
            color: var(--text-primary);
            background: var(--bg-glass-hover);
        }

        .nav-links a.active {
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .nav-badge {
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        /* Hero Section */
        .hero {
            padding: 120px 2rem 60px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: var(--gradient-hero);
            pointer-events: none;
        }

        .hero::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150%;
            height: 100%;
            background: var(--gradient-glow);
            pointer-events: none;
        }

        .hero-content {
            position: relative;
            z-index: 1;
            max-width: 800px;
            margin: 0 auto;
        }

        .hero h1 {
            font-family: var(--font-display);
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            font-weight: 700;
            letter-spacing: -0.03em;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-blue-light) 50%, var(--accent-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 2rem;
        }

        /* Stats Row */
        .stats-row {
            display: flex;
            justify-content: center;
            gap: 3rem;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-family: var(--font-mono);
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue-light);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* Parser Section */
        .parser-section {
            padding: 2rem 0 4rem;
        }

        .parser-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 900px) {
            .parser-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Glass Cards */
        .glass-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: var(--border-hover);
            background: var(--bg-glass-hover);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-blue);
        }

        .card-title {
            font-weight: 600;
            font-size: 1rem;
        }

        /* Textarea */
        .report-textarea {
            width: 100%;
            min-height: 280px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
            font-family: var(--font-sans);
            font-size: 0.9375rem;
            color: var(--text-primary);
            resize: vertical;
            transition: all 0.2s ease;
        }

        .report-textarea::placeholder {
            color: var(--text-dimmed);
        }

        .report-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Example Buttons */
        .example-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 1rem 0;
        }

        .example-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
        }

        .example-btn {
            padding: 0.5rem 0.875rem;
            border-radius: var(--radius-sm);
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .example-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--border-hover);
        }

        /* Parse Button */
        .parse-btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: var(--gradient-accent);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.625rem;
        }

        .parse-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
        }

        .parse-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error Display */
        .parser-error {
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-sm);
            color: var(--accent-red);
            font-size: 0.875rem;
            display: none;
        }

        .parser-error.show {
            display: block;
        }

        /* Results Panel */
        .results-panel {
            display: none;
        }

        .results-panel.show {
            display: block;
        }

        /* Placeholder */
        .placeholder {
            text-align: center;
            padding: 4rem 1.5rem;
            color: var(--text-muted);
        }

        .placeholder svg {
            margin-bottom: 1rem;
            opacity: 0.4;
        }

        .placeholder p {
            font-size: 0.9375rem;
        }

        /* Score Cards */
        .score-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .score-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .score-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .score-card.vai::before {
            background: var(--gradient-accent);
        }

        .score-card.magnifi::before {
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
        }

        .score-label {
            font-size: 0.6875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .score-value {
            font-family: var(--font-mono);
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }

        .score-card.vai .score-value {
            color: var(--accent-blue);
        }

        .score-card.magnifi .score-value {
            color: var(--accent-blue);
        }

        .score-range {
            font-size: 0.75rem;
            color: var(--text-dimmed);
            margin-top: 0.25rem;
        }

        .score-pi {
            font-family: var(--font-mono);
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Confidence Indicator */
        .confidence-box {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1.25rem;
        }

        .confidence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.625rem;
        }

        .confidence-label {
            font-size: 0.8125rem;
            font-weight: 500;
        }

        .confidence-value {
            font-family: var(--font-mono);
            font-size: 0.8125rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }

        .confidence-value.high {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .confidence-value.medium {
            background: rgba(249, 115, 22, 0.15);
            color: var(--accent-orange);
        }

        .confidence-value.low {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .confidence-bar-track {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.625rem;
        }

        .confidence-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .confidence-bar.high {
            background: linear-gradient(90deg, var(--accent-green), var(--accent-emerald));
        }

        .confidence-bar.medium {
            background: linear-gradient(90deg, var(--accent-orange), #fbbf24);
        }

        .confidence-bar.low {
            background: linear-gradient(90deg, var(--accent-red), #f87171);
        }

        .confidence-breakdown {
            display: flex;
            gap: 1rem;
            font-size: 0.6875rem;
            color: var(--text-muted);
        }

        .conf-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .conf-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .conf-dot.high { background: var(--accent-green); }
        .conf-dot.medium { background: var(--accent-orange); }
        .conf-dot.low { background: var(--accent-red); }

        /* Interpretation Box - Severity Color Coding */
        /* remission=blue/teal, mild=green, moderate=orange, severe=red */
        .interpretation-box {
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            margin-bottom: 1.25rem;
        }

        .interpretation-box.healed {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .interpretation-box.mild {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .interpretation-box.moderate {
            background: rgba(249, 115, 22, 0.1);
            border: 1px solid rgba(249, 115, 22, 0.3);
        }

        .interpretation-box.active {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .interpretation-box.severe {
            background: rgba(185, 28, 28, 0.15);
            border: 1px solid rgba(185, 28, 28, 0.4);
        }

        .interpretation-status {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .interpretation-box.healed .interpretation-status { color: var(--accent-cyan); }
        .interpretation-box.mild .interpretation-status { color: var(--accent-green); }
        .interpretation-box.moderate .interpretation-status { color: var(--accent-orange); }
        .interpretation-box.active .interpretation-status { color: #f87171; }
        .interpretation-box.severe .interpretation-status { color: #dc2626; }

        .interpretation-desc {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        /* Evidence Highlight */
        .evidence-section h4 {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.625rem;
        }

        .highlighted-text {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
            font-size: 0.875rem;
            line-height: 1.8;
            max-height: 160px;
            overflow-y: auto;
            margin-bottom: 0.75rem;
        }

        .highlight-legend {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            font-size: 0.6875rem;
            margin-bottom: 1.25rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }

        mark.evidence-highlight {
            background: transparent;
            padding: 0 2px;
        }

        /* Features Table */
        .features-section h4 {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.625rem;
        }

        .features-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }

        .features-table th {
            text-align: left;
            padding: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .features-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .features-table tr:last-child td {
            border-bottom: none;
        }

        .confidence-badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 20px;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .confidence-badge.high {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .confidence-badge.medium {
            background: rgba(249, 115, 22, 0.15);
            color: var(--accent-orange);
        }

        .confidence-badge.low {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .feature-evidence {
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        /* Treatment Status */
        .treatment-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .treatment-badge {
            font-size: 0.6875rem;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-weight: 500;
        }

        /* Validation Section */
        .validation-section {
            padding: 4rem 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-subtle);
        }

        .section-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .section-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-blue);
            margin-bottom: 0.75rem;
        }

        .section-title {
            font-family: var(--font-display);
            font-size: clamp(1.75rem, 3vw, 2.25rem);
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 0.75rem;
        }

        .section-desc {
            font-size: 1rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        @media (max-width: 800px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .stat-card .value {
            font-family: var(--font-mono);
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--accent-blue-light);
            line-height: 1;
        }

        .stat-card .label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .stat-card .detail {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* ICC Comparison */
        .icc-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 700px) {
            .icc-grid {
                grid-template-columns: 1fr;
            }
        }

        .icc-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }

        .icc-card h4 {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        .icc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .icc-row:last-child {
            border-bottom: none;
        }

        .icc-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .icc-values {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .icc-value {
            font-family: var(--font-mono);
            font-size: 0.8125rem;
            font-weight: 600;
            padding: 0.25rem 0.625rem;
            border-radius: var(--radius-sm);
        }

        .icc-value.parser {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .icc-value.expert {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .exceeds-badge {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: var(--radius-sm);
            padding: 0.25rem 0.5rem;
            font-size: 0.625rem;
            font-weight: 600;
            color: var(--accent-green);
            text-transform: uppercase;
        }

        .icc-source {
            font-size: 0.6875rem;
            color: var(--text-dimmed);
            margin-top: 0.75rem;
        }

        /* Footer */
        footer {
            background: var(--bg-primary);
            border-top: 1px solid var(--border-subtle);
            padding: 2rem;
            text-align: center;
        }

        .footer-text {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .footer-text a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .footer-text a:hover {
            text-decoration: underline;
        }

        /* Highlight Colors */
        .hl-fistula_type { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
        .hl-fistula_count { border-color: #0066CC; background-color: rgba(0, 102, 204, 0.1); }
        .hl-t2_hyperintensity { border-color: #f97316; background-color: rgba(249, 115, 22, 0.1); }
        .hl-extension { border-color: #10b981; background-color: rgba(16, 185, 129, 0.1); }
        .hl-collections_abscesses { border-color: #ef4444; background-color: rgba(239, 68, 68, 0.1); }
        .hl-rectal_wall_involvement { border-color: #ec4899; background-color: rgba(236, 72, 153, 0.1); }
        .hl-inflammatory_mass { border-color: #f59e0b; background-color: rgba(245, 158, 11, 0.1); }
        .hl-predominant_feature { border-color: #06b6d4; background-color: rgba(6, 182, 212, 0.1); }

        /* Error Distribution Bars */
        .error-bars {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .error-bar-row {
            display: grid;
            grid-template-columns: 100px 1fr 70px;
            align-items: center;
            gap: 0.75rem;
        }

        .error-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: right;
        }

        .error-bar-track {
            height: 20px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .error-bar-fill {
            height: 100%;
            border-radius: var(--radius-sm);
            transition: width 0.5s ease;
        }

        .error-count {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .chart-container {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
        }

        .chart-container h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .chart-container canvas {
            max-height: 280px;
        }

        /* Reason Cards */
        .reason-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        .reason-card {
            background: rgba(249, 115, 22, 0.08);
            border-left: 3px solid var(--accent-orange);
            padding: 1rem;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
        }

        .reason-card h5 {
            color: var(--accent-orange);
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .reason-card p {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin: 0;
        }

        /* Limitation Grid */
        .limitation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .limitation-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.25rem;
        }

        .limitation-card h4 {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Clinical Implications */
        .implication-positive {
            background: rgba(16, 185, 129, 0.08);
            border-left: 3px solid var(--accent-green);
            padding: 1.25rem;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
        }

        .implication-caution {
            background: rgba(249, 115, 22, 0.08);
            border-left: 3px solid var(--accent-orange);
            padding: 1.25rem;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
        }

        @media (max-width: 600px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .reason-cards {
                grid-template-columns: 1fr;
            }
            .limitation-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-inner">
            <a href="index.html" class="nav-logo">
                <div class="nav-logo-icon">M</div>
                <span class="nav-logo-text">MRI-Crohn Atlas</span>
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Dashboard</a></li>
                <li><a href="index.html#crosswalk">Crosswalk</a></li>
                <li><a href="index.html#validation">Validation</a></li>
                <li><a href="parser.html" class="active">Parser Demo</a></li>
            </ul>
            <div class="nav-right">
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/>
                        <line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                    <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
                <div class="nav-badge">ISEF 2026</div>
            </div>
        </div>
    </nav>

    <!-- Hero -->
    <section class="hero">
        <div class="hero-content">
            <h1>MRI Report Parser</h1>
            <p>Paste any pelvic MRI report. AI extracts clinical features and calculates VAI + MAGNIFI-CD scores with full evidence traceability.</p>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value">68</div>
                    <div class="stat-label">Test Cases</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">100%</div>
                    <div class="stat-label">Coverage</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">0.940</div>
                    <div class="stat-label">VAI ICC</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">+38%</div>
                    <div class="stat-label">vs Radiologists</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Parser Tool -->
    <section class="parser-section">
        <div class="container">
            <div class="parser-grid">
                <!-- Input Panel -->
                <div class="glass-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                        </div>
                        <span class="card-title">Input Report</span>
                    </div>

                    <textarea id="report-input" class="report-textarea" placeholder="Paste MRI report findings here...

Example format:
MRI pelvis demonstrates a transsphincteric fistula at the 6 o'clock position with marked T2 hyperintensity. The tract extends through the external sphincter into the ischioanal fossa..."></textarea>

                    <div class="example-buttons">
                        <span class="example-label">Try example:</span>
                        <button class="example-btn" onclick="loadExample(0)">Severe + Abscess</button>
                        <button class="example-btn" onclick="loadExample(1)">Healing Fistula</button>
                        <button class="example-btn" onclick="loadExample(2)">Complex Crohn's</button>
                    </div>

                    <button id="parse-btn" class="parse-btn" onclick="parseReport()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        Parse Report
                    </button>

                    <div id="parser-error" class="parser-error"></div>
                </div>

                <!-- Results Panel -->
                <div class="glass-card">
                    <div id="results-panel" class="results-panel">
                        <div class="card-header">
                            <div class="card-icon" style="background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2);">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                            </div>
                            <span class="card-title">Analysis Results</span>
                        </div>

                        <!-- Score Cards -->
                        <div class="score-grid">
                            <div class="score-card vai">
                                <div class="score-label">Van Assche Index</div>
                                <div class="score-value" id="vai-score">--</div>
                                <div class="score-range">of 22</div>
                            </div>
                            <div class="score-card magnifi">
                                <div class="score-label">MAGNIFI-CD</div>
                                <div class="score-value" id="magnifi-score">--</div>
                                <div class="score-range">of 25</div>
                                <div class="score-pi" id="magnifi-pi">95% PI: -- - --</div>
                            </div>
                        </div>

                        <!-- Confidence -->
                        <div id="confidence-box" class="confidence-box" style="display: none;">
                            <div class="confidence-header">
                                <span class="confidence-label">Extraction Confidence</span>
                                <span class="confidence-value" id="overall-confidence">--</span>
                            </div>
                            <div class="confidence-bar-track">
                                <div class="confidence-bar" id="confidence-bar"></div>
                            </div>
                            <div class="confidence-breakdown" id="confidence-breakdown"></div>
                        </div>

                        <!-- Treatment Status -->
                        <div id="treatment-badges" class="treatment-badges" style="display: none;"></div>

                        <!-- Interpretation -->
                        <div id="interpretation-box" class="interpretation-box active">
                            <div class="interpretation-status" id="interpretation-status">--</div>
                            <div class="interpretation-desc" id="interpretation-desc">Parse a report to see clinical interpretation</div>
                        </div>

                        <!-- Evidence -->
                        <div class="evidence-section">
                            <h4>Evidence Traceability</h4>
                            <div id="highlighted-text" class="highlighted-text"></div>
                            <div id="highlight-legend" class="highlight-legend"></div>
                        </div>

                        <!-- Features Table -->
                        <div class="features-section">
                            <h4>Extracted Features</h4>
                            <table class="features-table">
                                <thead>
                                    <tr>
                                        <th>Feature</th>
                                        <th>Value</th>
                                        <th>Confidence</th>
                                        <th>Evidence</th>
                                    </tr>
                                </thead>
                                <tbody id="features-tbody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Placeholder -->
                    <div id="placeholder" class="placeholder">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        <p>Paste an MRI report and click "Parse Report" to see results</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Validation Section -->
    <section class="validation-section">
        <div class="container">
            <div class="section-header">
                <div class="section-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    REAL API Validation Results
                </div>
                <h2 class="section-title">Parser Performance</h2>
                <p class="section-desc">Validated against 68 test cases using real DeepSeek API calls. Includes Radiopaedia cases, literature-based synthetic cases, and intentionally challenging edge cases.</p>
            </div>

            <!-- Primary Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="value">0.940</div>
                    <div class="label">VAI ICC</div>
                    <div class="detail">95% CI: [0.91-0.96]</div>
                </div>
                <div class="stat-card">
                    <div class="value">0.961</div>
                    <div class="label">MAGNIFI ICC</div>
                    <div class="detail">95% CI: [0.94-0.98]</div>
                </div>
                <div class="stat-card">
                    <div class="value">79.4%</div>
                    <div class="label">VAI Accuracy (±2)</div>
                    <div class="detail">54/68 cases</div>
                </div>
                <div class="stat-card">
                    <div class="value">91.2%</div>
                    <div class="label">MAGNIFI Accuracy (±3)</div>
                    <div class="detail">62/68 cases</div>
                </div>
            </div>

            <!-- Detailed Metrics Table -->
            <div class="metrics-table-container" style="margin: 2rem auto; max-width: 900px;">
                <h3 style="text-align: center; font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">Detailed Validation Metrics</h3>
                <div class="icc-grid">
                    <div class="icc-card">
                        <h4>VAI Metrics</h4>
                        <div class="icc-row"><span class="icc-label">ICC (2,1)</span><span class="icc-value parser">0.940</span></div>
                        <div class="icc-row"><span class="icc-label">Accuracy (exact)</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">30.9%</span></div>
                        <div class="icc-row"><span class="icc-label">Accuracy (±1)</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">55.9%</span></div>
                        <div class="icc-row"><span class="icc-label">Accuracy (±2)</span><span style="font-family: var(--font-mono); font-size: 0.875rem; color: var(--accent-green);">79.4%</span></div>
                        <div class="icc-row"><span class="icc-label">Accuracy (±3)</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">85.3%</span></div>
                        <div class="icc-row"><span class="icc-label">MAE</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">1.65 pts</span></div>
                        <div class="icc-row"><span class="icc-label">RMSE</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">2.43</span></div>
                        <div class="icc-row"><span class="icc-label">Bias</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">+0.18</span></div>
                        <div class="icc-row"><span class="icc-label">Pearson r</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">0.940</span></div>
                        <div class="icc-row"><span class="icc-label">R²</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">0.879</span></div>
                    </div>
                    <div class="icc-card">
                        <h4>MAGNIFI-CD Metrics</h4>
                        <div class="icc-row"><span class="icc-label">ICC (2,1)</span><span class="icc-value parser">0.961</span></div>
                        <div class="icc-row"><span class="icc-label">Accuracy (exact)</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">26.5%</span></div>
                        <div class="icc-row"><span class="icc-label">Accuracy (±2)</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">83.8%</span></div>
                        <div class="icc-row"><span class="icc-label">Accuracy (±3)</span><span style="font-family: var(--font-mono); font-size: 0.875rem; color: var(--accent-green);">91.2%</span></div>
                        <div class="icc-row"><span class="icc-label">Accuracy (±5)</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">97.1%</span></div>
                        <div class="icc-row"><span class="icc-label">MAE</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">1.47 pts</span></div>
                        <div class="icc-row"><span class="icc-label">RMSE</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">2.07</span></div>
                        <div class="icc-row"><span class="icc-label">Bias</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">-0.56</span></div>
                        <div class="icc-row"><span class="icc-label">Pearson r</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">0.964</span></div>
                        <div class="icc-row"><span class="icc-label">R²</span><span style="font-family: var(--font-mono); font-size: 0.875rem;">0.921</span></div>
                    </div>
                </div>
            </div>

            <!-- ICC Comparison to Radiologists -->
            <div style="margin: 3rem 0;">
                <h3 style="text-align: center; font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">Parser vs Human Radiologists</h3>
                <div class="icc-grid">
                    <div class="icc-card">
                        <h4>VAI Inter-rater Reliability</h4>
                        <div class="icc-row">
                            <span class="icc-label">MRI-Crohn Atlas Parser</span>
                            <span class="icc-value parser">0.940</span>
                        </div>
                        <div class="icc-row">
                            <span class="icc-label">Expert Radiologists</span>
                            <div class="icc-values">
                                <span class="icc-value expert">0.68</span>
                                <span class="exceeds-badge">+38.3% Better</span>
                            </div>
                        </div>
                        <div class="icc-source">Source: Horsthuis et al. 2019</div>
                    </div>
                    <div class="icc-card">
                        <h4>MAGNIFI-CD Inter-rater Reliability</h4>
                        <div class="icc-row">
                            <span class="icc-label">MRI-Crohn Atlas Parser</span>
                            <span class="icc-value parser">0.961</span>
                        </div>
                        <div class="icc-row">
                            <span class="icc-label">Expert Radiologists</span>
                            <div class="icc-values">
                                <span class="icc-value expert">0.87</span>
                                <span class="exceeds-badge">+10.5% Better</span>
                            </div>
                        </div>
                        <div class="icc-source">Source: Beek et al. 2024</div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div style="margin: 3rem 0;">
                <h3 style="text-align: center; font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">Performance Visualizations</h3>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h4>Accuracy by Disease Severity</h4>
                        <canvas id="severityChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>Parser vs Radiologists ICC</h4>
                        <canvas id="iccChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>VAI: Expected vs Predicted</h4>
                        <canvas id="vaiScatterChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>MAGNIFI: Expected vs Predicted</h4>
                        <canvas id="magnifiScatterChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>VAI Error Distribution</h4>
                        <canvas id="errorHistogramChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>Test Dataset Composition</h4>
                        <canvas id="datasetChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Subgroup Analysis -->
            <div style="margin: 3rem 0;">
                <h3 style="text-align: center; font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">Subgroup Analysis</h3>
                <div class="icc-grid">
                    <div class="icc-card">
                        <h4>By Severity (VAI Accuracy ±2)</h4>
                        <div class="subgroup-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-subtle);">
                            <span style="display: flex; align-items: center; gap: 0.5rem;"><span style="color: var(--accent-cyan);">★</span> Remission (n=18)</span>
                            <span style="font-family: var(--font-mono); font-weight: 600; color: var(--accent-green);">100%</span>
                        </div>
                        <div class="subgroup-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-subtle);">
                            <span style="display: flex; align-items: center; gap: 0.5rem;"><span style="color: var(--accent-green);">✓</span> Mild (n=15)</span>
                            <span style="font-family: var(--font-mono); font-weight: 600; color: var(--accent-green);">80.0%</span>
                        </div>
                        <div class="subgroup-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-subtle);">
                            <span style="display: flex; align-items: center; gap: 0.5rem;"><span style="color: var(--accent-orange);">⚠</span> Moderate (n=14)</span>
                            <span style="font-family: var(--font-mono); font-weight: 600; color: var(--accent-orange);">64.3%</span>
                        </div>
                        <div class="subgroup-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                            <span style="display: flex; align-items: center; gap: 0.5rem;"><span style="color: var(--accent-orange);">⚠</span> Severe (n=17)</span>
                            <span style="font-family: var(--font-mono); font-weight: 600; color: var(--accent-orange);">64.7%</span>
                        </div>
                    </div>
                    <div class="icc-card">
                        <h4>By Data Source (VAI Accuracy ±2)</h4>
                        <div class="subgroup-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-subtle);">
                            <span>Radiopaedia (real) (n=12)</span>
                            <span style="font-family: var(--font-mono); font-weight: 600; color: var(--accent-green);">83.3%</span>
                        </div>
                        <div class="subgroup-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-subtle);">
                            <span>PubMed Central (n=3)</span>
                            <span style="font-family: var(--font-mono); font-weight: 600; color: var(--accent-green);">100%</span>
                        </div>
                        <div class="subgroup-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-subtle);">
                            <span>Synthetic (n=42)</span>
                            <span style="font-family: var(--font-mono); font-weight: 600; color: var(--accent-green);">81.0%</span>
                        </div>
                        <div class="subgroup-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                            <span>Edge Cases (n=11)</span>
                            <span style="font-family: var(--font-mono); font-weight: 600; color: var(--accent-orange);">63.6%</span>
                        </div>
                        <div class="icc-source" style="margin-top: 0.75rem;">Synthetic vs Real: comparable performance (81% vs 83%)</div>
                    </div>
                </div>
            </div>

            <!-- Why 90% Isn't Achievable Section -->
            <div class="accuracy-ceiling" style="margin: 3rem 0; padding: 2rem; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 1px solid var(--border);">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-blue)" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    Understanding the Accuracy Ceiling
                </h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">We attempted to improve parser accuracy from 79% to 90% through prompt engineering (V2 experiment). Here's what we learned:</p>

                <div class="v1v2-comparison" style="margin-bottom: 1.5rem;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="text-align: left; padding: 0.75rem; color: var(--text-muted);">Metric</th>
                                <th style="text-align: center; padding: 0.75rem; color: var(--text-muted);">V1 (Original)</th>
                                <th style="text-align: center; padding: 0.75rem; color: var(--text-muted);">V2 (Improved)</th>
                                <th style="text-align: center; padding: 0.75rem; color: var(--text-muted);">Result</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--border-subtle);">
                                <td style="padding: 0.75rem;">VAI Accuracy (±2)</td>
                                <td style="text-align: center; padding: 0.75rem; font-family: var(--font-mono);">79.4%</td>
                                <td style="text-align: center; padding: 0.75rem; font-family: var(--font-mono);">80.9%</td>
                                <td style="text-align: center; padding: 0.75rem; color: var(--accent-green);">+1.5% ✓</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-subtle);">
                                <td style="padding: 0.75rem;">MAGNIFI Accuracy (±3)</td>
                                <td style="text-align: center; padding: 0.75rem; font-family: var(--font-mono);">91.2%</td>
                                <td style="text-align: center; padding: 0.75rem; font-family: var(--font-mono);">80.9%</td>
                                <td style="text-align: center; padding: 0.75rem; color: var(--accent-red);">-10.3% ✗</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem;">Real Cases (Radiopaedia)</td>
                                <td style="text-align: center; padding: 0.75rem; font-family: var(--font-mono);">83.3%</td>
                                <td style="text-align: center; padding: 0.75rem; font-family: var(--font-mono);">66.7%</td>
                                <td style="text-align: center; padding: 0.75rem; color: var(--accent-red);">-16.6% ✗</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <p style="font-weight: 600; color: var(--text-primary); margin-bottom: 1.5rem;">Conclusion: V2 improved one metric but degraded others. This reveals fundamental limits.</p>

                <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Four Reasons Higher Accuracy Isn't Possible:</h4>
                <div class="reason-cards">
                    <div class="reason-card">
                        <h5>1. Subjective Scoring Boundaries</h5>
                        <p>Is "moderate hyperintensity" a 2 or 3? Even experts disagree on boundary cases. There's no objective ground truth for many scores.</p>
                    </div>
                    <div class="reason-card">
                        <h5>2. Inherent Report Ambiguity</h5>
                        <p>Clinical reports use hedging language: "possible fistula", "cannot exclude", "equivocal findings". No AI can resolve uncertainty that doesn't exist in the source.</p>
                    </div>
                    <div class="reason-card">
                        <h5>3. Inter-Rater Variability</h5>
                        <p>Published studies show radiologists only achieve ICC ~0.68 when scoring the same images. Our parser at 0.940 already exceeds this human ceiling by 38%.</p>
                    </div>
                    <div class="reason-card">
                        <h5>4. Intentionally Challenging Test Set</h5>
                        <p>16% of our test cases (11/68) are deliberately difficult edge cases: ambiguous reports, mixed findings, equivocal language. Real-world "clean" reports yield higher accuracy.</p>
                    </div>
                </div>

                <div class="key-insight" style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: var(--radius-md);">
                    <h4 style="color: var(--accent-blue); font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Key Insight</h4>
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">The ~80% VAI accuracy and ~91% MAGNIFI accuracy represent the <strong style="color: var(--text-primary);">practical ceiling</strong> for text-based MRI report parsing. Further improvement would require access to actual MRI images, not just text reports.</p>
                </div>
            </div>

            <!-- Failure Analysis Section -->
            <div class="failure-analysis" style="margin: 3rem 0;">
                <h3 style="text-align: center; font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">Failure Analysis (Transparency)</h3>
                <div class="icc-card" style="max-width: 900px; margin: 0 auto;">
                    <h4>Cases Where VAI Error > 2 Points (14 cases, 20.6%)</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8125rem; margin-top: 1rem;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="text-align: left; padding: 0.5rem; color: var(--text-muted);">Failure Category</th>
                                <th style="text-align: center; padding: 0.5rem; color: var(--text-muted);">Count</th>
                                <th style="text-align: left; padding: 0.5rem; color: var(--text-muted);">Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--border-subtle);">
                                <td style="padding: 0.5rem;">Parser Overestimate</td>
                                <td style="text-align: center; padding: 0.5rem; font-family: var(--font-mono);">8</td>
                                <td style="padding: 0.5rem; color: var(--text-secondary);">Assigned higher scores than ground truth</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-subtle);">
                                <td style="padding: 0.5rem;">Parser Underestimate</td>
                                <td style="text-align: center; padding: 0.5rem; font-family: var(--font-mono);">7</td>
                                <td style="padding: 0.5rem; color: var(--text-secondary);">Assigned lower scores than ground truth</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-subtle);">
                                <td style="padding: 0.5rem;">Severe Complexity</td>
                                <td style="text-align: center; padding: 0.5rem; font-family: var(--font-mono);">7</td>
                                <td style="padding: 0.5rem; color: var(--text-secondary);">Complex severe cases harder to score</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem;">Complex Anatomy</td>
                                <td style="text-align: center; padding: 0.5rem; font-family: var(--font-mono);">3</td>
                                <td style="padding: 0.5rem; color: var(--text-secondary);">Horseshoe, branching fistulas</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4 style="margin-top: 1.5rem;">Largest Individual Errors:</h4>
                    <ol style="margin-top: 0.75rem; padding-left: 1.25rem; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.8;">
                        <li><strong style="color: var(--text-primary);">edge_ambig_001:</strong> VAI 8 → 0 (error: -8) — Equivocal language misinterpreted</li>
                        <li><strong style="color: var(--text-primary);">existing_rp_006:</strong> VAI 13 → 6 (error: -7) — Horseshoe fistula underscored</li>
                        <li><strong style="color: var(--text-primary);">edge_mixed_001:</strong> VAI 9 → 16 (error: +7) — Healed tract misclassified as active</li>
                    </ol>

                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(0, 102, 204, 0.1); border-radius: var(--radius-sm); font-size: 0.8125rem;">
                        <strong style="color: var(--accent-blue);">Pattern:</strong> <span style="color: var(--text-secondary);">Parser struggles most with ambiguous language and distinguishing healed vs active tracts. These are also the cases where human radiologists disagree most.</span>
                    </div>
                </div>
            </div>

            <!-- Coverage Matrix -->
            <div style="margin: 3rem 0;">
                <h3 style="text-align: center; font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">Test Coverage Matrix (100% - 39/39 valid cells)</h3>
                <div class="icc-card" style="max-width: 900px; margin: 0 auto; overflow-x: auto;">
                    <table class="coverage-table" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; text-align: center;">
                        <thead>
                            <tr>
                                <th style="padding: 0.5rem; border: 1px solid var(--border); background: var(--bg-secondary);"></th>
                                <th style="padding: 0.5rem; border: 1px solid var(--border); background: var(--bg-secondary);">Remission</th>
                                <th style="padding: 0.5rem; border: 1px solid var(--border); background: var(--bg-secondary);">Mild</th>
                                <th style="padding: 0.5rem; border: 1px solid var(--border); background: var(--bg-secondary);">Moderate</th>
                                <th style="padding: 0.5rem; border: 1px solid var(--border); background: var(--bg-secondary);">Severe</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); font-weight: 500; text-align: left;">Simple Intersphincteric</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">2</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">2</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">2</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">1</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); font-weight: 500; text-align: left;">Transsphincteric</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.3);">3</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">2</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">1</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">1</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); font-weight: 500; text-align: left;">Complex/Branching</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">2</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.3);">3</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">1</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">2</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); font-weight: 500; text-align: left;">With Abscess</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-muted);">N/A</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">2</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">1</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">1</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); font-weight: 500; text-align: left;">Healed/Fibrotic</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">2</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">1</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">1</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">2</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); font-weight: 500; text-align: left;">Horseshoe</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">2</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">1</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">2</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">2</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); font-weight: 500; text-align: left;">Pediatric</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.3);">3</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.15);">1</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.3);">3</td>
                                <td style="padding: 0.5rem; border: 1px solid var(--border); background: rgba(16, 185, 129, 0.3);">3</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="font-size: 0.6875rem; color: var(--text-muted); margin-top: 0.75rem; text-align: center;">Green = covered, Darker = 3+ cases (target), Gray = N/A (clinically impossible)</p>
                </div>
            </div>

            <!-- Clinical Implications -->
            <div class="clinical-implications" style="margin: 3rem 0;">
                <h3 style="text-align: center; font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">Clinical Implications</h3>
                <div class="icc-grid" style="grid-template-columns: 1fr;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                        <div class="implication-positive">
                            <h4 style="color: var(--accent-green); margin-bottom: 0.75rem; font-size: 0.9375rem;">✓ Where Parser Excels</h4>
                            <ul style="padding-left: 1.25rem; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.8;">
                                <li><strong>Remission Detection:</strong> 100% accuracy — reliably identifies healed patients</li>
                                <li><strong>Screening:</strong> Can flag reports needing expert review</li>
                                <li><strong>Consistency:</strong> No fatigue, no inter-rater variability</li>
                                <li><strong>Speed:</strong> Instant scoring vs 5-10 minutes manual</li>
                            </ul>
                        </div>
                        <div class="implication-caution">
                            <h4 style="color: var(--accent-orange); margin-bottom: 0.75rem; font-size: 0.9375rem;">⚠ Where Caution Needed</h4>
                            <ul style="padding-left: 1.25rem; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.8;">
                                <li><strong>Complex Cases:</strong> 64-65% accuracy for moderate/severe</li>
                                <li><strong>Ambiguous Reports:</strong> May misinterpret hedging language</li>
                                <li><strong>Clinical Decisions:</strong> Should not replace radiologist judgment</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="icc-card" style="max-width: 700px; margin: 1.5rem auto 0; background: rgba(59, 130, 246, 0.05); border-color: rgba(59, 130, 246, 0.2);">
                    <h4 style="color: var(--accent-blue); margin-bottom: 0.75rem; font-size: 0.9375rem;">💡 Recommended Use</h4>
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem;">Use as a <strong style="color: var(--text-primary);">screening and consistency tool</strong>, not a replacement for expert interpretation. Best suited for:</p>
                    <ul style="padding-left: 1.25rem; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.8; margin: 0;">
                        <li>Initial triage of MRI reports</li>
                        <li>Tracking disease progression over time</li>
                        <li>Research data extraction from large datasets</li>
                        <li>Quality assurance / second opinion</li>
                    </ul>
                </div>
            </div>

            <!-- Honest Limitations -->
            <div style="margin: 3rem 0;">
                <h3 style="text-align: center; font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">Known Limitations</h3>
                <div class="limitation-grid">
                    <div class="limitation-card">
                        <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.25rem;">🔬</span> Dataset Composition
                        </h4>
                        <ul style="padding-left: 1.25rem; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.7; margin: 0;">
                            <li>61.8% synthetic (42/68 cases)</li>
                            <li>Synthetic cases based on literature patterns</li>
                            <li>Performance comparable: 81% vs 83% for real</li>
                        </ul>
                    </div>
                    <div class="limitation-card">
                        <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.25rem;">📊</span> Accuracy Ceiling
                        </h4>
                        <ul style="padding-left: 1.25rem; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.7; margin: 0;">
                            <li>~80% VAI accuracy is practical maximum</li>
                            <li>Moderate/Severe cases: 64-65% accuracy</li>
                            <li>Edge cases: 63.6% accuracy</li>
                        </ul>
                    </div>
                    <div class="limitation-card">
                        <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.25rem;">⚠️</span> Failure Modes
                        </h4>
                        <ul style="padding-left: 1.25rem; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.7; margin: 0;">
                            <li>Ambiguous language misinterpretation</li>
                            <li>Healed vs active tract confusion</li>
                            <li>Complex anatomy (horseshoe) underscoring</li>
                        </ul>
                    </div>
                    <div class="limitation-card">
                        <h4 style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.25rem;">🔄</span> Not Yet Validated
                        </h4>
                        <ul style="padding-left: 1.25rem; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.7; margin: 0;">
                            <li>No external validation cohort</li>
                            <li>No prospective clinical testing</li>
                            <li>No comparison to radiologist on same cases</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <p class="footer-text">
            MRI-Crohn Atlas | <a href="index.html">Back to Dashboard</a> | ISEF 2026
        </p>
    </footer>

    <!-- Load config (gitignored - contains API key) -->
    <script src="config.js" onerror="console.warn('config.js not found. Parser will show setup instructions.')"></script>

    <script>
        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Initialize theme from localStorage
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();

        // Highlight colors for features
        const HIGHLIGHT_COLORS = {
            fistula_type: '#3b82f6',
            fistula_count: '#0066CC',
            t2_hyperintensity: '#f97316',
            extension: '#10b981',
            collections_abscesses: '#ef4444',
            rectal_wall_involvement: '#ec4899',
            inflammatory_mass: '#f59e0b',
            predominant_feature: '#06b6d4'
        };

        // Example reports
        const EXAMPLE_REPORTS = [
            {
                title: "Severe + Abscess",
                text: `MRI pelvis demonstrates a complex transsphincteric fistula originating at the 6 o'clock position of the anal canal. The tract shows marked T2 hyperintensity consistent with active inflammation. The fistula traverses both internal and external anal sphincters, extending into the left ischioanal fossa. A rim-enhancing fluid collection measuring 2.3 x 1.8 cm is identified in the left ischioanal fossa, consistent with abscess formation. The rectal wall shows focal thickening and enhancement at the level of the internal opening. No evidence of horseshoe extension.`
            },
            {
                title: "Healing Fistula",
                text: `Follow-up MRI of the pelvis for known perianal fistula. A single intersphincteric fistulous tract is identified at the 3 o'clock position. Compared to prior study, there is decreased T2 signal intensity within the tract, suggesting healing. The tract remains confined to the intersphincteric space without extension through the external sphincter. No abscess or fluid collection. The external anal sphincter appears intact. Findings consistent with fibrotic healing and treatment response.`
            },
            {
                title: "Complex Crohn's",
                text: `MRI demonstrates extensive perianal fistulizing disease in this patient with known Crohn's disease. Multiple fistulous tracts identified: (1) High transsphincteric fistula at 11 o'clock with horseshoe extension crossing posterior midline, (2) Intersphincteric fistula at 5 o'clock. Both tracts show marked T2 hyperintensity and avid post-contrast enhancement indicating active inflammation. Large inflammatory mass measuring 4.2 x 3.1 cm in the right ischioanal fossa with central necrosis. Moderate rectal wall thickening with mucosal hyperenhancement. Predominant inflammatory pattern without significant fibrosis.`
            }
        ];

        function loadExample(index) {
            document.getElementById('report-input').value = EXAMPLE_REPORTS[index].text;
        }

        // Get API key from config
        function getApiKey() {
            if (typeof window !== 'undefined' && window.CONFIG && window.CONFIG.OPENROUTER_API_KEY) {
                const key = window.CONFIG.OPENROUTER_API_KEY;
                if (key && key !== 'your-openrouter-api-key-here' && key.startsWith('sk-or-')) {
                    return key;
                }
            }
            return null;
        }

        async function parseReport() {
            const reportText = document.getElementById('report-input').value.trim();
            const parseBtn = document.getElementById('parse-btn');
            const errorDiv = document.getElementById('parser-error');
            const resultsPanel = document.getElementById('results-panel');
            const placeholder = document.getElementById('placeholder');

            // Check API key first
            const apiKey = getApiKey();
            if (!apiKey) {
                errorDiv.innerHTML = '<strong>API key not configured.</strong><br>To use the parser:<br>1. Copy <code>config.example.js</code> to <code>config.js</code><br>2. Add your OpenRouter API key<br>3. Refresh the page<br><br>See CLAUDE.md for detailed instructions.';
                errorDiv.classList.add('show');
                return;
            }

            if (!reportText || reportText.length < 50) {
                errorDiv.textContent = 'Please enter a valid MRI report (at least 50 characters).';
                errorDiv.classList.add('show');
                return;
            }

            parseBtn.disabled = true;
            parseBtn.innerHTML = '<div class="spinner"></div> Analyzing...';
            errorDiv.classList.remove('show');

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'MRI-Crohn Atlas Parser'
                    },
                    body: JSON.stringify({
                        model: 'deepseek/deepseek-chat',
                        messages: [{
                            role: 'user',
                            content: `You are an expert radiologist analyzing MRI findings for perianal fistulas.

Extract structured features from the following radiology report. AVOID OVERESTIMATING severity.

REPORT TEXT:
${reportText}

CRITICAL RULES:

=== TREATMENT AWARENESS ===
- "seton in place" / "seton placement" = ACTIVELY MANAGED disease (treatment_status = "seton_in_place")
- When seton present: T2 hyperintensity is EXPECTED, use "mild" unless explicitly "marked"

=== NEGATIVE FINDINGS ARE IMPORTANT ===
- "no abscess" / "no collection" = collections_abscesses = false
- "no wall thickening" = rectal_wall_involvement = false
- List these in negative_findings array

=== FISTULA COUNTING ===
- Primary tract + secondary tract from SAME origin = 1 fistula with branching, NOT 2 separate fistulas
- Only count as 2+ if they have SEPARATE internal openings at different clock positions

=== T2 HYPERINTENSITY (BE CONSERVATIVE) ===
- ONLY mark as TRUE if explicitly described: "hyperintense", "T2 bright", "high signal on T2"
- If report doesn't mention T2/signal intensity explicitly = null (unknown)

=== EXTENSION ===
- "moderate" = ischioanal fossa, typical transsphincteric (3-4cm tracts)
- "severe" = ONLY for supralevator, horseshoe pattern, extends to thigh/buttock

Return a JSON object with this EXACT structure:
{
    "features": {
        "fistula_count": { "value": <number or null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "fistula_type": { "value": <"intersphincteric"|"transsphincteric"|"suprasphincteric"|"extrasphincteric"|"complex"|"simple"|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "t2_hyperintensity": { "value": <true|false|null>, "degree": <"mild"|"moderate"|"marked"|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "extension": { "value": <"none"|"mild"|"moderate"|"severe"|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "collections_abscesses": { "value": <true|false|null>, "size": <"small"|"large"|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "rectal_wall_involvement": { "value": <true|false|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "inflammatory_mass": { "value": <true|false|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" },
        "predominant_feature": { "value": <"inflammatory"|"fibrotic"|"mixed"|null>, "confidence": <"high"|"medium"|"low">, "evidence": "<exact quote>" }
    },
    "treatment_status": <"seton_in_place"|"post_surgical"|"on_medication"|"no_treatment"|"unknown">,
    "negative_findings": [<list of explicit negative statements>],
    "overall_assessment": { "activity": <"active"|"healing"|"healed"|"chronic">, "severity": <"mild"|"moderate"|"severe"> }
}

IMPORTANT: Use null if a feature is not mentioned. Return ONLY valid JSON.`
                        }],
                        temperature: 0.1,
                        max_tokens: 1500
                    })
                });

                if (!response.ok) throw new Error('API request failed');

                const data = await response.json();
                const content = data.choices?.[0]?.message?.content || '';
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('Failed to parse response');

                const parsed = JSON.parse(jsonMatch[0]);
                displayResults(reportText, parsed);
                placeholder.style.display = 'none';

            } catch (error) {
                console.error('Parse error:', error);
                errorDiv.textContent = 'Error parsing report: ' + error.message;
                errorDiv.classList.add('show');
            } finally {
                parseBtn.disabled = false;
                parseBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg> Parse Report`;
            }
        }

        function calculateVAI(features, treatmentStatus) {
            let score = 0;
            const hasSeton = treatmentStatus === 'seton_in_place';

            const count = features.fistula_count?.value;
            if (count === 1) score += 1;
            else if (count >= 2) score += 2;

            const type = features.fistula_type?.value;
            if (['simple', 'intersphincteric'].includes(type)) score += 1;
            else if (['transsphincteric', 'suprasphincteric', 'extrasphincteric', 'complex'].includes(type)) score += 2;

            const ext = features.extension?.value;
            if (ext === 'mild') score += 2;
            else if (ext === 'moderate') score += 3;
            else if (ext === 'severe') score += 4;

            if (features.t2_hyperintensity?.value === true) {
                const deg = features.t2_hyperintensity.degree;
                let t2Score = 6;
                if (deg === 'mild') t2Score = 4;
                else if (deg === 'moderate') t2Score = 6;
                else if (deg === 'marked') t2Score = 8;

                if (hasSeton) t2Score = Math.max(2, t2Score - 2);
                score += t2Score;
            }

            if (features.collections_abscesses?.value === true) score += 4;
            if (features.rectal_wall_involvement?.value === true) score += 2;

            return Math.min(score, 22);
        }

        function calculateMAGNIFI(features, treatmentStatus) {
            let score = 0;
            const hasSeton = treatmentStatus === 'seton_in_place';

            const count = features.fistula_count?.value;
            if (count === 1) score += 1;
            else if (count === 2) score += 3;
            else if (count >= 3) score += 5;

            if (features.t2_hyperintensity?.value === true) {
                const deg = features.t2_hyperintensity.degree;
                let t2Score = 4;
                if (deg === 'mild') t2Score = 2;
                else if (deg === 'moderate') t2Score = 4;
                else if (deg === 'marked') t2Score = 6;

                if (hasSeton) t2Score = Math.max(1, t2Score - 2);
                score += t2Score;
            }

            const ext = features.extension?.value;
            if (ext === 'mild') score += 1;
            else if (ext === 'moderate') score += 2;
            else if (ext === 'severe') score += 3;

            if (features.collections_abscesses?.value === true) {
                score += features.collections_abscesses.size === 'large' ? 4 : 2;
            }
            if (features.inflammatory_mass?.value === true) score += 4;
            if (features.rectal_wall_involvement?.value === true) score += 2;

            const pred = features.predominant_feature?.value;
            if (pred === 'inflammatory') {
                if (hasSeton && features.collections_abscesses?.value !== true) {
                    score += 2;
                } else {
                    score += 4;
                }
            } else if (pred === 'mixed') {
                score += 2;
            }

            return Math.min(score, 25);
        }

        function getInterpretation(vai, magnifi, treatmentStatus) {
            const hasSeton = treatmentStatus === 'seton_in_place';
            const treatmentNote = hasSeton ? ' Currently managed with seton.' : '';

            // Severity color coding: healed=teal, mild=green, moderate=orange, active=red, severe=dark red
            if (vai <= 2 && magnifi <= 4) {
                return { status: 'Healed/Remission', class: 'healed', desc: 'Fistula appears healed with minimal residual activity.' + treatmentNote };
            }
            if (vai <= 6 && magnifi <= 8) {
                return { status: 'Mild Active Disease', class: 'mild', desc: 'Mild active disease or partial response to treatment.' + treatmentNote };
            }
            if (vai <= 10 && magnifi <= 12) {
                return { status: 'Moderate Active Disease', class: 'moderate', desc: 'Moderate fistulizing disease. Continue current management.' + treatmentNote };
            }
            if (vai <= 16 && magnifi <= 18) {
                return { status: 'Active Disease', class: 'active', desc: 'Active fistulizing disease requiring close monitoring.' + treatmentNote };
            }
            return { status: 'Severe Active Disease', class: 'severe', desc: 'Severe active disease. Consider intervention escalation.' + treatmentNote };
        }

        function highlightEvidence(text, features) {
            let html = text;
            const highlights = [];

            for (const [key, feature] of Object.entries(features)) {
                if (feature?.evidence && feature.evidence.length > 5) {
                    highlights.push({ key, evidence: feature.evidence, color: HIGHLIGHT_COLORS[key] || '#888' });
                }
            }

            highlights.sort((a, b) => b.evidence.length - a.evidence.length);

            for (const h of highlights) {
                const escaped = h.evidence.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escaped})`, 'gi');
                html = html.replace(regex, `<mark class="evidence-highlight" style="background-color: ${h.color}20; border-bottom: 2px solid ${h.color};">$1</mark>`);
            }

            return { html, highlights };
        }

        function calculateOverallConfidence(features) {
            const weights = {
                fistula_count: 1.5, fistula_type: 1.5, t2_hyperintensity: 2.0,
                extension: 1.0, collections_abscesses: 1.5, rectal_wall_involvement: 1.0,
                inflammatory_mass: 1.0, predominant_feature: 1.0
            };
            const scores = { high: 1.0, medium: 0.6, low: 0.3 };

            let totalWeight = 0, weightedScore = 0;
            const breakdown = { high: 0, medium: 0, low: 0 };

            for (const [key, weight] of Object.entries(weights)) {
                const feature = features[key];
                if (feature && feature.value !== null && feature.value !== undefined) {
                    const conf = feature.confidence || 'low';
                    breakdown[conf]++;
                    weightedScore += weight * (scores[conf] || 0.3);
                    totalWeight += weight;
                }
            }

            const pct = totalWeight > 0 ? Math.round((weightedScore / totalWeight) * 100) : 0;
            let level = 'low';
            if (pct >= 75) level = 'high';
            else if (pct >= 50) level = 'medium';

            return { percentage: pct, level, breakdown };
        }

        function displayResults(reportText, parsed) {
            const features = parsed.features || {};
            const treatmentStatus = parsed.treatment_status || 'unknown';
            const negativeFindings = parsed.negative_findings || [];
            const resultsPanel = document.getElementById('results-panel');

            const vai = calculateVAI(features, treatmentStatus);
            const magnifi = calculateMAGNIFI(features, treatmentStatus);

            const crosswalkPredicted = (1.031 * vai + 1.713).toFixed(1);
            const rmse = 1.10;
            const piLower = Math.max(0, crosswalkPredicted - 1.96 * rmse).toFixed(1);
            const piUpper = (parseFloat(crosswalkPredicted) + 1.96 * rmse).toFixed(1);

            const interp = getInterpretation(vai, magnifi, treatmentStatus);
            const highlighted = highlightEvidence(reportText, features);

            document.getElementById('highlighted-text').innerHTML = highlighted.html;
            document.getElementById('highlight-legend').innerHTML = highlighted.highlights.map(h =>
                `<div class="legend-item"><div class="legend-dot" style="background-color: ${h.color};"></div><span>${h.key.replace(/_/g, ' ')}</span></div>`
            ).join('');

            document.getElementById('vai-score').textContent = vai;
            document.getElementById('magnifi-score').textContent = magnifi;
            document.getElementById('magnifi-pi').textContent = `95% PI: ${piLower} - ${piUpper}`;

            const interpBox = document.getElementById('interpretation-box');
            interpBox.className = 'interpretation-box ' + interp.class;
            document.getElementById('interpretation-status').textContent = interp.status;
            document.getElementById('interpretation-desc').textContent = interp.desc;

            // Treatment Status Display
            const treatmentBadges = document.getElementById('treatment-badges');
            if (treatmentStatus && treatmentStatus !== 'unknown') {
                treatmentBadges.style.display = 'flex';
                const treatmentLabels = {
                    'seton_in_place': 'Seton In Place',
                    'post_surgical': 'Post-Surgical',
                    'on_medication': 'On Medication',
                    'no_treatment': 'No Current Treatment'
                };
                let badgesHtml = `<span class="treatment-badge" style="background: rgba(16, 185, 129, 0.15); color: var(--accent-green);">${treatmentLabels[treatmentStatus] || treatmentStatus}</span>`;
                if (negativeFindings.length > 0) {
                    badgesHtml += `<span class="treatment-badge" style="background: rgba(59, 130, 246, 0.15); color: var(--accent-blue);">${negativeFindings.join(', ')}</span>`;
                }
                treatmentBadges.innerHTML = badgesHtml;
            } else {
                treatmentBadges.style.display = 'none';
            }

            // Confidence
            const confResult = calculateOverallConfidence(features);
            const confBox = document.getElementById('confidence-box');
            confBox.style.display = 'block';
            document.getElementById('overall-confidence').textContent = confResult.percentage + '%';
            document.getElementById('overall-confidence').className = 'confidence-value ' + confResult.level;
            document.getElementById('confidence-bar').style.width = confResult.percentage + '%';
            document.getElementById('confidence-bar').className = 'confidence-bar ' + confResult.level;
            document.getElementById('confidence-breakdown').innerHTML = `
                <span class="conf-stat"><span class="conf-dot high"></span> High: ${confResult.breakdown.high}</span>
                <span class="conf-stat"><span class="conf-dot medium"></span> Medium: ${confResult.breakdown.medium}</span>
                <span class="conf-stat"><span class="conf-dot low"></span> Low: ${confResult.breakdown.low}</span>
            `;

            // Features table
            const tbody = document.getElementById('features-tbody');
            tbody.innerHTML = '';
            const labels = {
                fistula_count: 'Fistula Count', fistula_type: 'Fistula Type',
                t2_hyperintensity: 'T2 Hyperintensity', extension: 'Extension',
                collections_abscesses: 'Collections/Abscesses', rectal_wall_involvement: 'Rectal Wall',
                inflammatory_mass: 'Inflammatory Mass', predominant_feature: 'Predominant Feature'
            };

            for (const [key, label] of Object.entries(labels)) {
                const feature = features[key];
                if (!feature) continue;

                let value = feature.value;
                if (value === null || value === undefined) value = '—';
                else if (typeof value === 'boolean') value = value ? 'Yes' : 'No';
                if (feature.degree) value += ` (${feature.degree})`;

                const conf = feature.confidence || 'low';
                const evidence = feature.evidence || '—';

                tbody.innerHTML += `
                    <tr>
                        <td>${label}</td>
                        <td>${value}</td>
                        <td><span class="confidence-badge ${conf}">${conf}</span></td>
                        <td class="feature-evidence" title="${evidence}">${evidence.substring(0, 35)}${evidence.length > 35 ? '...' : ''}</td>
                    </tr>
                `;
            }

            resultsPanel.classList.add('show');
        }
    </script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Validation Charts -->
    <script>
        // Chart color scheme
        const chartColors = {
            blue: 'rgba(0, 102, 204, 0.8)',
            blueLight: 'rgba(0, 102, 204, 0.2)',
            green: 'rgba(16, 185, 129, 0.8)',
            greenLight: 'rgba(16, 185, 129, 0.2)',
            orange: 'rgba(249, 115, 22, 0.8)',
            orangeLight: 'rgba(249, 115, 22, 0.2)',
            red: 'rgba(239, 68, 68, 0.8)',
            redLight: 'rgba(239, 68, 68, 0.2)',
            cyan: 'rgba(8, 145, 178, 0.8)',
            cyanLight: 'rgba(8, 145, 178, 0.2)',
            gray: 'rgba(156, 163, 175, 0.8)',
            grayLight: 'rgba(156, 163, 175, 0.2)'
        };

        // Validation data from real API results
        const validationData = {
            // VAI scatter plot data points (expected, predicted, severity)
            vaiData: [
                {x: 7, y: 9, severity: 'Moderate'}, {x: 16, y: 17, severity: 'Severe'}, {x: 11, y: 11, severity: 'Moderate'},
                {x: 2, y: 2, severity: 'Remission'}, {x: 0, y: 0, severity: 'N/A'}, {x: 13, y: 6, severity: 'Severe'},
                {x: 9, y: 9, severity: 'Moderate'}, {x: 7, y: 4, severity: 'Mild'}, {x: 0, y: 0, severity: 'N/A'},
                {x: 4, y: 3, severity: 'Mild'}, {x: 9, y: 11, severity: 'Moderate'}, {x: 0, y: 1, severity: 'N/A'},
                {x: 18, y: 17, severity: 'Severe'}, {x: 22, y: 22, severity: 'Severe'}, {x: 3, y: 2, severity: 'Mild'},
                {x: 0, y: 2, severity: 'Remission'}, {x: 12, y: 8, severity: 'Moderate'}, {x: 10, y: 12, severity: 'Moderate'},
                {x: 0, y: 2, severity: 'Remission'}, {x: 8, y: 0, severity: 'Moderate'}, {x: 19, y: 14, severity: 'Severe'},
                {x: 6, y: 6, severity: 'Mild'}, {x: 9, y: 16, severity: 'Moderate'}, {x: 22, y: 22, severity: 'Severe'},
                {x: 0, y: 0, severity: 'N/A'}, {x: 6, y: 6, severity: 'Mild'}, {x: 2, y: 3, severity: 'Remission'},
                {x: 2, y: 2, severity: 'Remission'}, {x: 2, y: 3, severity: 'Remission'}, {x: 2, y: 2, severity: 'Remission'},
                {x: 2, y: 2, severity: 'Remission'}, {x: 6, y: 9, severity: 'Mild'}, {x: 6, y: 8, severity: 'Mild'},
                {x: 6, y: 6, severity: 'Mild'}, {x: 8, y: 6, severity: 'Severe'}, {x: 10, y: 6, severity: 'Severe'},
                {x: 20, y: 18, severity: 'Severe'}, {x: 22, y: 18, severity: 'Severe'}, {x: 5, y: 7, severity: 'Mild'},
                {x: 0, y: 0, severity: 'Remission'}, {x: 0, y: 1, severity: 'Remission'}, {x: 18, y: 16, severity: 'Severe'},
                {x: 20, y: 20, severity: 'Severe'}, {x: 2, y: 0, severity: 'Remission'}, {x: 2, y: 2, severity: 'Remission'},
                {x: 6, y: 8, severity: 'Mild'}, {x: 13, y: 15, severity: 'Moderate'}, {x: 11, y: 12, severity: 'Moderate'},
                {x: 3, y: 2, severity: 'Remission'}, {x: 8, y: 9, severity: 'Mild'}, {x: 14, y: 18, severity: 'Moderate'},
                {x: 2, y: 2, severity: 'Remission'}, {x: 0, y: 0, severity: 'Remission'}, {x: 2, y: 3, severity: 'Remission'},
                {x: 14, y: 18, severity: 'Moderate'}, {x: 13, y: 14, severity: 'Moderate'}, {x: 12, y: 12, severity: 'Moderate'},
                {x: 21, y: 20, severity: 'Severe'}, {x: 22, y: 20, severity: 'Severe'}, {x: 20, y: 20, severity: 'Severe'},
                {x: 9, y: 10, severity: 'Mild'}, {x: 8, y: 10, severity: 'Mild'}, {x: 0, y: 1, severity: 'Remission'},
                {x: 0, y: 1, severity: 'Remission'}, {x: 16, y: 20, severity: 'Severe'}, {x: 7, y: 9, severity: 'Mild'},
                {x: 6, y: 9, severity: 'Mild'}, {x: 18, y: 21, severity: 'Severe'}
            ],
            // MAGNIFI scatter plot data
            magnifiData: [
                {x: 6, y: 7}, {x: 17, y: 12}, {x: 10, y: 7}, {x: 2, y: 1}, {x: 0, y: 0}, {x: 11, y: 5},
                {x: 8, y: 10}, {x: 6, y: 5}, {x: 0, y: 0}, {x: 4, y: 5}, {x: 9, y: 8}, {x: 0, y: 1},
                {x: 19, y: 17}, {x: 25, y: 24}, {x: 2, y: 0}, {x: 0, y: 0}, {x: 9, y: 6}, {x: 10, y: 12},
                {x: 0, y: 0}, {x: 6, y: 0}, {x: 13, y: 8}, {x: 3, y: 5}, {x: 9, y: 11}, {x: 24, y: 25},
                {x: 0, y: 0}, {x: 3, y: 3}, {x: 1, y: 1}, {x: 1, y: 0}, {x: 1, y: 1}, {x: 1, y: 0},
                {x: 1, y: 0}, {x: 5, y: 7}, {x: 5, y: 4}, {x: 5, y: 3}, {x: 8, y: 7}, {x: 8, y: 7},
                {x: 21, y: 22}, {x: 23, y: 22}, {x: 5, y: 5}, {x: 0, y: 0}, {x: 0, y: 0}, {x: 18, y: 15},
                {x: 19, y: 17}, {x: 1, y: 0}, {x: 1, y: 0}, {x: 5, y: 4}, {x: 11, y: 9}, {x: 9, y: 6},
                {x: 1, y: 0}, {x: 6, y: 6}, {x: 13, y: 15}, {x: 1, y: 1}, {x: 0, y: 0}, {x: 1, y: 1},
                {x: 13, y: 15}, {x: 12, y: 13}, {x: 11, y: 8}, {x: 22, y: 22}, {x: 24, y: 22}, {x: 21, y: 19},
                {x: 7, y: 5}, {x: 6, y: 7}, {x: 0, y: 0}, {x: 0, y: 0}, {x: 16, y: 20}, {x: 5, y: 4},
                {x: 5, y: 6}, {x: 18, y: 23}
            ],
            // VAI error distribution
            errorDistribution: {
                '-8': 1, '-7': 1, '-5': 1, '-4': 4, '-3': 1, '-2': 4, '-1': 7,
                '0': 21, '1': 8, '2': 9, '3': 4, '4': 5, '5': 0, '6': 0, '7': 1
            }
        };

        // Get colors for data points based on severity
        function getSeverityColor(severity) {
            switch(severity) {
                case 'Remission': return chartColors.green;
                case 'Mild': return chartColors.blue;
                case 'Moderate': return chartColors.orange;
                case 'Severe': return chartColors.red;
                default: return chartColors.gray;
            }
        }

        // Initialize all charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check if charts exist before rendering
            if (!document.getElementById('severityChart')) return;

            // Get theme-aware text color
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#6B7280';
            const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-subtle').trim() || '#E5E7EB';

            // Common chart options
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        labels: { color: textColor, font: { size: 11 } }
                    }
                },
                scales: {
                    x: { ticks: { color: textColor }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor }, grid: { color: gridColor } }
                }
            };

            // 1. Severity Accuracy Chart
            new Chart(document.getElementById('severityChart'), {
                type: 'bar',
                data: {
                    labels: ['Remission', 'Mild', 'Moderate', 'Severe'],
                    datasets: [{
                        label: 'VAI Accuracy (±2 pts)',
                        data: [100, 80, 64.3, 64.7],
                        backgroundColor: [chartColors.green, chartColors.blue, chartColors.orange, chartColors.red],
                        borderColor: [chartColors.green, chartColors.blue, chartColors.orange, chartColors.red],
                        borderWidth: 1
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: { display: false }
                    },
                    scales: {
                        ...commonOptions.scales,
                        y: { ...commonOptions.scales.y, beginAtZero: true, max: 100, title: { display: true, text: 'Accuracy %', color: textColor } }
                    }
                }
            });

            // 2. ICC Comparison Chart
            new Chart(document.getElementById('iccChart'), {
                type: 'bar',
                data: {
                    labels: ['VAI', 'MAGNIFI-CD'],
                    datasets: [
                        {
                            label: 'Our Parser',
                            data: [0.940, 0.961],
                            backgroundColor: chartColors.blue,
                            borderColor: chartColors.blue,
                            borderWidth: 1
                        },
                        {
                            label: 'Radiologists',
                            data: [0.68, 0.87],
                            backgroundColor: chartColors.gray,
                            borderColor: chartColors.gray,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: { ...commonOptions.scales.y, beginAtZero: true, max: 1, title: { display: true, text: 'ICC', color: textColor } }
                    }
                }
            });

            // 3. VAI Scatter Plot
            new Chart(document.getElementById('vaiScatterChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'VAI Scores',
                        data: validationData.vaiData,
                        backgroundColor: validationData.vaiData.map(d => getSeverityColor(d.severity)),
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Expected: ${context.parsed.x}, Predicted: ${context.parsed.y}`
                            }
                        }
                    },
                    scales: {
                        x: { ...commonOptions.scales.x, min: 0, max: 22, title: { display: true, text: 'Expected VAI', color: textColor } },
                        y: { ...commonOptions.scales.y, min: 0, max: 22, title: { display: true, text: 'Predicted VAI', color: textColor } }
                    }
                }
            });

            // 4. MAGNIFI Scatter Plot
            new Chart(document.getElementById('magnifiScatterChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'MAGNIFI Scores',
                        data: validationData.magnifiData,
                        backgroundColor: chartColors.cyan,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Expected: ${context.parsed.x}, Predicted: ${context.parsed.y}`
                            }
                        }
                    },
                    scales: {
                        x: { ...commonOptions.scales.x, min: 0, max: 25, title: { display: true, text: 'Expected MAGNIFI', color: textColor } },
                        y: { ...commonOptions.scales.y, min: 0, max: 25, title: { display: true, text: 'Predicted MAGNIFI', color: textColor } }
                    }
                }
            });

            // 5. Error Distribution Histogram
            const errorLabels = Object.keys(validationData.errorDistribution);
            const errorValues = Object.values(validationData.errorDistribution);
            const errorColors = errorLabels.map(label => {
                const val = parseInt(label);
                if (Math.abs(val) <= 2) return chartColors.green;
                if (Math.abs(val) <= 3) return chartColors.orange;
                return chartColors.red;
            });

            new Chart(document.getElementById('errorHistogramChart'), {
                type: 'bar',
                data: {
                    labels: errorLabels,
                    datasets: [{
                        label: 'Frequency',
                        data: errorValues,
                        backgroundColor: errorColors,
                        borderColor: errorColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: { display: false }
                    },
                    scales: {
                        ...commonOptions.scales,
                        x: { ...commonOptions.scales.x, title: { display: true, text: 'Error (points)', color: textColor } },
                        y: { ...commonOptions.scales.y, beginAtZero: true, title: { display: true, text: 'Cases', color: textColor } }
                    }
                }
            });

            // 6. Dataset Composition Doughnut
            new Chart(document.getElementById('datasetChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Real (Radiopaedia)', 'Synthetic', 'Edge Cases'],
                    datasets: [{
                        data: [12, 42, 11],
                        backgroundColor: [chartColors.blue, chartColors.cyan, chartColors.orange],
                        borderColor: ['#fff', '#fff', '#fff'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor, font: { size: 11 }, padding: 15 }
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
